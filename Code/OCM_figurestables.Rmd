---
title: "OCM_figurestables"
author: "Elizabeth Chase"
date: "9/22/2020"
header-includes:
  - \usepackage{lscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
output: pdf_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(collapse=TRUE, fig.align='center', tidy=TRUE, tidy.opts=list(blank=TRUE, width.cutoff=40), warning=FALSE,message=FALSE)

rm(list=ls())

library(tidyverse)
library(gridExtra)
library(RColorBrewer)
library(tableone)
library(latex2exp)
library(labelled)
library(kableExtra)
library(survival)
library(survey)
library(randomForestSRC)
library(flexsurv)
library(pec)
library(timeROC)
library(cmprsk)

#We read in the final version of the NHANES data, saved at the end of OCM_modelbuilding.Rmd:
load("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nhanes_data_clean.RData")

#We read in the clean version of the PLCO data, saved at the end of OCM_modelvalidation.Rmd:
load("~/Box/PLCO Data/Prostate/plco_data_clean.RData")
```

Figure 1: Sample exclusions used to move from a sample of 9,214 men in National Health and Nutrition Examination Survey (NHANES) 1999-2010 to the final training sample of 2,420 men used for model-building. 
```{r, fig.align="center", out.width = "80%", message=FALSE, warning=FALSE, echo=FALSE}
#nhanesfinal <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nhanesbig.csv")

#nrow(filter(nhanesfinal, sex==1))
#nrow(filter(nhanesfinal, sex==1, age > 40))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age),  !is.na(diabetic),!is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (cancer == 0 | pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat)))

#nrow(filter(mydata, inmodel4==1))

## First break
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd)))

#nrow(filter(mydata, inmodel2==1))

## Second break
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema), !is.na(highchol)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital), !is.na(insurance)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital), !is.na(insurance), !is.na(kidney)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital), !is.na(insurance), !is.na(kidney), !is.na(liver)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital), !is.na(insurance), !is.na(kidney), !is.na(liver), !is.na(mental)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital), !is.na(insurance), !is.na(kidney), !is.na(liver), !is.na(mental), !is.na(military)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chd), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital), !is.na(insurance), !is.na(kidney), !is.na(liver), !is.na(mental), !is.na(military), !is.na(race)))
#nrow(filter(nhanesfinal, sex==1, age > 40, (nhanesfinal$cancer == 0 | nhanesfinal$pc == 1), !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(BMXBMI), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(alcoholic), !is.na(anemic), !is.na(angina), !is.na(arthritis), !is.na(asthma), !is.na(bronch), !is.na(care), !is.na(chd), !is.na(chf), !is.na(emphysema), !is.na(highchol), !is.na(hospital), !is.na(insurance), !is.na(kidney), !is.na(liver), !is.na(mental), !is.na(mi), !is.na(military), !is.na(race)))
    
#nrow(filter(mydata, inmodel1==1))

knitr::include_graphics(path = "/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Draft/nhanes_exclusions.png")
```

\newpage
Figure 2: Sample exclusions used to move from a sample of 8,776 men in the Prostate, Lung, Colon, and Ovarian Cancer Screening Trial (PLCO) to the final validation sample of 8,220 men used for model-building. 
```{r, fig.align="center", out.width = "70%", message=FALSE, warning=FALSE, echo=FALSE}
#prostatedata <-
#  read_csv("~/Box/PLCO Data/Prostate/pros_data_nov18_d070819.csv.zip")

#We filter to men who were actually diagnosed with prostate cancer:
#cancer <- filter(prostatedata, pros_cancer == 1)
#rm(list = c("prostatedata"))

#We filter to the list of variables we need for validation:
#plco <-
#  select(
#    cancer,
 #   race7,
#    pros_exitage,
#    diabetes_f,
#    hyperten_f,
#    stroke_f,
#    arthrit_f,
#    bronchit_f,
#    emphys_f,
#    hearta_f,
#    liver_comorbidity,
#    educat,
#    marital,
#    cig_stat,
#    bmi_curr,
#    is_dead_with_cod,
#    mortality_exitdays,
#    pros_exitdays,
#    f_dthp,
#    primary_trtp
#  )

#We define derived variables:
#plco$race2 <- case_when(
 # plco$race7 == 1 ~ "NHW",
  #plco$race7 == 2 ~ "NHB",
  #plco$race7 >= 3 & plco$race7 <= 6 ~ "Other",
  #plco$race7 == 7 ~ NA_character_
#)

#plco$educ <- case_when(
 # plco$educat == 1 ~ "Less than 9th grade",
  #plco$educat == 2 ~ "9th-11th grade",
  #plco$educat == 3 ~ "HS graduate",
  #plco$educat == 4 | plco$educat == 5 ~ "Some college",
  #plco$educat == 6 | plco$educat == 7 ~ "College graduate",
  #is.na(plco$educat) ~ NA_character_
#)

#plco$marital2 <- case_when(
 # plco$marital == 1 ~ "Married",
  #plco$marital == 2 |
  #  plco$marital == 3 | plco$marital == 4 ~ "Separated",
  #plco$marital == 5 ~ "Single",
  #is.na(plco$marital) ~ NA_character_
#)

#plco$smoker <- case_when(plco$cig_stat == 0 ~ "Never",
 #                        plco$cig_stat == 1 ~ "Current",
  #                       plco$cig_stat == 2 ~ "Former")

#plco$primary_tx <- case_when(
 # plco$primary_trtp == 0 ~ "No cancer",
  #plco$primary_trtp == 1 ~ "Prostatectomy",
  #plco$primary_trtp == 2 ~ "Radiation alone",
  #plco$primary_trtp == 3 ~ "Radiation + hormone",
  #plco$primary_trtp == 4 ~ "Hormone alone",
  #plco$primary_trtp == 5 ~ "Other ablative treatment",
  #plco$primary_trtp == 6 ~ "No known treatment",
  #plco$primary_trtp == 10 ~ NA_character_
#)

#plco$underweight <-
 # ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr < 18.5,
  #                                        1, 0))
#plco$overweight2 <-
 # ifelse(is.na(plco$bmi_curr),
  #       NA,
   #      ifelse(plco$bmi_curr >= 25
    #            &
     #             plco$bmi_curr < 40,
      #          1, 0))
#plco$obese2 <-
 # ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 40, 1, 0))
#plco$overweight_ex <-
 # ifelse(is.na(plco$bmi_curr),
  #       NA,
   #      ifelse(plco$bmi_curr >= 25
    #            &
     #             plco$bmi_curr < 30,
      #          1, 0))
#plco$obese <-
 # ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 30, 1, 0))

#plco$mortstat <- case_when(
 # plco$is_dead_with_cod == 1 & plco$f_dthp == 0 ~ 1,
  #plco$is_dead_with_cod == 1 & plco$f_dthp == 1 ~ 0,
  #plco$is_dead_with_cod == 0 ~ 0
#)

#plco$permth_exm <-
 # round((plco$mortality_exitdays - plco$pros_exitdays) / 30)

#plco <- mutate(
 # plco,
  #age = pros_exitage,
  #diabetic = diabetes_f,
  #hypertension = hyperten_f,
  #stroke = stroke_f,
  #arthritis = arthrit_f,
  #bronch = bronchit_f,
  #emphysema = emphys_f,
  #mi_chd = hearta_f,
  #liver = liver_comorbidity,
  #pc = 1
#)

#We select variables and do necessary renaming
#nrow(plco)
#nrow(filter(plco, !is.na(age)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker)))
#nrow(filter(plco, !is.na(age),  !is.na(diabetic),!is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(arthritis)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(arthritis), !is.na(bronch)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(arthritis), !is.na(bronch), !is.na(emphysema)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(arthritis), !is.na(bronch), !is.na(emphysema), !is.na(liver)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(arthritis), !is.na(bronch), !is.na(emphysema), !is.na(liver), !is.na(race2)))
#nrow(filter(plco, !is.na(age), !is.na(diabetic), !is.na(educ), !is.na(marital2), !is.na(hypertension), !is.na(underweight), !is.na(smoker), !is.na(stroke), !is.na(pc), !is.na(mortstat), !is.na(mi_chd), !is.na(arthritis), !is.na(bronch), !is.na(emphysema), !is.na(liver), !is.na(race2), !is.na(primary_tx)))

knitr::include_graphics(path = "/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Draft/plco_exclusions.png")
```
 
 \newpage
 
Table 1: Baseline characteristics of NHANES training and PLCO validation data.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
nhanes_for_table <- mutate(mydata, Dataset = "NHANES") %>% filter(inmodel1==1) %>% select(age, arthritis, bronch, diabetic, educ, emphysema, hypertension, marital2, mi_chd, underweight, overweight2, obese2, liver, race2, smoker, stroke, pc, permth_exm, mortstat, Dataset)

plco_for_table <- mutate(plco_clean, Dataset = "PLCO") %>% select(age, arthritis, bronch, diabetic, educ, emphysema, hypertension, marital2, mi_chd, underweight, overweight2, obese2, liver, race2, smoker, stroke, pc, permth_exm, mortstat, Dataset)

data_for_table <- rbind(nhanes_for_table, plco_for_table)

data_for_table$weight <- case_when(
  data_for_table$underweight=="Yes"~ "Underweight (BMI < 18.5)",
  data_for_table$underweight=="No" & data_for_table$overweight2=="No" & data_for_table$obese2=="No"~ "Normal weight (BMI 18.5-25)",
  data_for_table$overweight2=="Yes" ~ "Overweight (BMI 25-40)",
  data_for_table$obese2=="Yes" ~ "Obese (BMI 40+)"
)

data_for_table$weight <- factor(data_for_table$weight, levels=c("Underweight (BMI < 18.5)", "Normal weight (BMI 18.5-25)", "Overweight (BMI 25-40)", "Obese (BMI 40+)"), ordered=TRUE)

data_for_table$pc <- factor(data_for_table$pc, levels=c("No PC", "PC"), labels=c("No", "Yes"))
data_for_table$mortstat <- factor(data_for_table$mortstat, levels=c(0, 1), labels = c("Alive", "Deceased"))
var_label(data_for_table$age) <- "Age (years)"
var_label(data_for_table$race2) <- "Race"
var_label(data_for_table$educ) <- "Education"
var_label(data_for_table$marital2) <- "Marital status"
var_label(data_for_table$pc) <- "Prostate cancer"
var_label(data_for_table$mortstat) <- "Outcome"
var_label(data_for_table$permth_exm) <- "Follow-up (months)"
var_label(data_for_table$smoker) <- "Smoking status"
var_label(data_for_table$arthritis) <- "Arthritis"
var_label(data_for_table$bronch) <- "Chronic bronchitis"
var_label(data_for_table$diabetic) <- "Diabetes"
var_label(data_for_table$emphysema) <- "Emphysema"
var_label(data_for_table$hypertension) <- "Hypertension"
var_label(data_for_table$mi_chd) <- "Previous heart attack, coronary heart disease"
var_label(data_for_table$liver) <- "Liver disease"
var_label(data_for_table$stroke) <- "Previous stroke"
var_label(data_for_table$weight) <- "BMI category"

table_final <- CreateTableOne(vars = c("age", "race2", "educ", "marital2", "smoker", "arthritis", "bronch", "diabetic", "emphysema", "hypertension",  "mi_chd", "liver", "stroke", "weight", "pc", "mortstat", "permth_exm"), strata = "Dataset", includeNA = TRUE, data = data_for_table, argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

kable(print(table_final, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(4:6, 8:12, 14:16, 18:20, 30:33))

rm(list=c("table_final", "data_for_table", "nhanes_for_table", "plco_for_table"))
```

\newpage 

Table 2: Externally validated time-dependent AUCs at 5, 10, and 14 years of our Cox model fit to men ages 55+, our Cox model fit to men older than 40, and a random forest fit to men older than 40. Based on this assessment, we selected our age >40 Cox model as our final OC mortality model. We also include the AUCs obtained from using the Social Security Administration (SSA) 2001 actuarial table's life expectancy prediction and the National Vital Statistics System's (NVSS) 2001 life expectancy. All time-dependent AUCs were obtained after fitting the models in NHANES and then validating them in our PLCO validation sample of 8,220 men.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
cox_55 <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_55 + race2 + educ + marital2 + emphysema + 
      diabetic + stroke + smoker + underweight + overweight2 + obese2 + pc + 
      age_ctr_55 * diabetic + age_ctr_55 * educ + age_ctr_55 * marital2 + race2 * educ,
    data = mydata[mydata$inmodel5 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_40 <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

rforest_40 <-
  rfsrc(
    Surv(permth_exm, mortstat) ~ age + arthritis + bronch + diabetic + educ + 
      emphysema + hypertension + single + sep + mi_chd + underweight + overweight_ex + 
      obese + liver + black + other + smoker + stroke + pc,
    data = mydata_nf[mydata_nf$inmodel3 == 1, ],
    forest = TRUE
  )

times <- seq(6, 168, by=6)

cox55_plco <- pec::cindex(object=cox_55, Surv(permth_exm, mortstat) ~ age_ctr_55 + race2 + educ + marital2 + emphysema + diabetic + stroke + smoker + underweight + overweight2 + obese2 + pc + age_ctr_55*diabetic + age_ctr_55*educ + age_ctr_55*marital2 + race2*educ, data = plco_clean, eval.times = times)

cox40_plco <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + marital2 + underweight + overweight2 + obese2 + smoker + stroke + age_ctr_40*diabetic + age_ctr_40*educ + age_ctr_40*hypertension + age_ctr_40*stroke + pc, data=plco_clean, eval.times = times)

forest_plco <- pec::cindex(object=rforest_40, formula = Surv(permth_exm, mortstat) ~ age + arthritis + bronch + diabetic + educ + emphysema + hypertension + single + sep + mi_chd + underweight + overweight_ex + obese + liver + black + other + smoker + stroke + pc, data=plco_nf, eval.times = times)

cox40predict <- predict(object=cox_40, newdata = plco_clean, type="lp")
cox55predict <- predict(object=cox_55, newdata = plco_clean, type="lp")
rforestpredict <-
  predict(object=rforest_40,
          newdata = plco_nf)

cox40roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = cox40predict,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )
cox55roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = cox55predict,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )
rforestroc <-
  timeROC(
    T = plco_nf$permth_exm,
    delta = plco_nf$mortstat,
    marker = rforestpredict$predicted,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

ssa <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/ssa_2000.csv")
ssa$age <- seq(0, 119, by = 1)

nvss_black <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_blackmales_2001.csv")
nvss_white <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_whitemales_2001.csv")
nvss_other <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_allmales_2001.csv")
nvss_other <- nvss_other[-102,]

nvss <- data.frame("Age" = seq(0, 100, by = 1), "White" = nvss_white$Expectancy, "Black" = nvss_black$Expectancy, "Other" = nvss_other$Expectancy)

plco_clean$ssa <- NA
plco_clean$nvss <- NA
for (i in 1:nrow(plco_clean)){
  plco_clean$ssa[i] <- ssa$Expectancy[which(ssa$age==plco_clean$age[i])]
  if (plco_clean$race2[i]=="NHW"){
    plco_clean$nvss[i] <- nvss$White[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="NHB"){
    plco_clean$nvss[i] <- nvss$Black[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="Other"){
    plco_clean$nvss[i] <- nvss$Other[which(nvss$Age==plco_clean$age[i])]
  }
}

ssa_roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$ssa,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

nvss_roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$nvss,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

subperf <- data.frame("Model" = c("Cox Ages 55+", "Cox Ages >40", "Random Forest >40", "SSA", "NVSS"), "Year5_AUC" = round(c(cox55roc$AUC[11],cox40roc$AUC[11], rforestroc$AUC[11], ssa_roc$AUC[11], nvss_roc$AUC[11]), digits=2), "Year10_AUC" = round(c(cox55roc$AUC[21], cox40roc$AUC[21], rforestroc$AUC[21], ssa_roc$AUC[21], nvss_roc$AUC[21]), digits=2), "Year14_AUC" = round(c(cox55roc$AUC[29], cox40roc$AUC[29], rforestroc$AUC[29], ssa_roc$AUC[29], nvss_roc$AUC[29]), digits=2))

rownames(subperf) <- NULL
kable(subperf, col.names = c("Model", "5 Years", "10 Years", "14 Years")) %>%
add_header_above(c(" ", "AUC" = 3), escape=FALSE) %>% column_spec(column = 1, width = "3cm") %>% column_spec(column = 2:4, width = "1.75cm")

rm(list=c("subperf", "rforestroc", "cox55roc", "cox40roc", "cox55_plco", "cox40_plco", "forest_plco", "ssa_roc", "nvss_roc"))
```

\newpage

Figure 3: Comparison of life expectancy predictions (truncated at 17 years) from our final OC mortality model and predictions from the SSA 2001 actuarial tables for 8,220 men in PLCO.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
km_predictions <- survfit(cox_40, plco_clean)
incs2 <- km_predictions$time[2:length(km_predictions$time)] - km_predictions$time[1:(length(km_predictions$time)-1)]
rmst2 <- (incs2 %*% (km_predictions$surv[-nrow(km_predictions$surv),]))/12

expectancy_dat <- data.frame("Cox_40" = rmst2[1,], "SSA" = plco_clean$ssa, "NVSS" = plco_clean$nvss, "Actual" = plco_clean$permth_exm/12, "Outcome" = plco_clean$mortstat)

expectancy_dat$SSA[expectancy_dat$SSA > 17] <- 17
expectancy_dat$NVSS[expectancy_dat$NVSS > 17] <- 17

comparison_plot <- ggplot(data=expectancy_dat, aes(x = SSA, y = Cox_40, color = factor(Outcome))) + geom_point() + scale_color_manual("Outcome", values = c("mediumpurple4", "gray74"), labels=c("Censored", "Died of OCM")) + coord_cartesian(xlim = c(3, 17), ylim = c(3, 17)) + xlab("Social Security Predicted Life Expectancy (up to 17 years)") + ylab("Cox Model Predicted Life Expectancy (up to 17 years)") + geom_abline(slope = 1, intercept = 0) + theme_bw()

comparison_plot
```

\newpage
Table 3: Time-dependent AUC of our final OC mortality model in the three main treatment groups.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#And now we obtain estimates of the C-index and time-dependent AUC from our model in the main treatment groups: prostatectomy, radiation, and radiation + hormone:
cox40_prostatectomy <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + marital2 + underweight + overweight2 + obese2 + smoker + stroke + age_ctr_40*diabetic + age_ctr_40*educ + age_ctr_40*hypertension + age_ctr_40*stroke + pc, data=plco_clean[plco_clean$primary_tx=="Prostatectomy",], eval.times = times)

cox40_radiation <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + marital2 + underweight + overweight2 + obese2 + smoker + stroke + age_ctr_40*diabetic + age_ctr_40*educ + age_ctr_40*hypertension + age_ctr_40*stroke + pc, data=plco_clean[plco_clean$primary_tx=="Radiation alone",], eval.times = times)

cox40_rtadt <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + marital2 + underweight + overweight2 + obese2 + smoker + stroke + age_ctr_40*diabetic + age_ctr_40*educ + age_ctr_40*hypertension + age_ctr_40*stroke + pc, data=plco_clean[plco_clean$primary_tx=="Radiation + hormone",], eval.times = times)

cox40predict_prostatectomy <- predict(object=cox_40, newdata = plco_clean[plco_clean$primary_tx=="Prostatectomy",], type="lp")

cox40predict_radiation <- predict(object=cox_40, newdata = plco_clean[plco_clean$primary_tx=="Radiation alone",], type="lp")

cox40predict_rtadt <- predict(object=cox_40, newdata = plco_clean[plco_clean$primary_tx=="Radiation + hormone",], type="lp")

prostatectomy_roc <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Prostatectomy"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Prostatectomy"], marker = cox40predict_prostatectomy, cause = 1, weighting="marginal", times = seq(0, 168, by=6))

radiation_roc <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Radiation alone"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation alone"], marker = cox40predict_radiation, cause = 1, weighting="marginal", times = seq(0, 168, by=6))

rtadt_roc <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Radiation + hormone"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation + hormone"], marker = cox40predict_rtadt, cause = 1, weighting="marginal", times = seq(0, 168, by=6))

#subperf_trt <- data.frame("Treatment" = c("Prostatectomy", "Radiation alone", "Radiation + hormone"), "Year5_C" = round(c(cox40_prostatectomy$AppCindex$coxph[10], cox40_radiation$AppCindex$coxph[10], cox40_rtadt$AppCindex$coxph[10]), digits=2), "Year10_C" = round(c(cox40_prostatectomy$AppCindex$coxph[20], cox40_radiation$AppCindex$coxph[20], cox40_rtadt$AppCindex$coxph[20]), digits=2), "Year14_C" = round(c(cox40_prostatectomy$AppCindex$coxph[28], cox40_radiation$AppCindex$coxph[28], cox40_rtadt$AppCindex$coxph[28]), digits=2), "Year5_AUC" = round(c(prostatectomy_roc$AUC[11], radiation_roc$AUC[11], rtadt_roc$AUC[11]), digits=2), "Year10_AUC" = round(c(prostatectomy_roc$AUC[21], radiation_roc$AUC[21],rtadt_roc$AUC[21]), digits=2), "Year14_AUC" = round(c(prostatectomy_roc$AUC[29], radiation_roc$AUC[29], rtadt_roc$AUC[29]), digits=2))

subperf_trt <- data.frame("Treatment" = c("Prostatectomy", "Radiation alone", "Radiation + hormone"), "Year5_AUC" = round(c(prostatectomy_roc$AUC[11], radiation_roc$AUC[11], rtadt_roc$AUC[11]), digits=2), "Year10_AUC" = round(c(prostatectomy_roc$AUC[21], radiation_roc$AUC[21],rtadt_roc$AUC[21]), digits=2), "Year14_AUC" = round(c(prostatectomy_roc$AUC[29], radiation_roc$AUC[29], rtadt_roc$AUC[29]), digits=2))

rownames(subperf_trt) <- NULL
kable(subperf_trt, col.names = c("Treatment", "5 Years", "10 Years", "14 Years")) %>%
add_header_above(c(" ", "AUC" = 3), escape=FALSE) %>% column_spec(column = 1, width = "3cm") %>% column_spec(column = 2:4, width = "1.75cm")

rm(list=c("subperf_trt", "cox40predict_prostatectomy", "cox40predict_radiation", "cox40predict_rtadt", "radiation_roc", "prostatectomy_roc", "rtadt_roc", "cox40_radiation", "cox40_rtadt", "cox40_prostatectomy"))
```

\newpage

Figure 4: Calibration performance of our final OC mortality model in PLCO validation sample of 8,220 men with prostate cancer. 
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
cutTime <- 14*12   #14 yr cutoff point

km_predictions <- survfit(cox_40, plco_clean)

predict_5 <- km_predictions$surv[km_predictions$time==60,]
predict_10 <- km_predictions$surv[km_predictions$time==120,]
predict_14 <- km_predictions$surv[km_predictions$time==168,]

group_5 <- case_when(
  predict_5 < 0.2 ~ 0.1,
  predict_5 >= 0.2 & predict_5 < 0.4 ~ 0.3,
  predict_5 >= 0.4 & predict_5 < 0.6 ~ 0.5,
  predict_5 >= 0.6 & predict_5 < 0.8 ~ 0.7,
  predict_5 >= 0.8 ~ 0.9
)

group_10 <- case_when(
  predict_10 < 0.2 ~ 0.1,
  predict_10 >= 0.2 & predict_10 < 0.4 ~ 0.3,
  predict_10 >= 0.4 & predict_10 < 0.6 ~ 0.5,
  predict_10 >= 0.6 & predict_10 < 0.8 ~ 0.7,
  predict_10 >= 0.8 ~ 0.9
)

group_14 <- case_when(
  predict_14 < 0.2 ~ 0.1,
  predict_14 >= 0.2 & predict_14 < 0.4 ~ 0.3,
  predict_14 >= 0.4 & predict_14 < 0.6 ~ 0.5,
  predict_14 >= 0.6 & predict_14 < 0.8 ~ 0.7,
  predict_14 >= 0.8 ~ 0.9
)

km_5_05 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_5==0.5,])
km_5_07 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_5==0.7,])
km_5_09 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_5==0.9,])
km_10_01 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.1,])
km_10_03 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.3,])
km_10_05 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.5,])
km_10_07 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.7,])
km_10_09 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.9,])
km_14_01 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_14==0.1,])
km_14_03 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_14==0.3,])
km_14_05 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_14==0.5,])
km_14_07 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_14==0.7,])
km_14_09 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_14==0.9,])

calibration5_data <- data.frame("Year" = rep("5 Years", 3), 
                                "Group" = c(0.5, 0.7, 0.9), 
                                "Est" = c(km_5_05$surv[km_5_05$time==60], 
                                          km_5_07$surv[km_5_07$time==60], 
                                          km_5_09$surv[km_5_09$time==60]), 
                                "Lower" = c(km_5_05$lower[km_5_05$time==60], 
                                          km_5_07$lower[km_5_07$time==60], 
                                          km_5_09$lower[km_5_09$time==60]),
                                "Upper" = c(km_5_05$upper[km_5_05$time==60], 
                                          km_5_07$upper[km_5_07$time==60], 
                                          km_5_09$upper[km_5_09$time==60]))

calibration10_data <- data.frame("Year" = rep("10 Years", 5), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7, 0.9), 
                                 "Est" = c(km_10_01$surv[km_10_01$time==118], 
                                           km_10_03$surv[km_10_03$time==120], 
                                           km_10_05$surv[km_10_05$time==120], 
                                           km_10_07$surv[km_10_07$time==120], 
                                           km_10_09$surv[km_10_09$time==120]), 
                                "Lower" = c(km_10_01$lower[km_10_01$time==118],
                                         km_10_03$lower[km_10_03$time==120],
                                         km_10_05$lower[km_10_05$time==120], 
                                          km_10_07$lower[km_10_07$time==120], 
                                          km_10_09$lower[km_10_09$time==120]),
                                "Upper" = c(km_10_01$upper[km_10_01$time==118],
                                         km_10_03$upper[km_10_03$time==120],
                                         km_10_05$upper[km_10_05$time==120], 
                                          km_10_07$upper[km_10_07$time==120], 
                                          km_10_09$upper[km_10_09$time==120]))

calibration14_data <- data.frame("Year" = rep("14 Years", 5), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7, 0.9), 
                                 "Est" = c(km_14_01$surv[km_14_01$time==164], 
                                           km_14_03$surv[km_14_03$time==168], 
                                           km_14_05$surv[km_14_05$time==168], 
                                           km_14_07$surv[km_14_07$time==168], 
                                           km_14_09$surv[km_14_09$time==168]), 
                                "Lower" = c(km_14_01$lower[km_14_01$time==164],
                                         km_14_03$lower[km_14_03$time==168],
                                         km_14_05$lower[km_14_05$time==168], 
                                          km_14_07$lower[km_14_07$time==168], 
                                          km_14_09$lower[km_14_09$time==168]),
                                "Upper" = c(km_14_01$upper[km_14_01$time==164],
                                         km_14_03$upper[km_14_03$time==168],
                                         km_14_05$upper[km_14_05$time==168], 
                                          km_14_07$upper[km_14_07$time==168], 
                                          km_14_09$upper[km_14_09$time==168]))

calibrationdat_total <- rbind(calibration5_data, calibration10_data, calibration14_data)

myplot <- ggplot() + geom_line(data = calibrationdat_total, aes(x=Group, y=Est, 
                                                                group = Year, 
                                                                color = Year)) + 
  geom_errorbar(data = calibrationdat_total, aes(x = Group, ymin = Lower, 
                                              ymax = Upper, width = 0.05, group = Year, 
                                              color = Year)) + 
  scale_x_continuous(name = "Predicted OCM Survival",limits = c(0, 1), 
                                                   breaks = seq(0, 1, by=0.2)) + 
  scale_y_continuous(name = "Observed OCM Survival", limits = c(0, 1), 
                     breaks = seq(0, 1.2, by=0.2)) + theme_bw() + 
  geom_abline(slope = 1, intercept = 0) + scale_color_manual(values = c("darkblue", "mediumpurple4","gray74"), name = "Time") + theme(legend.position = "bottom")

myplot

rm(list=c("myplot"))
```

\newpage

Figure 5: Forest plot of predictors for final OC mortality prediction model fit in NHANES training data. The model also includes interactions between age and diabetes, education, hypertension, and stroke.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
table_model <- summary(cox_40)$conf.int
table_model[1, 1] <- exp(10*log(table_model[1, 1]))
table_model[1, 3] <- exp(10*log(table_model[1, 3]))
table_model[1, 4] <- exp(10*log(table_model[1, 4]))

cox_plotdata <- data.frame("Variable" = c("Age (per 10 years)", "Diabetes (ref: no diabetes)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Hypertension (ref: no hypertension)", "Separated (ref: married)", "Single (ref: married)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)", "Underweight, BMI <18.5 (ref: BMI 18.5-25)", "Overweight, BMI 25-40 (ref: BMI 18.5-25)", "Obese, BMI 40+ (ref: BMI 18.5-25)", "Prostate cancer (ref: no prostate cancer)"), "Effect" = table_model[1:16,1], "Lower" = table_model[1:16,3], "Upper" = table_model[1:16,4], "Label" = paste(round(table_model[1:16,1], digits=2), " (", round(table_model[1:16,3], digits=2), ",", round(table_model[1:16,4], digits=2), ")", sep=""))

cox_plotdata$Variable <- factor(cox_plotdata$Variable, levels= c("Age (per 10 years)", "Diabetes (ref: no diabetes)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Hypertension (ref: no hypertension)", "Separated (ref: married)", "Single (ref: married)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)", "Underweight, BMI <18.5 (ref: BMI 18.5-25)", "Overweight, BMI 25-40 (ref: BMI 18.5-25)", "Obese, BMI 40+ (ref: BMI 18.5-25)", "Prostate cancer (ref: no prostate cancer)"), ordered=TRUE)

adj_plot <- ggplot(cox_plotdata, aes(fct_rev(Variable), log(Effect))) + geom_point() + geom_errorbar(aes(ymin=log(Lower), ymax=log(Upper), width=0.1)) + coord_flip(ylim=c(-1.0, 5)) + labs(y = "Hazard Ratio and 95% CI", x = "", caption=TeX('Protective $\\leftarrow \\rightarrow$ Harmful' )) + geom_hline(yintercept=0, linetype="dashed", color = "black") + theme(panel.background = element_rect(fill="white"), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), legend.position="bottom", plot.caption = element_text(hjust = 0.1)) + geom_rect(fill="white", ymin=4.7, ymax=Inf, xmin=-Inf, xmax=Inf) + annotate(geom = 'text', label = cox_plotdata$Label, x = cox_plotdata$Variable, y = 2, hjust = 0, vjust = 0.5) + scale_y_continuous(breaks=log(c(0.25, 0.5, 1, 2, 4)), labels=c("0.25", "0.5", "1.0", "2.0", "4.0")) 
 
adj_plot

#ggsave("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Code/forest_plot.pdf", adj_plot, width = 12, height = 8)
rm(list=c("adj_plot", "cox_plotdata", "table_model"))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 3: Forest plot of final Cox model:
cox_plotdata <- data.frame("Variable" = c("Age", "Diabetes", "9th-11th Grade", "High School", "Some College", "College", "Hypertension", "Separated", "Single", "Current Smoker", "Former Smoker", "Stroke", "Underweight (BMI <18.5)", "Overweight (BMI 25-40)", "Obese (BMI 40+)", "Prostate Cancer", "Age*Diabetes", "Age*9th-11th Grade", "Age*High School", "Age*Some College", "Age*College", "Age*Hypertension", "Age*Stroke"), "Effect" = summary(cox_40)$conf.int[,1], "Lower" = summary(cox_40)$conf.int[,3], "Upper" = summary(cox_40)$conf.int[,4], "Label" = paste(round(summary(cox_40)$conf.int[,1], digits=2), " (", round(summary(cox_40)$conf.int[,3], digits=2), ",", round(summary(cox_40)$conf.int[,4], digits=2), ")", sep=""))

cox_plotdata$Variable <- factor(cox_plotdata$Variable, levels= c("Age", "Diabetes", "9th-11th Grade", "High School", "Some College", "College", "Hypertension", "Separated", "Single", "Current Smoker", "Former Smoker", "Stroke", "Underweight (BMI <18.5)", "Overweight (BMI 25-40)", "Obese (BMI 40+)", "Prostate Cancer", "Age*Diabetes", "Age*9th-11th Grade", "Age*High School", "Age*Some College", "Age*College", "Age*Hypertension", "Age*Stroke"), ordered=TRUE)

adj_plot <- ggplot(cox_plotdata, aes(fct_rev(Variable), log(Effect))) + geom_point() + geom_errorbar(aes(ymin=log(Lower), ymax=log(Upper), width=0.1)) + coord_flip(ylim=c(-1.0, 3)) + labs(y = "Hazard Ratio and 95% CI", x = "", caption=TeX('Protective $\\leftarrow \\rightarrow$ Harmful' )) + geom_hline(yintercept=0, linetype="dashed", color = "black") + theme(panel.background = element_rect(fill="white"), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), legend.position="bottom", text=element_text(size=14), plot.caption = element_text(size=14, hjust = 0)) + geom_rect(fill="white", ymin=4.7, ymax=Inf, xmin=-Inf, xmax=Inf) + annotate(geom = 'text', label = cox_plotdata$Label, x = cox_plotdata$Variable, y = 1.7, hjust = 0, vjust = 0.5) + scale_y_continuous(breaks=log(c(0.25, 0.5, 1, 2, 4)), labels=c("0.25", "0.5", "1.0", "2.0", "4.0")) 
 
#adj_plot

rm(list=c("cox_plotdata", "adj_plot"))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 3: Forest plot of Cox model ages 55+
table_model <- summary(cox_55)$conf.int
table_model[1, 1] <- exp(10*log(table_model[1, 1]))
table_model[1, 3] <- exp(10*log(table_model[1, 3]))
table_model[1, 4] <- exp(10*log(table_model[1, 4]))

cox_plotdata <- data.frame("Variable" = c("Age (per 10 years)", "White Race (ref: Black Race)", "Other Race (ref: Black Race)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Separated (ref: married)", "Single (ref: married)", "Emphysema (ref: no emphysema)", "Diabetic (ref: no diabetes)", "Stroke (ref: no stroke)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Underweight, BMI <18.5 (ref: BMI 18.5-25)", "Overweight, BMI 25-40 (ref: BMI 18.5-25)", "Obese, BMI 40+ (ref: BMI 18.5-25)", "Prostate cancer (ref: no prostate cancer)"), "Effect" = table_model[1:18,1], "Lower" = table_model[1:18,3], "Upper" = table_model[1:18,4], "Label" = paste(round(table_model[1:18,1], digits=2), " (", round(table_model[1:18,3], digits=2), ",", round(table_model[1:18,4], digits=2), ")", sep=""))


cox_plotdata$Variable <- factor(cox_plotdata$Variable, levels= c("Age (per 10 years)", "White Race (ref: Black Race)", "Other Race (ref: Black Race)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Separated (ref: married)", "Single (ref: married)", "Emphysema (ref: no emphysema)", "Diabetic (ref: no diabetes)", "Stroke (ref: no stroke)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Underweight, BMI <18.5 (ref: BMI 18.5-25)", "Overweight, BMI 25-40 (ref: BMI 18.5-25)", "Obese, BMI 40+ (ref: BMI 18.5-25)", "Prostate cancer (ref: no prostate cancer)"), ordered=TRUE)

adj_plot <- ggplot(cox_plotdata, aes(fct_rev(Variable), log(Effect))) + geom_point() + geom_errorbar(aes(ymin=log(Lower), ymax=log(Upper), width=0.1)) + coord_flip(ylim=c(-1.0, 5.5)) + labs(y = "Hazard Ratio and 95% CI", x = "", caption=TeX('Protective $\\leftarrow \\rightarrow$ Harmful' )) + geom_hline(yintercept=0, linetype="dashed", color = "black") + theme(panel.background = element_rect(fill="white"), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), legend.position="bottom", text=element_text(size=14), plot.caption = element_text(size=14, hjust = 0)) + geom_rect(fill="white", ymin=5.5, ymax=Inf, xmin=-Inf, xmax=Inf) + annotate(geom = 'text', label = cox_plotdata$Label, x = cox_plotdata$Variable, y = 1.7, hjust = 0, vjust = 0.5) + scale_y_continuous(breaks=log(c(0.25, 0.5, 1, 2, 4)), labels=c("0.25", "0.5", "1.0", "2.0", "4.0")) 
 
#adj_plot

rm(list=c("cox_plotdata", "adj_plot", "cox_55"))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 3: Importance plot of random forest model:

#varlist <- vimp(rforest_40)

#rforest_plot <- data.frame("Variable" = c("Age", "Arthritis", "Chronic Bronchitis", 
#"Diabetes", "Education", "Emphysema", "Hypertension", "Single", "Divorced/Separated/Widowed", 
#"MI", "Underweight", "Overweight", "Obese", "Liver Disease", "Black", "Other Race", 
#"Smoking Status", "Stroke", "Prostate Cancer"), "Importance" = varlist$importance, 
#"Label" = paste(round(varlist$importance, digits=3)))

#rforest_plot$Variable <- factor(rforest_plot$Variable, 
#levels=rforest_plot$Variable[order(rforest_plot$Importance)], ordered = TRUE)
#rforest_plot$Label2 <- case_when(
#rforest_plot$Label=="0" ~ "0.000", 
#rforest_plot$Label!= "0" ~ as.character(rforest_plot$Label))

#b <- ggplot(rforest_plot, aes(x = Variable, y= Importance)) + 
#geom_bar(stat="identity", width=.5, position = "dodge") + 
#coord_flip(ylim=c(0, 0.25)) + xlab('') + ylab('Importance') + 
#theme(panel.background = element_rect(fill="white"), 
#panel.grid.major = element_line(color="black", size=0.2), 
#panel.grid.minor=element_line(color="black", size=0.2), 
#text=element_text(size=14)) + 
#geom_rect(fill="white", ymin=0.2, ymax=Inf, xmin=-Inf, xmax=Inf) + 
#annotate(geom = 'text', label = rforest_plot$Label2, x = rforest_plot$Variable, 
#y = 0.205, hjust = 0, vjust = 0.5) + scale_y_continuous(breaks=c(0.0, 0.05, 0.1, 0.15, 0.2)) 

#b

rm(list=c("varlist", "plco_plot", "b", "rforest_40"))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Fine and Gray calibration plot:
cutTime <- 14*12   #14 yr cutoff point

dat <- plco_clean[, c("pc_status", "pc_time_14yr", "linpred")]
dat <- dat[complete.cases(dat), ]
  
eve.ocm <- dat$pc_status == 1
eve.pcsm <- dat$pc_status == 2
eve.cens <- dat$pc_status == 0 
  
fstatus <- rep(0,times = nrow(dat))
fstatus[which(eve.ocm)] <- 1
fstatus[which(eve.pcsm)] <- 2
ftime <- dat$pc_time_14yr

fg_covariates <- dat$linpred

finegray_pc <- crr(ftime = ftime, fstatus = fstatus, cov1 = fg_covariates)
#summary(finegray_pc)

finegray_predictions <- predict(finegray_pc, cov1 = fg_covariates)

predict_5 <- finegray_predictions[finegray_predictions[,1]==60,-1]
predict_10 <- finegray_predictions[finegray_predictions[,1]==120,-1]
predict_14 <- finegray_predictions[finegray_predictions[,1]==167,-1]

group_5 <- case_when(
  predict_5 < 0.2 ~ 0.1,
  predict_5 >= 0.2 & predict_5 < 0.4 ~ 0.3,
  predict_5 >= 0.4 & predict_5 < 0.6 ~ 0.5,
  predict_5 >= 0.6 & predict_5 < 0.8 ~ 0.7,
  predict_5 >= 0.8 ~ 0.9
)

group_10 <- case_when(
  predict_10 < 0.2 ~ 0.1,
  predict_10 >= 0.2 & predict_10 < 0.4 ~ 0.3,
  predict_10 >= 0.4 & predict_10 < 0.6 ~ 0.5,
  predict_10 >= 0.6 & predict_10 < 0.8 ~ 0.7,
  predict_10 >= 0.8 ~ 0.9
)

group_14 <- case_when(
  predict_14 < 0.2 ~ 0.1,
  predict_14 >= 0.2 & predict_14 < 0.4 ~ 0.3,
  predict_14 >= 0.4 & predict_14 < 0.6 ~ 0.5,
  predict_14 >= 0.6 & predict_14 < 0.8 ~ 0.7,
  predict_14 >= 0.8 ~ 0.9
)

cuminc_5 <- cuminc(ftime, fstatus, group = group_5)
cuminc_10 <- cuminc(ftime, fstatus, group = group_10)
cuminc_14 <- cuminc(ftime, fstatus, group = group_14)

calibration5_data <- data.frame("Year" = rep("5 Years", 3), 
                                "Group" = c(0.1, 0.3, 0.5), 
                                "Est" = c(cuminc_5$`0.1 1`$est[cuminc_5$`0.1 1`$time==60][1], 
                                          cuminc_5$`0.3 1`$est[cuminc_5$`0.3 1`$time==59][1], 
                                          cuminc_5$`0.5 1`$est[cuminc_5$`0.5 1`$time==57][1]), 
                                "Var" = c(cuminc_5$`0.1 1`$var[cuminc_5$`0.1 1`$time==60][1], 
                                          cuminc_5$`0.3 1`$var[cuminc_5$`0.3 1`$time==59][1], 
                                          cuminc_5$`0.5 1`$var[cuminc_5$`0.5 1`$time==57][1]))

calibration10_data <- data.frame("Year" = rep("10 Years", 4), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7), 
                                 "Est" = c(cuminc_10$`0.1 1`$est[cuminc_10$`0.1 1`$time==120][1], 
                                           cuminc_10$`0.3 1`$est[cuminc_10$`0.3 1`$time==120][1], 
                                           cuminc_10$`0.5 1`$est[cuminc_10$`0.5 1`$time==119][1], 
                                           cuminc_10$`0.7 1`$est[cuminc_10$`0.7 1`$time==118][1]), 
                                 "Var" = c(cuminc_10$`0.1 1`$var[cuminc_10$`0.1 1`$time==120][1], 
                                           cuminc_10$`0.3 1`$var[cuminc_10$`0.3 1`$time==120][1], 
                                           cuminc_10$`0.5 1`$var[cuminc_10$`0.5 1`$time==119][1], 
                                           cuminc_10$`0.7 1`$var[cuminc_10$`0.7 1`$time==118][1]))

calibration14_data <- data.frame("Year" = rep("10 Years", 5), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7, 0.9), 
                                 "Est" = c(cuminc_14$`0.1 1`$est[cuminc_14$`0.1 1`$time==168][1], 
                                           cuminc_14$`0.3 1`$est[cuminc_14$`0.3 1`$time==168][1], 
                                           cuminc_14$`0.5 1`$est[cuminc_14$`0.5 1`$time==168][1], 
                                           cuminc_14$`0.7 1`$est[cuminc_14$`0.7 1`$time==168][1], 
                                           cuminc_14$`0.9 1`$est[cuminc_14$`0.9 1`$time==157][1]), 
                                 "Var" = c(cuminc_14$`0.1 1`$var[cuminc_14$`0.1 1`$time==168][1], 
                                           cuminc_14$`0.3 1`$var[cuminc_14$`0.3 1`$time==168][1], 
                                           cuminc_14$`0.5 1`$var[cuminc_14$`0.5 1`$time==168][1], 
                                           cuminc_14$`0.7 1`$var[cuminc_14$`0.7 1`$time==168][1], 
                                           cuminc_14$`0.9 1`$var[cuminc_14$`0.9 1`$time==157][1]))

calibration5_data$Upper <- calibration5_data$Est + 1.96*sqrt(calibration5_data$Var)
calibration10_data$Upper <- calibration10_data$Est + 1.96*sqrt(calibration10_data$Var)
calibration14_data$Upper <- calibration14_data$Est + 1.96*sqrt(calibration14_data$Var)
calibration5_data$Lower <- calibration5_data$Est - 1.96*sqrt(calibration5_data$Var)
calibration10_data$Lower <- calibration10_data$Est - 1.96*sqrt(calibration10_data$Var)
calibration14_data$Lower <- calibration14_data$Est - 1.96*sqrt(calibration14_data$Var)

calibration5_data$Upper[calibration5_data$Upper>1] <- 1
calibration5_data$Lower[calibration5_data$Lower<0] <- 0
calibration10_data$Upper[calibration10_data$Upper>1] <- 1
calibration10_data$Lower[calibration10_data$Lower<0] <- 0
calibration14_data$Upper[calibration14_data$Upper>1] <- 1
calibration14_data$Lower[calibration14_data$Lower<0] <- 0

myplot <- ggplot() + geom_line(data = calibration5_data, aes(x=Group, y=Est), 
                               color = "darkblue") + 
  geom_errorbar(data = calibration5_data, aes(x = Group, ymin = Lower, 
                                              ymax = Upper, width = 0.05), 
                color = "darkblue") + geom_line(data = calibration10_data, 
                                                aes(x=Group, y=Est), 
                                                color = "mediumpurple4") + 
  geom_errorbar(data = calibration10_data, aes(x = Group, ymin = Lower, 
                                               ymax = Upper, width = 0.05), 
                color = "mediumpurple4") + geom_line(data = calibration14_data, 
                                                     aes(x=Group, y=Est), 
                                                     color = "gray74") + 
  geom_errorbar(data = calibration14_data, aes(x = Group, ymin = Lower, 
                                               ymax = Upper), color = "gray74", 
                width = 0.05) + scale_x_continuous(name = "Predicted Risk of OCM", 
                                                   limits = c(0, 1), 
                                                   breaks = seq(0, 1, by=0.2)) + 
  scale_y_continuous(name = "Observed Risk of OCM", limits = c(0, 1), 
                     breaks = seq(0, 1.2, by=0.2)) + theme_bw() + 
  geom_abline(slope = 1, intercept = 0)  + 
  labs(caption = "Black line: perfect calibration. Blue line: calibration at 
       5 years. Purple line: calibration at 10 years. Gray line: calibration 
       at 14 years.")

#myplot

rm(list=c("calibration10_data", "calibration14_data", "calibration5_data", "cuminc_10", "cuminc_14", "cuminc_5", "km_10_01", "km_10_03", "km_10_05", "km_10_07", "km_10_09", "km_14_01", "km_14_03", "km_14_05", "km_14_07", "km_14_09", "km_5_05", "km_5_07", "km_5_09", "km_predictions", "group_10", "group_14", "group_5", "predict_10", "predict_14", "predict_5"))
```

\newpage

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 6: Sample incidence curves predicted using our OC mortality model for 5 different patients taken from our PLCO validation sample. 

km_predictions <- survfit(cox_40, plco_clean)

predict_10 <- km_predictions$surv[km_predictions$time==120,]

set.seed(653)
patient1 <- base::sample(which(predict_10 < 0.2), size = 1)
patient2 <- sample(which(predict_10 >= 0.2 & predict_10 < 0.4), size = 1)
patient3 <- sample(which(predict_10 >= 0.4 & predict_10 < 0.6), size = 1)
patient4 <- sample(which(predict_10 >= 0.6 & predict_10 < 0.8), size = 1)
patient5 <- sample(which(predict_10 >= 0.8), size = 1)

example_dat <- data.frame("Patient" = c(rep(1, nrow(km_predictions$surv)), rep(2, nrow(km_predictions$surv)), rep(3, nrow(km_predictions$surv)), rep(4, nrow(km_predictions$surv)), rep(5, nrow(km_predictions$surv))), "Time" = rep(km_predictions$time, 5), "Risk" = c(km_predictions$surv[,patient1], km_predictions$surv[,patient2], km_predictions$surv[,patient3], km_predictions$surv[,patient4], km_predictions$surv[,patient5]))

example_dat$Patient <- factor(example_dat$Patient, levels=c(1:5), labels=c("Patient 1", "Patient 2", "Patient 3", "Patient 4", "Patient 5"), ordered = TRUE)

curveplot <- ggplot() + geom_step(data = example_dat, aes(x = Time, y = Risk*100, group = fct_rev(Patient), color = fct_rev(Patient)), size = 1.5, direction = "hv", alpha = 1) + scale_x_continuous("Years", limits = c(0, 168), breaks = seq(0, 168, by=48), labels = c("0", "4", "8", "12")) + scale_y_continuous("Survival (%)", breaks = c(0, 25, 50, 75, 100)) + coord_cartesian(ylim=c(0, 100)) + theme_bw() + guides(color=guide_legend(title="Patient"))

#curveplot

rm(list=c("curveplot", "example_dat", "patient1", "patient2", "patient3", "patient4", "patient5"))

#atient 1 (very high risk): age 85, no comorbidities, some college, married, current smoker, BMI 25-40

#Patient 2 (high risk): age 82, hypertensive, college graduate, married, former smoker, BMI 18.5-25

#Patient 3 (moderate risk): age 71, hypertensive, high school graduate, married, current smoker, BMI 18.5-25

#Patient 4 (low risk): age 66, no comorbidities, college graduate, separated, current smoker, BMI 18.5-25

#Patient 5 (very low risk): age 62, hypertensive, some college, married, former smoker, BMI 25-40
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 7: Distribution of life expectancy across age group

myfunc <- function(x){
  inds <- which(x-0.5 <= 0)
  if (identical(inds, integer(0))){
    mytime <- 202
  } else{
    mytime <- min(inds)
  }
  return(mytime)
}
medsurv <- apply(X = km_predictions$surv, MARGIN = 2, FUN = myfunc)
medsurv2 <- data.frame(medsurv)

plco_clean$age_grp <- case_when(
  plco_clean$age < 65 ~ "55-64",
  plco_clean$age >= 65 & plco_clean$age < 75 ~ "65-74",
  plco_clean$age >= 75 & plco_clean$age < 85 ~ "75-84",
  plco_clean$age >= 85 ~ "85+"
)

plco_clean$medsurv <- medsurv2$medsurv

myplot <- ggplot(data=plco_clean) + geom_density(aes(x=medsurv, color = age_grp, fill = age_grp), alpha = 0.3) + scale_x_continuous(breaks = c(48, 72, 96, 120, 144, 168, 192, 216), labels=c("4", "6", "8", "10", "12", "14", "16", "18")) + xlab("Median Survival (Years)") + ylab("Density") + theme_bw() + guides(color=guide_legend(title="Age"), fill = guide_legend(title = "Age"))

#myplot
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 6: Treatment concordance with OCM predictions:

prostatedata <- read_csv("~/Box/PLCO Data/Prostate/pros_data_nov18_d070819.csv.zip")
cancer <- filter(prostatedata, pros_cancer == 1)
rm(list = c("prostatedata"))

#We filter to the list of variables we need for validation:
plco <-
  select(
    cancer,
    race7,
    pros_exitage,
    diabetes_f,
    hyperten_f,
    stroke_f,
    arthrit_f,
    bronchit_f,
    emphys_f,
    hearta_f,
    liver_comorbidity,
    educat,
    marital,
    cig_stat,
    bmi_curr,
    is_dead_with_cod,
    mortality_exitdays,
    pros_exitdays,
    f_dthp,
    primary_trtp,
    pros_stage_n, 
    pros_stage_t, 
    pros_gleason, 
    dx_psa
  )

plco$nstage <- case_when(
  plco$pros_stage_n==0 ~ "N0",
  plco$pros_stage_n==100 ~ "N1",
  plco$pros_stage_n==200 ~ "N2",
  plco$pros_stage_n==999 ~ "NX"
)

plco$tstage <- case_when(
  plco$pros_stage_t==0 ~ "T0",
  plco$pros_stage_t==100 | plco$pros_stage_t==110 | plco$pros_stage_t==120 | plco$pros_stage_t==130 | plco$pros_stage_t==210 ~ "T1-T2a",
  plco$pros_stage_t==200 | plco$pros_stage_t==220 | plco$pros_stage_t==230 ~ "T2b-T2c",
  plco$pros_stage_t==300 | plco$pros_stage_t==310 | plco$pros_stage_t==320 | plco$pros_stage_t==330 | plco$pros_stage_t==400 | plco$pros_stage_t==410 | plco$pros_stage_t==420 ~ "T3a-T4",
  plco$pros_stage_t==999 ~ "TX"
)

plco$gleason <- case_when(
  plco$pros_gleason <= 6 ~ "<= 6",
  plco$pros_gleason == 7 ~ "7",
  plco$pros_gleason ==8 ~ "8",
  plco$pros_gleason ==9 ~ "9",
  plco$pros_gleason == 10 ~ "10",
  plco$pros_gleason == 99 ~ NA_character_
)

#We define derived variables:
plco$race2 <- case_when(
  plco$race7 == 1 ~ "NHW",
  plco$race7 == 2 ~ "NHB",
  plco$race7 >= 3 & plco$race7 <= 6 ~ "Other",
  plco$race7 == 7 ~ NA_character_
)

plco$educ <- case_when(
  plco$educat == 1 ~ "Less than 9th grade",
  plco$educat == 2 ~ "9th-11th grade",
  plco$educat == 3 ~ "HS graduate",
  plco$educat == 4 | plco$educat == 5 ~ "Some college",
  plco$educat == 6 | plco$educat == 7 ~ "College graduate",
  is.na(plco$educat) ~ NA_character_
)

plco$marital2 <- case_when(
  plco$marital == 1 ~ "Married",
  plco$marital == 2 |
    plco$marital == 3 | plco$marital == 4 ~ "Separated",
  plco$marital == 5 ~ "Single",
  is.na(plco$marital) ~ NA_character_
)

plco$smoker <- case_when(plco$cig_stat == 0 ~ "Never",
                         plco$cig_stat == 1 ~ "Current",
                         plco$cig_stat == 2 ~ "Former")

plco$primary_tx <- case_when(
  plco$primary_trtp == 0 ~ "No cancer",
  plco$primary_trtp == 1 ~ "Prostatectomy",
  plco$primary_trtp == 2 ~ "Radiation alone",
  plco$primary_trtp == 3 ~ "Radiation + hormone",
  plco$primary_trtp == 4 ~ "Hormone alone",
  plco$primary_trtp == 5 ~ "Other ablative treatment",
  plco$primary_trtp == 6 ~ "No known treatment",
  plco$primary_trtp == 10 ~ NA_character_
)

plco$underweight <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr < 18.5,
                                          1, 0))
plco$overweight2 <-
  ifelse(is.na(plco$bmi_curr),
         NA,
         ifelse(plco$bmi_curr >= 25
                &
                  plco$bmi_curr < 40,
                1, 0))
plco$obese2 <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 40, 1, 0))
plco$overweight_ex <-
  ifelse(is.na(plco$bmi_curr),
         NA,
         ifelse(plco$bmi_curr >= 25
                &
                  plco$bmi_curr < 30,
                1, 0))
plco$obese <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 30, 1, 0))

plco$mortstat <- case_when(
  plco$is_dead_with_cod == 1 & plco$f_dthp == 0 ~ 1,
  plco$is_dead_with_cod == 1 & plco$f_dthp == 1 ~ 0,
  plco$is_dead_with_cod == 0 ~ 0
)

plco$mortstat2 <- case_when(
  plco$is_dead_with_cod == 1 & plco$f_dthp == 0 ~ 1,
  plco$is_dead_with_cod == 1 & plco$f_dthp == 1 ~ 2,
  plco$is_dead_with_cod == 0 ~ 0
)

plco$permth_exm <-
  round((plco$mortality_exitdays - plco$pros_exitdays) / 30)

#We select variables and do necessary renaming
plco_clean2 <- mutate(
  plco,
  age = pros_exitage,
  diabetic = diabetes_f,
  hypertension = hyperten_f,
  stroke = stroke_f,
  arthritis = arthrit_f,
  bronch = bronchit_f,
  emphysema = emphys_f,
  mi_chd = hearta_f,
  liver = liver_comorbidity,
  pc = 1
) %>%
  select(
    race2,
    age,
    diabetic,
    hypertension,
    stroke,
    arthritis,
    bronch,
    emphysema,
    mi_chd,
    liver,
    educ,
    marital2,
    smoker,
    underweight,
    overweight2,
    obese2,
    overweight_ex,
    obese,
    pc,
    mortstat,
    mortstat2,
    permth_exm,
    primary_tx,
    nstage,
    tstage,
    gleason,
    dx_psa
  )

#We define factors:
plco_clean2$race2 <- factor(plco_clean2$race2)
plco_clean2$educ <- factor(plco_clean2$educ)
plco_clean2$marital2 <- factor(plco_clean2$marital2)
plco_clean2$smoker <- factor(plco_clean2$smoker)
plco_clean2$pc <-
  factor(plco_clean2$pc,
         levels = c(0, 1),
         labels = c("No PC", "PC"))
plco_clean2$hypertension <-
  factor(plco_clean2$hypertension,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$diabetic <- factor(plco_clean2$diabetic,
                              levels = c(0, 1),
                              labels = c("No", "Yes"))
plco_clean2$stroke <- factor(plco_clean2$stroke,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean2$arthritis <-
  factor(plco_clean2$arthritis,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$bronch <- factor(plco_clean2$bronch,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean2$emphysema <-
  factor(plco_clean2$emphysema,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$mi_chd <- factor(plco_clean2$mi_chd,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean2$liver <- factor(plco_clean2$liver,
                           levels = c(0, 1),
                           labels = c("No", "Yes"))
plco_clean2$underweight <-
  factor(plco_clean2$underweight,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$overweight2 <-
  factor(plco_clean2$overweight2,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$obese2 <- factor(plco_clean2$obese2,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))

plco_clean2$tstage <- factor(plco_clean2$tstage)
plco_clean2$nstage <- factor(plco_clean2$nstage)
plco_clean2$gleason <- factor(plco_clean2$gleason, levels=c("<= 6","7","8","9","10"), ordered=TRUE)

plco_clean2 <- na.omit(plco_clean2)

cutTime <- 14*12   #14 yr cutoff point
plco_clean2$age_ctr_40 <- plco_clean2$age - 60.34387 #scaling the age 40+ cohort
plco_clean2$pc_time_14yr <- ifelse(plco_clean2$permth_exm > cutTime, cutTime, 
                                  plco_clean2$permth_exm)
plco_clean2$pc_status <- ifelse(plco_clean2$permth_exm >= cutTime, 0, 
                               plco_clean2$mortstat2)
plco_clean2$linpred <- predict(object=cox_40, newdata = plco_clean2, type="lp")

#dat <- plco_clean2[, c("pc_status", "pc_time_14yr", "linpred")]
#dat <- dat[complete.cases(dat), ]
#eve.ocm <- dat$pc_status == 1
#eve.pcsm <- dat$pc_status == 2
#eve.cens <- dat$pc_status == 0 
  
#fstatus <- rep(0,times = nrow(dat))
#fstatus[which(eve.ocm)] <- 1
#fstatus[which(eve.pcsm)] <- 2
#ftime <- dat$pc_time_14yr

#fg_covariates <- dat$linpred

#finegray_pc <- crr(ftime = ftime, fstatus = fstatus, cov1 = fg_covariates)

#finegray_predictions <- predict(finegray_pc, cov1 = fg_covariates)
#incs <- finegray_predictions[2:nrow(finegray_predictions),1] - finegray_predictions[1:(nrow(finegray_predictions)-1), 1]
#rmst <- (incs %*% (1-finegray_predictions[-168, -1]))/12

km_predictions <- survfit(cox_40, plco_clean2)
incs2 <- km_predictions$time[2:length(km_predictions$time)] - km_predictions$time[1:(length(km_predictions$time)-1)]
rmst2 <- (incs2 %*% (km_predictions$surv[-202,]))/12

#finegray_group <- case_when(
#  rmst >= 10 ~ "10+",
#  rmst >= 5 & rmst < 10 ~ "5-10",
#  rmst < 5 ~ "< 5",
#)

causespecific_group <- case_when(
  rmst2 >= 10 ~ "10+",
  rmst2 >= 5 & rmst2 < 10 ~ "5-10",
  rmst2 < 5 ~ "< 5",
)

plco_clean2$riskgroup <- factor(causespecific_group, levels=c("10+", "5-10", "< 5"), ordered=TRUE)

plco_clean2$lifeexpectancy <- as.numeric(t(rmst2)) 

plco_clean2$weight <- case_when(
  plco_clean2$underweight=="Yes"~ "Underweight (BMI < 18.5)",
  plco_clean2$underweight=="No" & plco_clean2$overweight2=="No" & plco_clean2$obese2=="No"~ "Normal weight (BMI 18.5-25)",
  plco_clean2$overweight2=="Yes" ~ "Overweight (BMI 25-40)",
  plco_clean2$obese2=="Yes" ~ "Obese (BMI 40+)"
)

plco_clean2$weight <- factor(plco_clean2$weight, levels=c("Underweight (BMI < 18.5)", "Normal weight (BMI 18.5-25)", "Overweight (BMI 25-40)", "Obese (BMI 40+)"), ordered=TRUE)

plco_clean2$mortstat <- factor(plco_clean2$mortstat2, levels=c(0, 1, 2), labels = c("Alive", "Died of OC", "Died of PC"))

#plco_clean2$ocm_10_group <- ifelse(predict_10 <= 0.5, "Low risk", "High risk")
 
#predict_5 <- finegray_predictions[finegray_predictions[,1]==60,-1]
#plco_clean2$ocm_5_group <- ifelse(predict_5 <= 0.5, "Low risk", "High risk")

plco_clean2$pc_risk_group <- case_when(
  plco_clean2$tstage=="T1-T2a" & plco_clean2$gleason =="<= 6" & plco_clean2$dx_psa < 10 & plco_clean2$nstage=="N0" ~ "Low",
  plco_clean2$tstage!= "T3a-T4" & plco_clean2$gleason == "7" & plco_clean2$dx_psa <= 20 & plco_clean2$nstage=="N0" ~ "Intermediate",
  plco_clean2$nstage=="N0" & (plco_clean2$tstage=="T3a-T4" | plco_clean2$gleason=="8" | plco_clean2$gleason=="9" | plco_clean2$gleason=="10" | plco_clean2$dx_psa > 20) ~ "High",
  plco_clean2$nstage=="N1" | plco_clean2$nstage=="N2" ~ "Regional"
)

plco_clean2$pc_risk_group <- factor(plco_clean2$pc_risk_group, levels=c("Low", "Intermediate", "High", "Regional"), ordered = TRUE)

var_label(plco_clean2$age) <- "Age (years)"
var_label(plco_clean2$race2) <- "Race"
var_label(plco_clean2$educ) <- "Education"
var_label(plco_clean2$marital2) <- "Marital status"
var_label(plco_clean2$mortstat) <- "Outcome"
var_label(plco_clean2$permth_exm) <- "Follow-up (months)"
var_label(plco_clean2$smoker) <- "Smoking status"
var_label(plco_clean2$arthritis) <- "Arthritis"
var_label(plco_clean2$bronch) <- "Chronic bronchitis"
var_label(plco_clean2$diabetic) <- "Diabetes"
var_label(plco_clean2$emphysema) <- "Emphysema"
var_label(plco_clean2$hypertension) <- "Hypertension"
var_label(plco_clean2$mi_chd) <- "Previous heart attack, coronary heart disease"
var_label(plco_clean2$liver) <- "Liver disease"
var_label(plco_clean2$stroke) <- "Previous stroke"
var_label(plco_clean2$weight) <- "BMI category"
var_label(plco_clean2$nstage) <- "N Stage"
var_label(plco_clean2$tstage) <- "T Stage"
var_label(plco_clean2$gleason) <- "Gleason"
var_label(plco_clean2$dx_psa) <- "PSA at diagnosis"
var_label(plco_clean2$primary_tx) <- "Treatment"
var_label(plco_clean2$pc_risk_group) <- "Prostate cancer risk group"

#plco_clean2$treatrec <- case_when(
 # plco_clean2$pc_risk_group=="Low" ~ "Active surveillance",
#  plco_clean2$pc_risk_group=="Favorable intermediate" & plco_clean2$ocm_10_group=="High risk" ~ "Active surveillance",
#  plco_clean2$pc_risk_group=="Favorable intermediate" & plco_clean2$ocm_10_group=="Low risk" ~ "Radiation alone or prostatectomy",
#  plco_clean2$pc_risk_group=="Unfavorable intermediate" & plco_clean2$ocm_10_group=="High risk" ~ "Active surveillance",
#  plco_clean2$pc_risk_group=="Unfavorable intermediate" & plco_clean2$ocm_10_group=="Low risk" ~ "Radiation alone, prostatectomy, \nradiation + hormone",
  #plco_clean2$pc_risk_group=="High/very high" & plco_clean2$ocm_5_group=="High risk" ~ "Hormone alone or radiation alone",
 # plco_clean2$pc_risk_group=="High/very high" & plco_clean2$ocm_5_group=="Low risk" ~ "Prostatectomy or radiation + hormone",
 # plco_clean2$pc_risk_group=="Regional" & plco_clean2$ocm_5_group=="High risk" ~ "Active surveillance or hormone alone",
  #plco_clean2$pc_risk_group=="Regional" & plco_clean2$ocm_5_group=="Low risk" ~ "Radiation + hormone"
#)

plco_clean2$primary_tx <- factor(plco_clean2$primary_tx, levels=c("No known treatment", "Other ablative treatment", "Hormone alone", "Radiation alone", "Prostatectomy", "Radiation + hormone"), labels=c("Active surveillance", "Other ablative treatment", "Hormone alone", "Radiation alone", "Prostatectomy", "Radiation + hormone"), ordered=TRUE)

#plco_clean2$treatrec <- factor(plco_clean2$treatrec, levels=c("Active surveillance", "Radiation alone or prostatectomy", "Radiation + hormone", "Radiation alone, prostatectomy, \nradiation + hormone", "Prostatectomy or radiation + hormone"), ordered=TRUE)

#palette <- brewer.pal(8, name = "BuPu")
#recplot <- ggplot(data = plco_clean2[!is.na(plco_clean2$treatrec),], aes(x=treatrec, y = primary_tx, color = riskgroup)) + geom_point(position="jitter") + theme_bw() + theme(axis.text.x = element_text(angle = 90)) + coord_flip() + ylab("Actual treatment") + xlab("NCCN recommended treatment") + scale_color_manual(name = "OCM Risk", values = palette[4:8])

#recplot
```

\newpage

Table 4: Characteristics of 7,596 men in PLCO, grouped by years of life remaining up to 17 years.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#plco_clean2$concordance <- case_when(
 # plco_clean2$treatrec=="Active surveillance" & plco_clean2$primary_tx=="Active surveillance" ~ "Concordant",
#  plco_clean2$treatrec=="Active surveillance" & plco_clean2$primary_tx!="Active surveillance" ~ "Too aggressive",
#  plco_clean2$treatrec=="Radiation alone or prostatectomy" & (plco_clean2$primary_tx=="Radiation alone" | plco_clean2$primary_tx=="Prostatectomy") ~ "Concordant",
 # plco_clean2$treatrec=="Radiation alone or prostatectomy" & (plco_clean2$primary_tx=="Active surveillance"  | plco_clean2$primary_tx=="Other ablative treatment" | plco_clean2$primary_tx=="Hormone alone") ~ "Not aggressive enough",
 # plco_clean2$treatrec=="Radiation alone or prostatectomy" & plco_clean2$primary_tx=="Radiation + hormone" ~ "Too aggressive",
#  plco_clean2$treatrec=="Radiation + hormone" & plco_clean2$primary_tx=="Radiation + hormone" ~ "Concordant",
#  plco_clean2$treatrec=="Radiation + hormone" & (plco_clean2$primary_tx=="Active surveillance" | plco_clean2$primary_tx=="Other ablative treatment" | plco_clean2$primary_tx=="Hormone alone" | plco_clean2$primary_tx=="Radiation alone" | plco_clean2$primary_tx=="Prostatectomy") ~ "Not aggressive enough",
#  plco_clean2$treatrec=="Radiation alone, prostatectomy, \nradiation + hormone" & (plco_clean2$primary_tx=="Radiation alone" | plco_clean2$primary_tx=="Prostatectomy" | plco_clean2$primary_tx=="Radiation + hormone") ~ "Concordant",
 # plco_clean2$treatrec=="Radiation alone, prostatectomy, \nradiation + hormone" & (plco_clean2$primary_tx=="Active surveillance" | plco_clean2$primary_tx=="Other ablative treatment" | plco_clean2$primary_tx=="Hormone alone") ~ "Not aggressive enough",
#plco_clean2$treatrec=="Prostatectomy or radiation + hormone" & (plco_clean2$primary_tx=="Prostatectomy" | plco_clean2$primary_tx=="Radiation + hormone") ~ "Concordant",
#plco_clean2$treatrec=="Prostatectomy or radiation + hormone" & plco_clean2$primary_tx!="Prostatectomy" & plco_clean2$primary_tx!="Radiation + hormone" ~ "Not aggressive enough"
#)

#plco_clean2$concordance <- factor(plco_clean2$concordance, levels=c("Not aggressive enough", "Concordant", "Too aggressive"), ordered=TRUE)
#var_label(plco_clean2$concordance) <- "Treatment concordance with NCCN recs"
#var_label(plco_clean2$primary_tx) <- "Primary treatment"

plco_clean2$riskgroup2 <- case_when(
  plco_clean2$riskgroup=="< 5" | plco_clean2$riskgroup=="5-10" ~ "< 10",
  plco_clean2$riskgroup=="10+" ~ "10+"
)

table_example <- CreateTableOne(vars = c("age", "race2", "educ", "marital2", "smoker", "diabetic", "hypertension", "stroke", "weight", "nstage"), strata = "riskgroup2", includeNA = TRUE, data = plco_clean2, argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

kable(print(table_example, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(4:6, 8:12, 14:16, 18:20, 25:28, 30:33))
```

\newpage

Table 4, cont: Characteristics of 7,596 men in PLCO, grouped by years of life remaining up to 17 years.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
table_example2 <- CreateTableOne(vars = c("tstage", "gleason", "dx_psa", "pc_risk_group", "primary_tx", "mortstat"), strata = "riskgroup2", includeNA = TRUE, data = plco_clean2, argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

kable(print(table_example2, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(3:7, 9:13, 16:20, 22:27, 29:31))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 7: Distribution of treatment across PC and OC risk
palette1 <- brewer.pal(9, name = "BuPu")
palette2 <- brewer.pal(9, name = "GnBu")

cust_palette <- c(palette2[5], palette1[6], palette2[7], palette1[9])
trtplot <- ggplot(data = plco_clean2[plco_clean2$pc_risk_group!= "Regional" & !is.na(plco_clean2$pc_risk_group) & plco_clean2$primary_tx != "Other ablative treatment" & plco_clean2$primary_tx != "Hormone alone",], aes(x=pc_risk_group, y = riskgroup, color = primary_tx)) + geom_point(position="jitter" , shape=1) + theme_bw() + coord_flip() + ylab("OC Life Expectancy (Years)") + xlab("PC Mortality Risk") + scale_color_manual(name = "Treatment", values = palette1[c(3, 5, 7, 9)]) 

#trtplot

#ggsave("myplot.pdf", plot = trtplot, width = 12, height = 8)

rm(list=c("trtplot"))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 6: Distribution of treatment across PC and OC risk:
plco_clean2$pc_risk_group2 <- factor(plco_clean2$pc_risk_group, levels=c("Low", "Intermediate", "High", "Regional"), labels = c("PC Risk: Low", "PC Risk: Intermediate", "PC Risk: High", ordered = TRUE))

newplot <- ggplot(data = plco_clean2[plco_clean2$pc_risk_group!= "Regional" & !is.na(plco_clean2$pc_risk_group2) & plco_clean2$primary_tx != "Other ablative treatment" & plco_clean2$primary_tx != "Hormone alone",], aes(x=riskgroup, y = primary_tx, color = pc_risk_group)) + geom_point(position="jitter", shape = 1) + theme_bw() + facet_wrap(~pc_risk_group2, ncol = 3) + xlab("OC Life Expectancy (Years)") + ylab("Primary Treatment") + theme(legend.position = "none", text=element_text(size=12)) + scale_color_manual(values = palette1[c(5, 7, 9)]) 

#newplot

#ggsave("myplot2.pdf", plot = newplot, width = 12, height = 8)

rm(list=c("newplot"))
```

\newpage

Figure 7: Proportion of patients receiving definitive treatment (prostatectomy, radiation, or radiation + hormone therapy) grouped by OC mortality prediction and prostate cancer risk group in sample of 6,881 men from PLCO.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
plco_clean3 <- filter(plco_clean2, primary_tx != "Hormone alone", primary_tx != "Other ablative treatment")

prop_dataset <- data.frame("pc_risk_group" = c("Low", "Intermediate", "High", "Low", "Intermediate", "High"), "riskgroup" = c("<10", "<10", "<10", "10+", "10+", "10+"), "prop" = c(length(which(plco_clean3$pc_risk_group=="Low" & plco_clean3$riskgroup!="10+" & plco_clean3$primary_tx!= "Active surveillance"))/ length(which(plco_clean3$pc_risk_group=="Low" & plco_clean3$riskgroup!="10+")), length(which(plco_clean3$pc_risk_group=="Intermediate" & plco_clean3$riskgroup!="10+" & plco_clean3$primary_tx!= "Active surveillance"))/ length(which(plco_clean3$pc_risk_group=="Intermediate" & plco_clean3$riskgroup!="10+")), length(which(plco_clean3$pc_risk_group=="High" & plco_clean3$riskgroup!="10+" & plco_clean3$primary_tx!= "Active surveillance"))/ length(which(plco_clean3$pc_risk_group=="High" & plco_clean3$riskgroup!="10+")), length(which(plco_clean3$pc_risk_group=="Low" & plco_clean3$riskgroup=="10+" & plco_clean3$primary_tx!= "Active surveillance"))/ length(which(plco_clean3$pc_risk_group=="Low" & plco_clean3$riskgroup=="10+")), length(which(plco_clean3$pc_risk_group=="Intermediate" & plco_clean3$riskgroup=="10+" & plco_clean3$primary_tx!= "Active surveillance"))/ length(which(plco_clean3$pc_risk_group=="Intermediate" & plco_clean3$riskgroup=="10+")), length(which(plco_clean3$pc_risk_group=="High" & plco_clean3$riskgroup=="10+" & plco_clean3$primary_tx!= "Active surveillance"))/ length(which(plco_clean3$pc_risk_group=="High" & plco_clean3$riskgroup=="10+"))))

prop_dataset$pc_risk_group <- factor(prop_dataset$pc_risk_group, levels=c("Low", "Intermediate", "High"), ordered=TRUE)

newplot2 <- ggplot(data = prop_dataset, aes(x=pc_risk_group, y = prop*100, color = riskgroup)) + geom_point() + geom_line(aes(group = riskgroup, color = riskgroup)) + theme_bw() + xlab("PC Risk Group") + ylab("Percent Receiving Definitive Treatment") + theme(legend.position = "bottom", text=element_text(size=12)) + scale_color_manual(name = "Life Expectancy (Years)", values = c("mediumpurple4", "gray74")) + scale_y_continuous(breaks = seq(0, 100, by=20)) + coord_cartesian(ylim = c(0, 100))

newplot2

#ggsave("myplot2.pdf", plot = newplot, width = 12, height = 8)

rm(list=c("newplot2"))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Figure 10: Probability of definitive treatment across PC and OC risk, regression-based:

rm(list=c("calibration10_data", "calibration14_data", "calibration5_data", "cancer", "cox_40", "cuminc_10", "cuminc_14", "cuminc_5", "dat", "finegray_pc", "km_10_01", "km_10_03", "km_10_05", "km_10_07", "km_10_09", "km_14_01", "km_14_03", "km_14_05", "km_14_07", "km_14_09", "km_5_05", "km_5_07", "km_5_09", "km_predictions", "mydata", "mydata_nf", "plco", "plco_nf", "prop_dataset", "rforestpredict", "rmst", "rmst2", "causespecific_group", "cox40predict", "cox55predict", "cust_palette", "cutTime", "eve.cens", "eve.ocm", "eve.pcsm", "fg_covariates", "finegray_group", "finegray_predictions", "fstatus", "ftime", "group_10", "group_14", "group_5", "incs", "incs2", "palette2", "patient1", "patient2", "patient3", "patient4", "patient5", "predict_10", "predict_14", "predict_5", "times"))

plco_clean3$deftreatment <- as.numeric(plco_clean3$primary_tx!= "Active surveillance")
plco_clean3$deftreatment <- factor(plco_clean3$deftreatment, levels=c(0, 1), labels=c("Active surveillance", "Definitive treatment"))

plco_clean3$pc_risk_group <- factor(plco_clean3$pc_risk_group, levels=c("Low", "Intermediate", "High", "Regional"), ordered=FALSE)

mylogisticmodel <- glm(deftreatment ~ pc_risk_group + lifeexpectancy, data = plco_clean3[plco_clean3$pc_risk_group != "Regional",], family = "binomial")

plotdat <- data.frame("pc_risk_group" = c(rep("Low", 76), rep("Intermediate", 76), rep("High", 76)), "lifeexpectancy" = rep(seq(0, 15, by=0.2), 3))

plotdat2 <- predict(mylogisticmodel, newdata = plotdat)
plotdat$prob <- exp(plotdat2)/(1+exp(plotdat2)) 

logplot  <- ggplot(data = plotdat, aes(x=lifeexpectancy, y = prob)) + geom_line(aes(group = pc_risk_group, color = pc_risk_group)) + theme_bw() + xlab("OC Life Expectancy (Years)") + ylab("Probability of Receiving \nDefinitive Treatment") + theme(legend.position = "bottom", text=element_text(size=12)) + scale_color_manual(name = "PC Risk Group", values = palette1[c(9, 7, 5)]) 

#logplot

#ggsave("myplot2.pdf", plot = newplot, width = 12, height = 8)
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Table 5: Intensive focus on patients receiving incorrect treatment: low risk prostate cancer, high/intermediate OCM risk, aggressive treatment:

mistreat1 <- which(plco_clean2$riskgroup!="Low" & plco_clean2$pc_risk_group=="Low")

plco_clean2$correct_tx_1 <- ifelse(plco_clean2$primary_tx == "Active surveillance", "Correct", "Incorrect")

table_mistreat1 <- CreateTableOne(vars = c("age", "race2", "educ", "marital2", "smoker", "diabetic", "hypertension", "stroke", "weight", "nstage", "tstage", "gleason", "dx_psa", "pc_risk_group", "primary_tx", "mortstat"), strata = "correct_tx_1", includeNA = TRUE, data = plco_clean2[mistreat1,], argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

#kable(print(table_mistreat1, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(4:6, 8:12, 14:16, 18:20, 25:28, 30:33, 35:39, 41:45, 48:51, 53:58, 60:62))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Table 6: Intensive focus on patients receiving incorrect treatment: high risk prostate cancer, low OCM risk, weak treatment:
#mistreat2 <- which(plco_clean2$riskgroup=="Low" & plco_clean2$pc_risk_group=="High")

#plco_clean2$correct_tx_2 <- ifelse(plco_clean2$primary_tx == "Prostatectomy" | plco_clean2$primary_tx == "Radiation + hormone", "Correct", "Incorrect")

#table_mistreat2 <- CreateTableOne(vars = c("age", "race2", "educ", "marital2", "smoker", "diabetic", "hypertension", "stroke", "weight", "nstage", "tstage", "gleason", "dx_psa", "pc_risk_group", "primary_tx", "mortstat"), strata = "correct_tx_2", includeNA = TRUE, data = plco_clean2[mistreat2,], argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

#kable(print(table_mistreat2, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(4:6, 8:12, 14:16, 18:20, 25:28, 30:33, 35:39, 41:45, 48:51, 53:58, 60:62))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#Table 7: Intensive focus on patients receiving incorrect treatment: intermediate risk prostate cancer, high OCM risk, aggressive treatment:

#mistreat3 <- which(plco_clean2$riskgroup=="High" & plco_clean2$pc_risk_group=="Intermediate")
                  
#plco_clean2$correct_tx_3 <- ifelse(plco_clean2$primary_tx != "Prostatectomy" & plco_clean2$primary_tx != "Radiation + hormone" & plco_clean2$primary_tx!="Radiation alone", "Correct", "Incorrect")

#table_mistreat3 <- CreateTableOne(vars = c("age", "race2", "educ", "marital2", "smoker", "diabetic", "hypertension", "stroke", "weight", "nstage", "tstage", "gleason", "dx_psa", "pc_risk_group", "primary_tx", "mortstat"), strata = "correct_tx_3", includeNA = TRUE, data = plco_clean2[mistreat3,], argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

#kable(print(table_mistreat3, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(4:6, 8:12, 14:16, 18:20, 25:28, 30:33, 35:39, 41:45, 48:51, 53:58, 60:62))
```
