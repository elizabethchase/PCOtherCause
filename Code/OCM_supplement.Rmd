---
title: |
  \Large{Supplementary Materials: Development and Validation of the Other-Cause Comorbidity-Adjusted Mortality (OCCAM) Model for Clinical Use in Men with Prostate Cancer}
output: pdf_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(collapse=TRUE, fig.align='center', tidy=TRUE, tidy.opts=list(blank=TRUE, width.cutoff=40), warning=FALSE,message=FALSE)

rm(list=ls())

library(tidyverse)
library(gridExtra)
library(RColorBrewer)
library(tableone)
library(latex2exp)
library(labelled)
library(kableExtra)
library(survival)
library(survey)
library(randomForestSRC)
library(flexsurv)
library(pec)
library(timeROC)
library(cmprsk)

#We read in the final version of the NHANES data, saved at the end of OCM_modelbuilding.Rmd:
load("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nhanes_data_clean.RData")

#We read in the clean version of the PLCO data, saved at the end of OCM_modelvalidation.Rmd:
load("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/plco_data_clean.RData")

#Creating models for export for app:
cox_40 <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nomar <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_noeduc <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_red <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + hypertension + 
      underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

#save(list=c("cox_40", "cox_nomar", "cox_noeduc", "cox_red"), file = "modobjects.RData")

nhanes_svy <-
  svydesign(
    data = mydata,
    id =  ~ psu,
    strata =  ~ strata,
    weights =  ~ sweights,
    nest = TRUE
  )

nhanes_sub <- subset(nhanes_svy, inmodel1 == 1)
nhanes_sub4 <- subset(nhanes_svy, inmodel4 == 1)

nhanes_cox_full_wt <-
  svycoxph(
    Surv(permth_exm, mortstat) ~ scale(age, scale = FALSE) + alcoholic + anemic + 
      arthritis + asthma + bronch + diabetic + educ + emphysema + hypertension + 
      marital2 + mi + liver + race2 + smoker + stroke + underweight + overweight_ex + 
      obese + angina + chf + chd + care + hospital + highchol + insurance + kidney + 
      military + pc,
    design = nhanes_sub
  )

nhanes_cox_full_unwt <-
  coxph(
    Surv(permth_exm, mortstat) ~ scale(age, scale = FALSE) + alcoholic + anemic + 
      arthritis + asthma + bronch + diabetic + educ + emphysema + hypertension + 
      marital2 + mi + liver + race2 + smoker + stroke + underweight + overweight_ex + 
      obese + angina + chf + chd + care + hospital + highchol + insurance + kidney + 
      military + pc,
    data = mydata[mydata$inmodel1==1, ]
  )
```

## Variable Definitions

We constructed some of our variables from other NHANES variables. In particular:

1.	We defined a patient as having hypertension if they reported a previous diagnosis of hypertension or if their blood pressure reading was hypertensive (we followed standard NHANES guidelines on constructing the blood pressure reading).

2.	We defined a patient as having diabetes if they reported a previous diagnosis of diabetes or if their blood glucose met clinical criteria for diabetes.

3.	We defined a patient as having high cholesterol if they reported high cholesterol, or if their blood work met clinical criteria for high cholesterol. 

4.	We defined patients as current smokers if they had smoked 100 cigarettes in their lifetime and reported smoking cigarettes every day or some days at present; we defined patients as former smokers if they had smoked 100 cigarettes in their lifetime and reported smoking not at all at present; we defined patients as never smokers if they had not smoked 100 cigarettes in their lifetime. 

5.	We defined being overweight as having BMI greater than or equal to 25 and less than 40 and being obese as having BMI greater than or equal to 40.

6.	We collapsed marital status into three categories: married if the patient was currently married or living with a partner, separated if the patient was widowed, divorced, or separated from their partner, and single if the patient had never married.

7.	We collapsed race into non-Hispanic white, non-Hispanic black, and all other races. 

For all other variables, we used unmodified results from the NHANES questionnaires about demographics, health insurance, health care access, mental health, and medical history. For more information on variable definition and construction, please see the repository posted at: https://github.com/blindedforreview/PCOtherCause. 

\newpage
## Supplementary Findings

\newpage
eFigure 1: Forest plot comparing the effect sizes of predictors from the unweighted and survey weighted versions of our first candidate model based on all predictors, fit in the NHANES training cohort of 7,369 men. 
```{r, fig.align="center", fig.height=6, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
table_model <- summary(nhanes_cox_full_unwt)$conf.int
table_model_wt <- summary(nhanes_cox_full_wt)$conf.int

cox_plotdata <- data.frame("Variable" = c("Age (per 1 year)", "Alcohol abuse (ref: no alcohol abuse)", "Anemia (ref: no anemia)", "Arthritis (ref: no arthritis)", "Asthma (ref: no asthma)", "Chronic bronchitis (ref: no chronic bronchitis)", "Diabetes (ref: no diabetes)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Emphysema (ref: no emphysema)", "Hypertension (ref: no hypertension)", "Separated (ref: married)", "Single (ref: married)", "Previous myocardial infarction (ref: no previous MI)", "Liver disease (ref: no liver disease)", "White race (ref: Black race)", "Other race (ref: Black race)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)", "Underweight, BMI <18.5 (ref: BMI 18.5-25)", "Overweight, BMI 25-40 (ref: BMI 18.5-25)", "Obese, BMI 40+ (ref: BMI 18.5-25)", "Angina (ref: no angina)", "Congestive heart failure (ref: no CHF)", "Coronary heart disease (ref: no CHD)", "Regular primary care (ref: no regular primary care)", "Hospitalized in last year (ref: not hospitalized in last year)", "High cholesterol (ref: normal cholesterol)", "Health insured (ref: uninsured)", "Kidney disease (ref: no kidney disease)", "No previous military service (ref: veteran)", "Prostate cancer (ref: no prostate cancer)"), "Effect" = c(table_model[,1], table_model_wt[,1]), "Lower" = c(table_model[,3], table_model_wt[,3]), "Upper" = c(table_model[,4], table_model_wt[,4]), "Label" = c(paste(round(table_model[,1], digits=2), " (", round(table_model[,3], digits=2), ",", round(table_model[,4], digits=2), ")", sep=""), paste(round(table_model_wt[,1], digits=2), " (", round(table_model_wt[,3], digits=2), ",", round(table_model_wt[,4], digits=2), ")", sep="")), "Model" = c(rep("Unweighted", 35), rep("Weighted", 35)))

cox_plotdata$Variable <- factor(cox_plotdata$Variable, levels= c("Age (per 1 year)", "Alcohol abuse (ref: no alcohol abuse)", "Anemia (ref: no anemia)", "Arthritis (ref: no arthritis)", "Asthma (ref: no asthma)", "Chronic bronchitis (ref: no chronic bronchitis)", "Diabetes (ref: no diabetes)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Emphysema (ref: no emphysema)", "Hypertension (ref: no hypertension)", "Separated (ref: married)", "Single (ref: married)", "Previous myocardial infarction (ref: no previous MI)", "Liver disease (ref: no liver disease)", "White race (ref: Black race)", "Other race (ref: Black race)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)", "Underweight, BMI <18.5 (ref: BMI 18.5-25)", "Overweight, BMI 25-40 (ref: BMI 18.5-25)", "Obese, BMI 40+ (ref: BMI 18.5-25)", "Angina (ref: no angina)", "Congestive heart failure (ref: no CHF)", "Coronary heart disease (ref: no CHD)", "Regular primary care (ref: no regular primary care)", "Hospitalized in last year (ref: not hospitalized in last year)", "High cholesterol (ref: normal cholesterol)", "Health insured (ref: uninsured)", "Kidney disease (ref: no kidney disease)", "No previous military service (ref: veteran)", "Prostate cancer (ref: no prostate cancer)"), ordered=TRUE)

adj_plot <- ggplot(cox_plotdata, aes(x = fct_rev(Variable), y = log(Effect), group = Model, color = Model)) + geom_point(position = position_dodge(width = 0.5)) + geom_errorbar(aes(ymin=log(Lower), ymax=log(Upper), width=0.1), position = position_dodge(width = 0.5)) + coord_flip() + labs(y = "Hazard Ratio and 95% CI", x = "", caption=TeX('Protective $\\leftarrow \\rightarrow$ Harmful' )) + geom_hline(yintercept=0, linetype="dashed", color = "black") + theme(panel.background = element_rect(fill="white"), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), legend.position="bottom", plot.caption = element_text(hjust = 0.3)) + scale_y_continuous(breaks=log(c(0.25, 0.5, 1, 2, 4)), labels=c("0.25", "0.5", "1.0", "2.0", "4.0")) + scale_color_manual(values = c("mediumpurple4", "gray74"))
 
adj_plot

ggsave("forest_plot_full.pdf", adj_plot)
rm(list=c("adj_plot", "cox_plotdata", "table_model"))
```

\newpage
eFigure 2: Forest plot comparing the effect sizes of predictors from the unweighted and survey weighted versions of OCCAM fit in the NHANES training cohort of 7,369 men. The model also includes interactions between age and diabetes, education, hypertension, and stroke. 
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
table_model <- summary(cox_40)$conf.int
table_model[1, 1] <- exp(10*log(table_model[1, 1]))
table_model[1, 3] <- exp(10*log(table_model[1, 3]))
table_model[1, 4] <- exp(10*log(table_model[1, 4]))
table_model[17:23, c(1, 3, 4)] <- exp(10*log(table_model[17:23, c(1, 3, 4)]))

nhanes_svy <-
  svydesign(
    data = mydata,
    id =  ~ psu,
    strata =  ~ strata,
    weights =  ~ sweights,
    nest = TRUE
  )
nhanes_sub4 <- subset(nhanes_svy, inmodel4 == 1)

cox_40_wt <-
  svycoxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    design = nhanes_sub4)

table_model_wt <- summary(cox_40_wt)$conf.int
table_model_wt[1, 1] <- exp(10*log(table_model_wt[1, 1]))
table_model_wt[1, 3] <- exp(10*log(table_model_wt[1, 3]))
table_model_wt[1, 4] <- exp(10*log(table_model_wt[1, 4]))
table_model_wt[17:23, c(1, 3, 4)] <- exp(10*log(table_model_wt[17:23, c(1, 3, 4)]))

cox_plotdata <- data.frame("Variable" = c("Age (per 10 years)", "Diabetes (ref: no diabetes)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Hypertension (ref: no hypertension)", "Separated (ref: married)", "Single (ref: married)", "BMI <18.5 (ref: BMI 18.5-25)", "BMI 25-40 (ref: BMI 18.5-25)", "BMI 40+ (ref: BMI 18.5-25)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)",  "Prostate cancer (ref: no prostate cancer)", "Age (per 10 years)*Diabetes", "Age (per 10 years)*9th-11th Grade", "Age (per 10 years)*High School", "Age (per 10 years)*Some College", "Age (per 10 years)*College", "Age (per 10 years)*Hypertension", "Age (per 10 years)*Stroke"), "Effect" = c(table_model[,1], table_model_wt[,1]), "Lower" = c(table_model[,3], table_model_wt[,3]), "Upper" = c(table_model[,4], table_model_wt[,4]), "Label" = c(paste(round(table_model[,1], digits=2), " (", round(table_model[,3], digits=2), ",", round(table_model[,4], digits=2), ")", sep=""), paste(round(table_model_wt[,1], digits=2), " (", round(table_model_wt[,3], digits=2), ",", round(table_model_wt[,4], digits=2), ")", sep="")), "Model" = c(rep("Unweighted", 23), rep("Weighted", 23)))

cox_plotdata$Variable <- factor(cox_plotdata$Variable, levels= c("Age (per 10 years)", "Diabetes (ref: no diabetes)", "9th-11th Grade (ref: < 9th grade)", "High School (ref: < 9th grade)", "Some College (ref: < 9th grade)", "College (ref: < 9th grade)", "Hypertension (ref: no hypertension)", "Separated (ref: married)", "Single (ref: married)", "BMI <18.5 (ref: BMI 18.5-25)", "BMI 25-40 (ref: BMI 18.5-25)", "BMI 40+ (ref: BMI 18.5-25)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)",  "Prostate cancer (ref: no prostate cancer)", "Age (per 10 years)*Diabetes", "Age (per 10 years)*9th-11th Grade", "Age (per 10 years)*High School", "Age (per 10 years)*Some College", "Age (per 10 years)*College", "Age (per 10 years)*Hypertension", "Age (per 10 years)*Stroke"), ordered=TRUE)

adj_plot <- ggplot(cox_plotdata, aes(x = fct_rev(Variable), y = log(Effect), group = Model, color = Model)) + geom_point(position = position_dodge(width = 0.5)) + geom_errorbar(aes(ymin=log(Lower), ymax=log(Upper), width=0.1), position = position_dodge(width = 0.5)) + coord_flip() + labs(y = "Hazard Ratio and 95% CI", x = "", caption=TeX('Protective $\\leftarrow \\rightarrow$ Harmful' )) + geom_hline(yintercept=0, linetype="dashed", color = "black") + theme(panel.background = element_rect(fill="white"), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), legend.position="bottom", plot.caption = element_text(hjust = 0.3)) + scale_y_continuous(breaks=log(c(0.25, 0.5, 1, 2, 4)), labels=c("0.25", "0.5", "1.0", "2.0", "4.0")) + scale_color_manual(values = c("mediumpurple4", "gray74"))
 
adj_plot

ggsave("forest_plot_weighted.pdf", adj_plot)
rm(list=c("adj_plot", "cox_plotdata", "table_model"))
```

\newpage 

eFigure 2: Externally validated time-dependent area-under-the-curves (AUCs) at 5, 10, and 15 years of our other-cause comorbidity-adjusted mortality (OCCAM) model, the Social Security Administration 2001 actuarial life table predictions (SSA), and the National Vital Statistics System's 2001 life expectancy predictions (NVSS). Models were validated in the Prostate, Lung, Colon, and Ovarian Cancer Screening Trial (PLCO) cohort of 8,220 men with prostate cancer.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE, cache = TRUE, eval = TRUE}
cox_age <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

times <- seq(60, 180, by=60)

plco_clean$permth_exm2 <- case_when(
  plco_clean$mortstat2==2 ~ 100000,
  plco_clean$mortstat2!= 2 ~ plco_clean$permth_exm
)

ssa <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/ssa_2000.csv")
ssa$age <- seq(0, 119, by = 1)

nvss_black <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_blackmales_2001.csv")
nvss_white <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_whitemales_2001.csv")
nvss_other <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_allmales_2001.csv")
nvss_other <- nvss_other[-102,]

nvss <- data.frame("Age" = seq(0, 100, by = 1), "White" = nvss_white$Expectancy, "Black" = nvss_black$Expectancy, "Other" = nvss_other$Expectancy)

plco_clean$ssa <- NA
plco_clean$nvss <- NA
for (i in 1:nrow(plco_clean)){
  plco_clean$ssa[i] <- ssa$Expectancy[which(ssa$age==plco_clean$age[i])]
  if (plco_clean$race2[i]=="NHW"){
    plco_clean$nvss[i] <- nvss$White[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="NHB"){
    plco_clean$nvss[i] <- nvss$Black[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="Other"){
    plco_clean$nvss[i] <- nvss$Other[which(nvss$Age==plco_clean$age[i])]
  }
}
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE, cache = TRUE, eval = TRUE}
#cox40_plco <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + marital2 + underweight + overweight2 + obese2 + smoker + stroke + age_ctr_40*diabetic + age_ctr_40*educ + age_ctr_40*hypertension + age_ctr_40*stroke + pc, data=plco_clean, eval.times = times)

cox40predict <- predict(object=cox_40, newdata = plco_clean, type="lp")
coxagepredict <- predict(object=cox_age, newdata = plco_clean, type="lp")

cox40roc_cs <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = cox40predict,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

cox40roc_cs_ci <- confint(cox40roc_cs)

coxageroc_cs <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = coxagepredict,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

coxageroc_cs_ci <- confint(coxageroc_cs)

cox40roc_cr <-
  timeROC(
    T = plco_clean$permth_exm2,
    delta = plco_clean$mortstat,
    marker = cox40predict,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

cox40roc_cr_ci <- confint(cox40roc_cr)

coxageroc_cr <-
  timeROC(
    T = plco_clean$permth_exm2,
    delta = plco_clean$mortstat,
    marker = coxagepredict,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

coxageroc_cr_ci <- confint(coxageroc_cr)

ssa_roc_cs <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$ssa,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

ssa_cs_ci <- confint(ssa_roc_cs)

ssa_roc_cr <-
  timeROC(
    T = plco_clean$permth_exm2,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$ssa,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

ssa_cr_ci <- confint(ssa_roc_cr)

nvss_roc_cs <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$nvss,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

nvss_roc_cs_ci <- confint(nvss_roc_cs)

nvss_roc_cr <-
  timeROC(
    T = plco_clean$permth_exm2,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$nvss,
    cause = 1,
    weighting = "marginal",
    times = times,
    iid = TRUE
  )

nvss_roc_cr_ci <- confint(nvss_roc_cr)

subperf <- data.frame("Model" = rep(c("OCCAM", "Age Model", "SSA", "NVSS"), 6), "Metric" = c(rep("CS", 12), rep("CR", 12)), "Year" = c(rep(5, 4), rep(10, 4), rep(15, 4)), "AUC" = c(cox40roc_cs$AUC[1], coxageroc_cs$AUC[1], ssa_roc_cs$AUC[1], nvss_roc_cs$AUC[1], cox40roc_cs$AUC[2], coxageroc_cs$AUC[2], ssa_roc_cs$AUC[2], nvss_roc_cs$AUC[2], cox40roc_cs$AUC[3], coxageroc_cs$AUC[3], ssa_roc_cs$AUC[3], nvss_roc_cs$AUC[3], cox40roc_cr$AUC[1], coxageroc_cr$AUC[1], ssa_roc_cr$AUC[1], nvss_roc_cr$AUC[1], cox40roc_cr$AUC[2], coxageroc_cr$AUC[2], ssa_roc_cr$AUC[2], nvss_roc_cr$AUC[2], cox40roc_cr$AUC[3], coxageroc_cr$AUC[3], ssa_roc_cr$AUC[3], nvss_roc_cr$AUC[3]), "Lower" = c(cox40roc_cs_ci$CB_AUC[1,1], coxageroc_cs_ci$CB_AUC[1,1], ssa_cs_ci$CB_AUC[1,1], nvss_roc_cs_ci$CB_AUC[1,1], cox40roc_cs_ci$CB_AUC[2,1], coxageroc_cs_ci$CB_AUC[2,1], ssa_cs_ci$CB_AUC[2,1], nvss_roc_cs_ci$CB_AUC[2,1], cox40roc_cs_ci$CB_AUC[3,1], coxageroc_cs_ci$CB_AUC[3,1], ssa_cs_ci$CB_AUC[3,1], nvss_roc_cs_ci$CB_AUC[3,1]), "Upper" = c(cox40roc_cs_ci$CB_AUC[1,2], coxageroc_cs_ci$CB_AUC[1,2], ssa_cs_ci$CB_AUC[1,2], nvss_roc_cs_ci$CB_AUC[1,2], cox40roc_cs_ci$CB_AUC[2,2], coxageroc_cs_ci$CB_AUC[2,2], ssa_cs_ci$CB_AUC[2,2], nvss_roc_cs_ci$CB_AUC[2,2], cox40roc_cs_ci$CB_AUC[3,2], coxageroc_cs_ci$CB_AUC[3,2], ssa_cs_ci$CB_AUC[3,2], nvss_roc_cs_ci$CB_AUC[3,2]))
                      
#aucplot <- ggplot(data = subperf, aes (x = Year, y = AUC, group = Model, color = Model)) + geom_point() + geom_line() + geom_errorbar(aes(ymin = Lower/100, ymax = Upper/100, width = 0.05)) + facet_grid(~Metric) + ylab("IPCW Time-Dependent AUC") + xlab("Time (Years)") + scale_x_continuous(breaks = c(0, 5, 10, 15)) + theme_bw() + scale_color_manual(values = c("mediumpurple4", "darkblue", "gray74", "darkred"))
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE, eval = TRUE}
subperf$Model <- factor(subperf$Model, levels=c("OCCAM", "NVSS", "SSA", "Age Model"), ordered = TRUE)

aucplot <- ggplot(data = subperf[subperf$Metric=="CS" & subperf$Model != "Age Model",], aes (x = Year, y = AUC, group = Model, color = Model)) + geom_point(position = position_dodge(width = 0.4)) + geom_line() + geom_errorbar(aes(ymin = Lower/100, ymax = Upper/100, width = 0.05), position = position_dodge(width = 0.4)) + ylab("IPCW Time-Dependent AUC") + xlab("Time (Years)") + scale_x_continuous(breaks = c(0, 5, 10, 15)) + theme_bw() + scale_color_manual(values = c("darkred", "mediumpurple4", "grey74")) + scale_y_continuous(breaks = c(0.5, 0.75, 1)) + coord_cartesian(ylim = c(0.5, 1))

aucplot

ggsave("auc_performance.pdf", aucplot)

hyp_test <- compare(cox40roc_cs, ssa_roc_cs, adjusted = TRUE)
hyp_test

hyp_testa <- compare(cox40roc_cs, nvss_roc_cs, adjusted = TRUE)
hyp_testa

hyp_test2 <- compare(cox40roc_cr, ssa_roc_cr, adjusted = TRUE)
hyp_test2

hyp_test2a <- compare(cox40roc_cr, nvss_roc_cr, adjusted = TRUE)
hyp_test2a

rm(list=c("cox40roc_cs", "cox40roc_cr", "coxageroc_cs", "coxageroc_cr", "ssa_roc_cs", "ssa_roc_cr", "nvss_roc_cs", "nvss_roc_cr", "subperf", "cox40roc_cs_ci", "cox40roc_cr_ci", "coxageroc_cs_ci", "coxageroc_cr_ci", "ssa_roc_cs_ci", "ssa_roc_cr_ci", "nvss_roc_cs_ci", "nvss_roc_cr_ci", "aucplot"))
```

\newpage

eFigure 3: Calibration performance of other-cause comorbidity-adjusted mortality (OCCAM) model and the Social Security Administration's 2001 actuarial life table predictions (SSA) in the Prostate, Lung, Colon, and Ovarian Cancer Screening Trial (PLCO) cohort of 8,220 men with prostate cancer.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
km_predictions <- survfit(cox_40, plco_clean)
myfunc <- function(x, time){
  inds <- which(x-0.5 <= 0)
  if (identical(inds, integer(0))){
    mytime <- 202
  } else{
    mytime <- time[min(inds)]
  }
  return(mytime)
}
medsurv <- apply(X = km_predictions$surv, MARGIN = 2, FUN = myfunc, time = km_predictions$time)
medsurv2 <- data.frame(medsurv)

plco_clean$medsurv <- medsurv2$medsurv

cox_group <- case_when(
  plco_clean$medsurv < 60 ~ 2.5,
  plco_clean$medsurv >= 60 & plco_clean$medsurv < 84 ~ 6,
  plco_clean$medsurv >= 84 & plco_clean$medsurv < 120 ~ 8.5,
  plco_clean$medsurv >= 120 & plco_clean$medsurv < 144 ~ 11,
  plco_clean$medsurv >= 144 & plco_clean$medsurv < 180 ~ 13.5,
  plco_clean$medsurv >= 180 ~ 15
)

ssa_group <- case_when(
  plco_clean$ssa < 5 ~ 2.5,
  plco_clean$ssa >= 5 & plco_clean$ssa < 7 ~ 6,
  plco_clean$ssa >= 7 & plco_clean$ssa < 10 ~ 8.5,
  plco_clean$ssa >= 10 & plco_clean$ssa < 12 ~ 11,
  plco_clean$ssa >= 12 & plco_clean$ssa < 15 ~ 13.5,
  plco_clean$ssa >= 15 ~ 15
)

cox_5 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$time))
ssa_5 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$time))
cox_7 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$time))
ssa_7 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$time))
cox_10 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$time))
ssa_10 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$time))
cox_12 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$time))
ssa_12 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$time))
cox_15 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$time))
ssa_15 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$time))
cox_15p <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$time))
ssa_15p <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$time))

cox_5l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$time))
ssa_5l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$time))
cox_7l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$time))
ssa_7l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$time))
cox_10l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$time))
ssa_10l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$time))
cox_12l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$time))
ssa_12l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$time))
cox_15l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$time))
ssa_15l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$time))
cox_15pl <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$time))
ssa_15pl <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$time))

cox_5u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$time))
ssa_5u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$time))
cox_7u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$time))
ssa_7u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$time))
cox_10u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$time))
ssa_10u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$time))
cox_12u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$time))
ssa_12u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$time))
cox_15u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$time))
ssa_15u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$time))
cox_15pu <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$time))
ssa_15pu <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$time))

calibration_data <- data.frame("Time" = rep(c(2.5, 6, 8.5, 11, 13.5, 15), 2), "Model" = c(rep("OCCAM", 6), rep("SSA", 6)), "Observed" = c(cox_5$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_7$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_10$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_12$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15p$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., ssa_5$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_7$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_10$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_12$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15p$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group....)/12, "Lower" = c(cox_5l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_7l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_10l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_12l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15pl$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., ssa_5l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_7l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_10l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_12l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15pl$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group....)/12, "Upper" = c(cox_5u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_7u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_10u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_12u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15pu$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., ssa_5u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_7u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_10u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_12u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15pu$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group....)/12)

calibration_data[calibration_data==202/12] <- 25

#myplot <- ggplot() + geom_line(data = calibration_data, aes(x=Time, y=Observed, 
                  #                                              group = Model, 
                #                                                color = Model)) +
 # geom_errorbar(data = calibration_data, aes(x = Time, ymin = Lower, ymax = Upper, group = Model, color = Model, width = 0.5)) + 
#  scale_x_continuous(name = "Predicted Life Expectancy", 
#                     breaks = seq(2, 16, by=3)) + 
#  scale_y_continuous(name = "Observed Life Expectancy", 
#                     breaks = seq(2, 23, by=3)) + theme_bw() + 
 # geom_abline(slope = 1, intercept = 0) + scale_color_manual(values = c("darkred", "mediumpurple4", "grey74"), name = "Model") + theme(legend.position = "bottom") + coord_cartesian(ylim = c(2, 23), xlim = c(2,16))

calibration_data$Time[calibration_data$Model=="OCCAM"] <- calibration_data$Time[calibration_data$Model=="OCCAM"] + 0.2

myplot <- ggplot() + geom_line(data = calibration_data, aes(x=Time, y=Observed, 
                                                                group = Model, 
                                                                color = Model)) +
  geom_errorbar(data = calibration_data, aes(x = Time, ymin = Lower, ymax = Upper, group = Model, color = Model, width = 0.5)) + 
  scale_x_continuous(name = "Predicted Life Expectancy", 
                     breaks = seq(2, 16, by=3)) + 
  scale_y_continuous(name = "Observed Life Expectancy", 
                     breaks = seq(2, 26, by=3)) + theme_bw() + 
  geom_abline(slope = 1, intercept = 0) + theme(legend.position = "bottom") + scale_color_manual(values = c("mediumpurple4", "darkred")) + coord_cartesian(ylim = c(2, 26), xlim = c(2,16)) 

myplot

ggsave("calibration_plot.pdf", myplot)

rm(list=c("myplot", "ssa_5", "ssa_5l", "ssa_5u", "ssa_7", "ssa_7l", "ssa_7u", "ssa_10", "ssa_10l", "ssa_10u", "ssa_12", "ssa_12u", "ssa_12l", "ssa_15", "ssa_15u", "ssa_15l", "ssa_15p", "ssa_15pl", "ssa_15pu", "ssa_5", "ssa_5l", "ssa_5u", "ssa_7", "ssa_7l", "ssa_7u", "ssa_10", "ssa_10l", "ssa_10u", "ssa_12", "ssa_12u", "ssa_12l", "ssa_15", "ssa_15u", "ssa_15l", "ssa_15p", "ssa_15pl", "ssa_15pu"))
```

eTable 1: Cause-specific and competing-risks time-dependent AUCs of OCCAM in the Prostate, Lung, Colon, and Ovarian Cancer Screening Trial (PLCO) validation cohort of 8,220 men.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#And now we obtain estimates of the C-index and time-dependent AUC from our model in the main treatment groups: prostatectomy, radiation, and radiation + hormone:
times <- seq(6, 180, by=6)

roc_css <- timeROC(T = plco_clean$permth_exm, delta = plco_clean$mortstat, marker = plco_clean$linpred, cause = 1, weighting="marginal", times = times)

plco_clean$permth_exm2 <- case_when(
  plco_clean$mortstat2==2 ~ 100000,
  plco_clean$mortstat2!= 2 ~ plco_clean$permth_exm
)

roc_cr <- timeROC(T = plco_clean$permth_exm2, delta = plco_clean$mortstat, marker = plco_clean$linpred, cause = 1, weighting="marginal", times = times)

subperf_trt <- data.frame("Metric" = c("Cause-Specific AUC", "Competing-Risks AUC"), "Year5" = round(c(roc_css$AUC[10], roc_cr$AUC[10]), digits=2), "Year10" = round(c(roc_css$AUC[20], roc_cr$AUC[20]), digits=2), "Year15" = round(c(roc_css$AUC[30], roc_cr$AUC[30]), digits=2))

rownames(subperf_trt) <- NULL
kable(subperf_trt, col.names = c("Metric", "5 Years", "10 Years", "15 Years")) %>% column_spec(column = 1, width = "3cm") %>% column_spec(column = 2:4, width = "1.75cm")
```

\newpage
eTable 2: Time-dependent AUC of OCCAM in the three main treatment groups in the Prostate, Lung, Colon, and Ovarian Cancer Screening Trial (PLCO) validation cohort of 8,220 men.
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#And now we obtain estimates of the C-index and time-dependent AUC from our model in the main treatment groups: prostatectomy, radiation, and radiation + hormone:
times <- seq(6, 180, by=6)

cox40predict_prostatectomy <- predict(object=cox_40, newdata = plco_clean[plco_clean$primary_tx=="Prostatectomy",], type="lp")

cox40predict_radiation <- predict(object=cox_40, newdata = plco_clean[plco_clean$primary_tx=="Radiation alone",], type="lp")

cox40predict_rtadt <- predict(object=cox_40, newdata = plco_clean[plco_clean$primary_tx=="Radiation + hormone",], type="lp")

prostatectomy_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Prostatectomy"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Prostatectomy"], marker = cox40predict_prostatectomy, cause = 1, weighting="marginal", times = times)

radiation_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Radiation alone"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation alone"], marker = cox40predict_radiation, cause = 1, weighting="marginal", times = times)

rtadt_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Radiation + hormone"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation + hormone"], marker = cox40predict_rtadt, cause = 1, weighting="marginal", times = times)

plco_clean$permth_exm2 <- case_when(
  plco_clean$mortstat2==2 ~ 100000,
  plco_clean$mortstat2!= 2 ~ plco_clean$permth_exm
)

prostatectomy_roc_cr <- timeROC(T = plco_clean$permth_exm2[plco_clean$primary_tx=="Prostatectomy"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Prostatectomy"], marker = cox40predict_prostatectomy, cause = 1, weighting="marginal", times = times)

radiation_roc_cr <- timeROC(T = plco_clean$permth_exm2[plco_clean$primary_tx=="Radiation alone"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation alone"], marker = cox40predict_radiation, cause = 1, weighting="marginal", times = times)

rtadt_roc_cr <- timeROC(T = plco_clean$permth_exm2[plco_clean$primary_tx=="Radiation + hormone"], delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation + hormone"], marker = cox40predict_rtadt, cause = 1, weighting="marginal", times = times)

subperf_trt <- data.frame("Treatment" = c("Prostatectomy", "Radiation alone", "Radiation + hormone"), "Year5_AUC_CSS" = round(c(prostatectomy_roc_css$AUC[10], radiation_roc_css$AUC[10], rtadt_roc_css$AUC[10]), digits=2), "Year10_AUC_CSS" = round(c(prostatectomy_roc_css$AUC[20], radiation_roc_css$AUC[20],rtadt_roc_css$AUC[20]), digits=2), "Year15_AUC_CSS" = round(c(prostatectomy_roc_css$AUC[30], radiation_roc_css$AUC[30], rtadt_roc_css$AUC[30]), digits=2), "Year5_AUC_CR" = round(c(prostatectomy_roc_cr$AUC[10], radiation_roc_cr$AUC[10], rtadt_roc_cr$AUC[10]), digits=2), "Year10_AUC_CR" = round(c(prostatectomy_roc_cr$AUC[20], radiation_roc_cr$AUC[20],rtadt_roc_cr$AUC[20]), digits=2), "Year15_AUC_CR" = round(c(prostatectomy_roc_cr$AUC[30], radiation_roc_cr$AUC[30], rtadt_roc_cr$AUC[30]), digits=2))

rownames(subperf_trt) <- NULL
kable(subperf_trt, col.names = c("Treatment", "5 Years", "10 Years", "15 Years", "5 Years", "10 Years", "15 Years")) %>%
add_header_above(c(" ", "Cause-Specific AUC" = 3, "Competing-Risks AUC" = 3), escape=FALSE) %>% column_spec(column = 1, width = "3cm") %>% column_spec(column = 2:7, width = "1.75cm")

#subperf_trt <- subperf_trt[,1:4]
#kable(subperf_trt, col.names = c("Treatment", "5 Years", "10 Years", "15 Years")) %>%
#column_spec(column = 1, width = "3cm") %>% column_spec(column = 2:7, width = "1.75cm")

rm(list=c("subperf_trt", "cox40predict_prostatectomy", "cox40predict_radiation", "cox40predict_rtadt", "radiation_roc", "prostatectomy_roc", "rtadt_roc", "cox40_radiation", "cox40_rtadt", "cox40_prostatectomy"))
```

\newpage
eTable 3: Characteristics of a cohort of 7,596 men from the Prostate, Lung, Colorectal, and Ovarian Cancer Screening Trial, grouped by OCCAM-predicted median survival time. 
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE, eval = FALSE}
#Figure 6: Treatment concordance with OCM predictions:
prostatedata <- read_csv("~/Box/PLCO Data/Prostate/pros_data_nov18_d070819.csv.zip")
cancer <- filter(prostatedata, pros_cancer == 1)
rm(list = c("prostatedata"))

#We filter to the list of variables we need for validation:
plco <-
  select(
    cancer,
    race7,
    pros_exitage,
    diabetes_f,
    hyperten_f,
    stroke_f,
    arthrit_f,
    bronchit_f,
    emphys_f,
    hearta_f,
    liver_comorbidity,
    educat,
    marital,
    cig_stat,
    bmi_curr,
    is_dead_with_cod,
    mortality_exitdays,
    pros_exitdays,
    f_dthp,
    primary_trtp,
    pros_stage_n, 
    pros_stage_t, 
    pros_gleason, 
    dx_psa
  )

plco$nstage <- case_when(
  plco$pros_stage_n==0 ~ "N0",
  plco$pros_stage_n==100 ~ "N1",
  plco$pros_stage_n==200 ~ "N2",
  plco$pros_stage_n==999 ~ "NX"
)

plco$tstage <- case_when(
  plco$pros_stage_t==0 ~ "T0",
  plco$pros_stage_t==100 | plco$pros_stage_t==110 | plco$pros_stage_t==120 | plco$pros_stage_t==130 | plco$pros_stage_t==210 ~ "T1-T2a",
  plco$pros_stage_t==200 | plco$pros_stage_t==220 | plco$pros_stage_t==230 ~ "T2b-T2c",
  plco$pros_stage_t==300 | plco$pros_stage_t==310 | plco$pros_stage_t==320 | plco$pros_stage_t==330 | plco$pros_stage_t==400 | plco$pros_stage_t==410 | plco$pros_stage_t==420 ~ "T3a-T4",
  plco$pros_stage_t==999 ~ "TX"
)

plco$gleason <- case_when(
  plco$pros_gleason <= 6 ~ "<= 6",
  plco$pros_gleason == 7 ~ "7",
  plco$pros_gleason ==8 ~ "8",
  plco$pros_gleason ==9 ~ "9",
  plco$pros_gleason == 10 ~ "10",
  plco$pros_gleason == 99 ~ NA_character_
)

#We define derived variables:
plco$race2 <- case_when(
  plco$race7 == 1 ~ "NHW",
  plco$race7 == 2 ~ "NHB",
  plco$race7 >= 3 & plco$race7 <= 6 ~ "Other",
  plco$race7 == 7 ~ NA_character_
)

plco$educ <- case_when(
  plco$educat == 1 ~ "Less than 9th grade",
  plco$educat == 2 ~ "9th-11th grade",
  plco$educat == 3 ~ "HS graduate",
  plco$educat == 4 | plco$educat == 5 ~ "Some college",
  plco$educat == 6 | plco$educat == 7 ~ "College graduate",
  is.na(plco$educat) ~ NA_character_
)

plco$marital2 <- case_when(
  plco$marital == 1 ~ "Married",
  plco$marital == 2 |
    plco$marital == 3 | plco$marital == 4 ~ "Separated",
  plco$marital == 5 ~ "Single",
  is.na(plco$marital) ~ NA_character_
)

plco$smoker <- case_when(plco$cig_stat == 0 ~ "Never",
                         plco$cig_stat == 1 ~ "Current",
                         plco$cig_stat == 2 ~ "Former")

plco$primary_tx <- case_when(
  plco$primary_trtp == 0 ~ "No cancer",
  plco$primary_trtp == 1 ~ "Prostatectomy",
  plco$primary_trtp == 2 ~ "Radiation alone",
  plco$primary_trtp == 3 ~ "Radiation + hormone",
  plco$primary_trtp == 4 ~ "Hormone alone",
  plco$primary_trtp == 5 ~ "Other ablative treatment",
  plco$primary_trtp == 6 ~ "No known treatment",
  plco$primary_trtp == 10 ~ NA_character_
)

plco$underweight <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr < 18.5,
                                          1, 0))
plco$overweight2 <-
  ifelse(is.na(plco$bmi_curr),
         NA,
         ifelse(plco$bmi_curr >= 25
                &
                  plco$bmi_curr < 40,
                1, 0))
plco$obese2 <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 40, 1, 0))
plco$overweight_ex <-
  ifelse(is.na(plco$bmi_curr),
         NA,
         ifelse(plco$bmi_curr >= 25
                &
                  plco$bmi_curr < 30,
                1, 0))
plco$obese <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 30, 1, 0))

plco$mortstat <- case_when(
  plco$is_dead_with_cod == 1 & plco$f_dthp == 0 ~ 1,
  plco$is_dead_with_cod == 1 & plco$f_dthp == 1 ~ 0,
  plco$is_dead_with_cod == 0 ~ 0
)

plco$mortstat2 <- case_when(
  plco$is_dead_with_cod == 1 & plco$f_dthp == 0 ~ 1,
  plco$is_dead_with_cod == 1 & plco$f_dthp == 1 ~ 2,
  plco$is_dead_with_cod == 0 ~ 0
)

plco$permth_exm <-
  round((plco$mortality_exitdays - plco$pros_exitdays) / 30)

#We select variables and do necessary renaming
plco_clean2 <- mutate(
  plco,
  age = pros_exitage,
  diabetic = diabetes_f,
  hypertension = hyperten_f,
  stroke = stroke_f,
  arthritis = arthrit_f,
  bronch = bronchit_f,
  emphysema = emphys_f,
  mi_chd = hearta_f,
  liver = liver_comorbidity,
  pc = 1
) %>%
  select(
    race2,
    age,
    diabetic,
    hypertension,
    stroke,
    arthritis,
    bronch,
    emphysema,
    mi_chd,
    liver,
    educ,
    marital2,
    smoker,
    underweight,
    overweight2,
    obese2,
    overweight_ex,
    obese,
    pc,
    mortstat,
    mortstat2,
    permth_exm,
    primary_tx,
    nstage,
    tstage,
    gleason,
    dx_psa
  )

#We define factors:
plco_clean2$race2 <- factor(plco_clean2$race2)
plco_clean2$educ <- factor(plco_clean2$educ, levels = c("Less than 9th grade", "9th-11th grade", "HS graduate", "Some college", "College graduate"), ordered=TRUE)
plco_clean2$marital2 <- factor(plco_clean2$marital2)
plco_clean2$smoker <- factor(plco_clean2$smoker)
plco_clean2$pc <-
  factor(plco_clean2$pc,
         levels = c(0, 1),
         labels = c("No PC", "PC"))
plco_clean2$hypertension <-
  factor(plco_clean2$hypertension,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$diabetic <- factor(plco_clean2$diabetic,
                              levels = c(0, 1),
                              labels = c("No", "Yes"))
plco_clean2$stroke <- factor(plco_clean2$stroke,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean2$arthritis <-
  factor(plco_clean2$arthritis,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$bronch <- factor(plco_clean2$bronch,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean2$emphysema <-
  factor(plco_clean2$emphysema,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$mi_chd <- factor(plco_clean2$mi_chd,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean2$liver <- factor(plco_clean2$liver,
                           levels = c(0, 1),
                           labels = c("No", "Yes"))
plco_clean2$underweight <-
  factor(plco_clean2$underweight,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$overweight2 <-
  factor(plco_clean2$overweight2,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean2$obese2 <- factor(plco_clean2$obese2,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))

plco_clean2$tstage <- factor(plco_clean2$tstage)
plco_clean2$nstage <- factor(plco_clean2$nstage)
plco_clean2$gleason <- factor(plco_clean2$gleason, levels=c("<= 6","7","8","9","10"), ordered=TRUE)

plco_clean2 <- na.omit(plco_clean2)

plco_clean2$age_ctr_40 <- plco_clean2$age - 60.34387 #scaling the age 40+ cohort

km_predictions <- survfit(cox_40, plco_clean2)
myfunc <- function(x){
  inds <- which(x-0.5 <= 0)
  if (identical(inds, integer(0))){
    mytime <- 202
  } else{
    mytime <- min(inds)
  }
  return(mytime)
}

medsurv <- apply(X = km_predictions$surv, MARGIN = 2, FUN = myfunc)
medsurv2 <- data.frame(medsurv)

causespecific_group <- case_when(
  medsurv2$medsurv >= 180 ~ "15+",
  medsurv2$medsurv >= 120 & medsurv2$medsurv < 180 ~ "10-15",
  medsurv2$medsurv >= 60 & medsurv2$medsurv < 120 ~ "5-10",
  medsurv2$medsurv < 60 ~ "< 5"
)

plco_clean2$causespecific_group <- factor(causespecific_group, levels=c("15+", "10-15", "5-10", "< 5"), ordered=TRUE)

plco_clean2$lifeexpectancy <- medsurv2$medsurv

plco_clean2$weight <- case_when(
  plco_clean2$underweight=="Yes"~ "Underweight (BMI < 18.5)",
  plco_clean2$underweight=="No" & plco_clean2$overweight2=="No" & plco_clean2$obese2=="No"~ "Normal weight (BMI 18.5-25)",
  plco_clean2$overweight2=="Yes" ~ "Overweight (BMI 25-40)",
  plco_clean2$obese2=="Yes" ~ "Obese (BMI 40+)"
)

plco_clean2$weight <- factor(plco_clean2$weight, levels=c("Underweight (BMI < 18.5)", "Normal weight (BMI 18.5-25)", "Overweight (BMI 25-40)", "Obese (BMI 40+)"), ordered=TRUE)

plco_clean2$mortstat <- factor(plco_clean2$mortstat2, levels=c(0, 1, 2), labels = c("Alive", "Died of OC", "Died of PC"))

plco_clean2$pc_risk_group <- case_when(
  plco_clean2$tstage=="T1-T2a" & plco_clean2$gleason =="<= 6" & plco_clean2$dx_psa < 10 & plco_clean2$nstage=="N0" ~ "Low",
  plco_clean2$tstage!= "T3a-T4" & plco_clean2$gleason == "7" & plco_clean2$dx_psa <= 20 & plco_clean2$nstage=="N0" ~ "Intermediate",
  plco_clean2$nstage=="N0" & (plco_clean2$tstage=="T3a-T4" | plco_clean2$gleason=="8" | plco_clean2$gleason=="9" | plco_clean2$gleason=="10" | plco_clean2$dx_psa > 20) ~ "High",
  plco_clean2$nstage=="N1" | plco_clean2$nstage=="N2" ~ "Regional"
)

plco_clean2$pc_risk_group <- factor(plco_clean2$pc_risk_group, levels=c("Low", "Intermediate", "High", "Regional"), ordered = TRUE)

plco_clean2$primary_tx <- factor(plco_clean2$primary_tx, levels=c("No known treatment", "Other ablative treatment", "Hormone alone", "Radiation alone", "Prostatectomy", "Radiation + hormone"), labels=c("Active surveillance", "Other ablative treatment", "Hormone alone", "Radiation alone", "Prostatectomy", "Radiation + hormone"), ordered=TRUE)


var_label(plco_clean2$age) <- "Age (years)"
var_label(plco_clean2$race2) <- "Race"
var_label(plco_clean2$educ) <- "Education"
var_label(plco_clean2$marital2) <- "Marital status"
var_label(plco_clean2$mortstat) <- "Outcome"
var_label(plco_clean2$permth_exm) <- "Follow-up (months)"
var_label(plco_clean2$smoker) <- "Smoking status"
var_label(plco_clean2$arthritis) <- "Arthritis"
var_label(plco_clean2$bronch) <- "Chronic bronchitis"
var_label(plco_clean2$diabetic) <- "Diabetes"
var_label(plco_clean2$emphysema) <- "Emphysema"
var_label(plco_clean2$hypertension) <- "Hypertension"
var_label(plco_clean2$mi_chd) <- "Previous heart attack, coronary heart disease"
var_label(plco_clean2$liver) <- "Liver disease"
var_label(plco_clean2$stroke) <- "Previous stroke"
var_label(plco_clean2$weight) <- "BMI category"
var_label(plco_clean2$nstage) <- "N Stage"
var_label(plco_clean2$tstage) <- "T Stage"
var_label(plco_clean2$gleason) <- "Gleason"
var_label(plco_clean2$dx_psa) <- "PSA at diagnosis"
var_label(plco_clean2$primary_tx) <- "Treatment"
var_label(plco_clean2$pc_risk_group) <- "Prostate cancer risk group"

table_example <- CreateTableOne(vars = c("age", "race2", "educ", "marital2", "smoker", "diabetic", "hypertension", "stroke", "weight", "nstage"), strata = "causespecific_group", includeNA = TRUE, data = plco_clean2, argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

kable(print(table_example, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(4:6, 8:12, 14:16, 18:20, 25:28, 30:33))
```

\newpage

eTable 3, cont.: Characteristics of a cohort of 7,596 men from the Prostate, Lung, Colorectal, and Ovarian Cancer Screening Trial, grouped by OCCAM-predicted median survival time. 
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE, eval = FALSE}
table_example2 <- CreateTableOne(vars = c("tstage", "gleason", "dx_psa", "pc_risk_group", "primary_tx", "mortstat"), strata = "causespecific_group", includeNA = TRUE, data = plco_clean2, argsNormal = list(NULL), argsNonNormal = list(var.equal = TRUE))

kable(print(table_example2, contDigits=1, varLabel = T, printToggle=FALSE), booktabs=T) %>% add_indent(c(3:7, 9:13, 16:20, 22:27, 29:31))
```

\newpage

Analyses requested as revisions for BJUI:

How much does AUC change when each predictor is dropped in turn?:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
times <- c(120)
changepreds <- data.frame("Predictor" = "Overall", "Percent" = 100)

cox_40 <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

coxover_pred <- predict(object=cox_40, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_over_auc <-
  timeROC(
    T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = coxover_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

overallauc <- cox_over_auc$AUC[2]

cox_noage <-
  coxph(
    Surv(permth_exm, mortstat) ~diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_noage_pred <- predict(object=cox_noage, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_noage_auc <-
  timeROC(
    T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_noage_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Age", "Percent" = (overallauc-cox_noage_auc$AUC[2])/overallauc*100))

cox_nodiab <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nodiab_pred <- predict(object=cox_nodiab, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_nodiab_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_nodiab_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Diabetes", "Percent" = (overallauc-cox_nodiab_auc$AUC[2])/overallauc*100))

cox_noeduc <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_noeduc_pred <- predict(object=cox_noeduc, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_noeduc_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_noeduc_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Education", "Percent" = (overallauc-cox_noeduc_auc$AUC[2])/overallauc*100))

cox_nohyp <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nohyp_pred <- predict(object=cox_nohyp, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_nohyp_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_nohyp_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Hypertension", "Percent" = (overallauc-cox_nohyp_auc$AUC[2])/overallauc*100))

cox_nomar <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nomar_pred <- predict(object=cox_nomar, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_nomar_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_nomar_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Marital Status", "Percent" = (overallauc-cox_nomar_auc$AUC[2])/overallauc*100))

cox_nobmi <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nobmi_pred <- predict(object=cox_nobmi, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_nobmi_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_nobmi_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "BMI", "Percent" = (overallauc-cox_nobmi_auc$AUC[2])/overallauc*100))

cox_nosmo <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nosmo_pred <- predict(object=cox_nosmo, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_nosmo_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_nosmo_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Smoking", "Percent" = (overallauc-cox_nosmo_auc$AUC[2])/overallauc*100))

cox_nostroke <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nostroke_pred <- predict(object=cox_nostroke, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_nostroke_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_nostroke_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Stroke", "Percent" = (overallauc-cox_nostroke_auc$AUC[2])/overallauc*100))

cox_nopc <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

cox_nopc_pred <- predict(object=cox_nopc, newdata = mydata[mydata$inmodel4 == 1, ], type="lp")

cox_nopc_auc <-
  timeROC(
     T = mydata$permth_exm[mydata$inmodel4 == 1],
    delta = mydata$mortstat[mydata$inmodel4 == 1],
    marker = cox_nopc_pred,
    cause = 1,
    weighting = "marginal",
    times = times
  )

changepreds <- rbind(changepreds, data.frame("Predictor" = "Prostate Cancer", "Percent" = (overallauc-cox_nopc_auc$AUC[2])/overallauc*100))

kable(arrange(changepreds, Percent))
```

How much do predictions change when marital status and educational attainment are changed? First, for NHANES:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
mydata_maxeduc <- mydata
mydata_maxeduc$educ <- "College graduate"
mydata_maxmarital <- mydata
mydata_maxmarital$marital2 <- "Married"

true_predictions <- survfit(cox_40, mydata[mydata$inmodel4==1,])
maxmar_predictions <- survfit(cox_40, mydata_maxmarital[mydata$inmodel4==1,])
maxeduc_predictions <- survfit(cox_40, mydata_maxeduc[mydata$inmodel4==1,])

medsurv_true <- apply(X = true_predictions$surv, MARGIN = 2, FUN = myfunc, time = true_predictions$time)
medsurv2_true <- data.frame(medsurv_true)

medsurv_maxeduc <- apply(X = maxeduc_predictions$surv, MARGIN = 2, FUN = myfunc, time = maxeduc_predictions$time)
medsurv2_maxeduc <- data.frame(medsurv_maxeduc)

medsurv_maxmar <- apply(X = maxmar_predictions$surv, MARGIN = 2, FUN = myfunc, time = maxmar_predictions$time)
medsurv2_maxmar <- data.frame(medsurv_maxmar)

mydata$true[mydata$inmodel4==1] <- medsurv2_true$medsurv_true
mydata$maxeduc[mydata$inmodel4==1] <- medsurv2_maxeduc$medsurv_maxeduc
mydata$maxmar[mydata$inmodel4==1] <- medsurv2_maxmar$medsurv_maxmar
mydata$educ_diff <- mydata$maxeduc-mydata$true
mydata$mar_diff <- mydata$maxmar-mydata$true
mydata$educ_prob <- as.numeric(mydata$true < 120 & mydata$maxeduc >= 120)
mydata$mar_prob <- as.numeric(mydata$true < 120 & mydata$maxmar >= 120)

quantile(mydata$educ_diff[mydata$inmodel4==1])
quantile(mydata$mar_diff[mydata$inmodel4==1])

length(which(mydata$educ_prob[mydata$inmodel4==1]==1))/length(mydata$educ_prob[mydata$inmodel4==1])
length(which(mydata$mar_prob[mydata$inmodel4==1]==1))/length(mydata$mar_prob[mydata$inmodel4==1])

length(which(mydata$educ_diff[mydata$inmodel4==1] > 0))/length(mydata$educ_diff[mydata$inmodel4==1])
length(which(mydata$mar_diff[mydata$inmodel4==1] > 0))/length(mydata$mar_diff[mydata$inmodel4==1])
```

And for PLCO:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
plco_clean_maxeduc <- plco_clean
plco_clean_maxeduc$educ <- "College graduate"
plco_clean_maxmarital <- plco_clean
plco_clean_maxmarital$marital2 <- "Married"

true_predictions <- survfit(cox_40, plco_clean)
maxmar_predictions <- survfit(cox_40, plco_clean_maxmarital)
maxeduc_predictions <- survfit(cox_40, plco_clean_maxeduc)

medsurv_true <- apply(X = true_predictions$surv, MARGIN = 2, FUN = myfunc, time = true_predictions$time)
medsurv2_true <- data.frame(medsurv_true)

medsurv_maxeduc <- apply(X = maxeduc_predictions$surv, MARGIN = 2, FUN = myfunc, time = maxeduc_predictions$time)
medsurv2_maxeduc <- data.frame(medsurv_maxeduc)

medsurv_maxmar <- apply(X = maxmar_predictions$surv, MARGIN = 2, FUN = myfunc, time = maxmar_predictions$time)
medsurv2_maxmar <- data.frame(medsurv_maxmar)

plco_clean$true <- medsurv2_true$medsurv_true
plco_clean$maxeduc <- medsurv2_maxeduc$medsurv_maxeduc
plco_clean$maxmar <- medsurv2_maxmar$medsurv_maxmar
plco_clean$educ_diff <- plco_clean$maxeduc-plco_clean$true
plco_clean$mar_diff <- plco_clean$maxmar-plco_clean$true
plco_clean$educ_prob <- as.numeric(plco_clean$true < 120 & plco_clean$maxeduc >= 120)
plco_clean$mar_prob <- as.numeric(plco_clean$true < 120 & plco_clean$maxmar >= 120)

quantile(plco_clean$educ_diff)
quantile(plco_clean$mar_diff)

length(which(plco_clean$educ_prob==1))/length(plco_clean$educ_prob)
length(which(plco_clean$mar_prob==1))/length(plco_clean$mar_prob)

length(which(plco_clean$educ_diff > 0))/length(plco_clean$educ_diff)
length(which(plco_clean$mar_diff > 0))/length(plco_clean$mar_diff)
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
cox_red <-
  coxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + hypertension + 
      underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

table_model <- summary(cox_red)$conf.int
table_model[1, c(1, 3, 4)] <- exp(10*log(table_model[1, c(1, 3, 4)]))
table_model[11:13, c(1, 3, 4)] <- exp(10*log(table_model[11:13, c(1, 3, 4)]))

nhanes_svy <-
  svydesign(
    data = mydata,
    id =  ~ psu,
    strata =  ~ strata,
    weights =  ~ sweights,
    nest = TRUE
  )
nhanes_sub4 <- subset(nhanes_svy, inmodel4 == 1)

cox_red_wt <-
  svycoxph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + hypertension + 
      underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    design = nhanes_sub4)

table_model_wt <- summary(cox_red_wt)$conf.int
table_model_wt[1, c(1, 3, 4)] <- exp(10*log(table_model_wt[1, c(1, 3, 4)]))
table_model_wt[11:13, c(1, 3, 4)] <- exp(10*log(table_model_wt[11:13, c(1, 3, 4)]))

cox_plotdata <- data.frame("Variable" = c("Age (per 10 years)", "Diabetes (ref: no diabetes)", "Hypertension (ref: no hypertension)", "BMI <18.5 (ref: BMI 18.5-25)", "BMI 25-40 (ref: BMI 18.5-25)", "BMI 40+ (ref: BMI 18.5-25)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)",  "Prostate cancer (ref: no prostate cancer)", "Age (per 10 years)*Diabetes", "Age (per 10 years)*Hypertension", "Age (per 10 years)*Stroke"), "Effect" = c(table_model[,1], table_model_wt[,1]), "Lower" = c(table_model[,3], table_model_wt[,3]), "Upper" = c(table_model[,4], table_model_wt[,4]), "Label" = c(paste(round(table_model[,1], digits=2), " (", round(table_model[,3], digits=2), ",", round(table_model[,4], digits=2), ")", sep=""), paste(round(table_model_wt[,1], digits=2), " (", round(table_model_wt[,3], digits=2), ",", round(table_model_wt[,4], digits=2), ")", sep="")), "Model" = c(rep("Unweighted", 13), rep("Weighted", 13)))

cox_plotdata$Variable <- factor(cox_plotdata$Variable, levels= c("Age (per 10 years)", "Diabetes (ref: no diabetes)", "Hypertension (ref: no hypertension)", "BMI <18.5 (ref: BMI 18.5-25)", "BMI 25-40 (ref: BMI 18.5-25)", "BMI 40+ (ref: BMI 18.5-25)", "Current smoker (ref: never smoker)", "Former smoker (ref: never smoker)", "Stroke (ref: no stroke)",  "Prostate cancer (ref: no prostate cancer)", "Age (per 10 years)*Diabetes", "Age (per 10 years)*Hypertension", "Age (per 10 years)*Stroke"), ordered=TRUE)

adj_plot <- ggplot(cox_plotdata, aes(x = fct_rev(Variable), y = log(Effect), group = Model, color = Model)) + geom_point(position = position_dodge(width = 0.5)) + geom_errorbar(aes(ymin=log(Lower), ymax=log(Upper), width=0.1), position = position_dodge(width = 0.5)) + coord_flip() + labs(y = "Hazard Ratio and 95% CI", x = "", caption=TeX('Protective $\\leftarrow \\rightarrow$ Harmful' )) + geom_hline(yintercept=0, linetype="dashed", color = "black") + theme(panel.background = element_rect(fill="white"), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), legend.position="bottom", plot.caption = element_text(hjust = 0.3)) + scale_y_continuous(breaks=log(c(0.25, 0.5, 1, 2, 4)), labels=c("0.25", "0.5", "1.0", "2.0", "4.0")) + scale_color_manual(values = c("mediumpurple4", "gray74"))
 
adj_plot

ggsave("forest_plot_reduced.pdf", adj_plot)
rm(list=c("adj_plot", "cox_plotdata", "table_model"))
```

How much do predictions change when marital status and educational attainment are omitted from the model entirely? First, for NHANES:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
true_predictions <- survfit(cox_40, mydata[mydata$inmodel4==1,])
nomareduc_predictions <- survfit(cox_red, mydata[mydata$inmodel4==1,])

medsurv_true <- apply(X = true_predictions$surv, MARGIN = 2, FUN = myfunc, time = true_predictions$time)
medsurv2_true <- data.frame(medsurv_true)

medsurv_nomareduc <- apply(X = nomareduc_predictions$surv, MARGIN = 2, FUN = myfunc, time = nomareduc_predictions$time)
medsurv2_nomareduc <- data.frame(medsurv_nomareduc)

mydata$true[mydata$inmodel4==1] <- medsurv2_true$medsurv_true
mydata$nomareduc[mydata$inmodel4==1] <- medsurv2_nomareduc$medsurv_nomareduc

mydata$mareduc_diff <- mydata$nomareduc-mydata$true
mydata$mareduc_prob_inc <- as.numeric(mydata$true < 120 & mydata$nomareduc >= 120)
mydata$mareduc_prob_dec <- as.numeric(mydata$true >= 120 & mydata$nomareduc < 120)

quantile(mydata$mareduc_diff[mydata$inmodel4==1])

length(which(mydata$mareduc_prob_inc[mydata$inmodel4==1]==1))/length(mydata$mareduc_prob_inc[mydata$inmodel4==1])
length(which(mydata$mareduc_prob_dec[mydata$inmodel4==1]==1))/length(mydata$mareduc_prob_dec[mydata$inmodel4==1])

length(which(mydata$mareduc_diff[mydata$inmodel4==1] > 0))/length(mydata$mareduc_diff[mydata$inmodel4==1])
length(which(mydata$mareduc_diff[mydata$inmodel4==1] < 0))/length(mydata$mareduc_diff[mydata$inmodel4==1])
```

Calibration plot for 10- and 15-year probability of OCM:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
cutTime <- 15*12   #14 yr cutoff point

km_predictions <- survfit(cox_40, plco_clean)

predict_10 <- 1-km_predictions$surv[km_predictions$time==120,]
predict_15 <- 1-km_predictions$surv[km_predictions$time==180,]

group_10 <- case_when(
  predict_10 < 0.2 ~ 0.1,
  predict_10 >= 0.2 & predict_10 < 0.4 ~ 0.3,
  predict_10 >= 0.4 & predict_10 < 0.6 ~ 0.5,
  predict_10 >= 0.6 & predict_10 < 0.8 ~ 0.7,
  predict_10 >= 0.8 ~ 0.9
)

group_15 <- case_when(
  predict_15 < 0.2 ~ 0.1,
  predict_15 >= 0.2 & predict_15 < 0.4 ~ 0.3,
  predict_15 >= 0.4 & predict_15 < 0.6 ~ 0.5,
  predict_15 >= 0.6 & predict_15 < 0.8 ~ 0.7,
  predict_15 >= 0.8 ~ 0.9
)

km_10_01 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.1,])
km_10_03 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.3,])
km_10_05 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.5,])
km_10_07 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.7,])
km_10_09 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_10==0.9,])
km_15_01 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_15==0.1,])
km_15_03 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_15==0.3,])
km_15_05 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_15==0.5,])
km_15_07 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_15==0.7,])
km_15_09 <- survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[group_15==0.9,])

calibration10_data <- data.frame("Year" = rep("10 Years", 5), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7, 0.9), 
                                 "Est" = c(1-km_10_01$surv[km_10_01$time==120], 
                                           1-km_10_03$surv[km_10_03$time==120], 
                                           1-km_10_05$surv[km_10_05$time==120], 
                                           1-km_10_07$surv[km_10_07$time==120], 
                                           1-km_10_09$surv[km_10_09$time==118]), 
                                "Lower" = c(1-km_10_01$lower[km_10_01$time==120],
                                         1-km_10_03$lower[km_10_03$time==120],
                                         1-km_10_05$lower[km_10_05$time==120], 
                                          1-km_10_07$lower[km_10_07$time==120], 
                                          1-km_10_09$lower[km_10_09$time==118]),
                                "Upper" = c(1-km_10_01$upper[km_10_01$time==120],
                                         1-km_10_03$upper[km_10_03$time==120],
                                         1-km_10_05$upper[km_10_05$time==120], 
                                          1-km_10_07$upper[km_10_07$time==120], 
                                          1-km_10_09$upper[km_10_09$time==118]))

calibration15_data <- data.frame("Year" = rep("15 Years", 5), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7, 0.9), 
                                 "Est" = c(1-km_15_01$surv[km_15_01$time==180], 
                                           1-km_15_03$surv[km_15_03$time==180], 
                                           1-km_15_05$surv[km_15_05$time==180], 
                                           1-km_15_07$surv[km_15_07$time==180], 
                                           1-km_15_09$surv[km_15_09$time==179]), 
                                "Lower" = c(1-km_15_01$lower[km_15_01$time==180],
                                         1-km_15_03$lower[km_15_03$time==180],
                                         1-km_15_05$lower[km_15_05$time==180], 
                                          1-km_15_07$lower[km_15_07$time==180], 
                                          1-km_15_09$lower[km_15_09$time==179]),
                                "Upper" = c(1-km_15_01$upper[km_15_01$time==180],
                                         1-km_15_03$upper[km_15_03$time==180],
                                         1-km_15_05$upper[km_15_05$time==180], 
                                          1-km_15_07$upper[km_15_07$time==180], 
                                          1-km_15_09$upper[km_15_09$time==179]))

calibrationdat_total <- rbind(calibration10_data, calibration15_data)

myplot <- ggplot() + geom_errorbar(data = calibrationdat_total, aes(x = Group, ymin = Lower, 
                                              ymax = Upper, width = 0.05), color = "mediumpurple4") + 
  scale_x_continuous(name = "Predicted Risk of OCM",limits = c(0, 1), 
                                                   breaks = seq(0, 1, by=0.2)) + 
  scale_y_continuous(name = "Observed Risk of OCM", limits = c(0, 1), 
                     breaks = seq(0, 1.2, by=0.2)) + theme_bw() + 
  geom_abline(slope = 1, intercept = 0) + facet_wrap(~Year)

myplot

ggsave(filename = "calibration_plot_risk.pdf", myplot, height = 4, width = 10)
```

And time-dependent AUC's across sensitive groups:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
#And now we obtain estimates of the C-index and time-dependent AUC from our model in the main treatment groups: prostatectomy, radiation, and radiation + hormone:
times <- seq(60, 180, by=60)

cox40predict_white <- predict(object=cox_40, newdata = plco_clean[plco_clean$race2=="NHW",], type="lp")
cox40predict_black <- predict(object=cox_40, newdata = plco_clean[plco_clean$race2=="NHB",], type="lp")
cox40predict_other <- predict(object=cox_40, newdata = plco_clean[plco_clean$race2=="Other",], type="lp")

white_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$race2=="NHW"], delta = plco_clean$mortstat[plco_clean$race2=="NHW"], marker = cox40predict_white, cause = 1, weighting="marginal", times = times)

black_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$race2=="NHB"], delta = plco_clean$mortstat[plco_clean$race2=="NHB"], marker = cox40predict_black, cause = 1, weighting="marginal", times = times)

other_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$race2=="Other"], delta = plco_clean$mortstat[plco_clean$race2=="Other"], marker = cox40predict_other, cause = 1, weighting="marginal", times = times)

subperf_race <- data.frame("Race" = c("Non-Hispanic Black", "Non-Hispanic White", "Other"), "Year5" = round(c(black_roc_css$AUC[1], white_roc_css$AUC[1], other_roc_css$AUC[1]), digits=2), "Year10" = round(c(black_roc_css$AUC[2], white_roc_css$AUC[2],other_roc_css$AUC[2]), digits=2), "Year15" = round(c(black_roc_css$AUC[3], white_roc_css$AUC[2], other_roc_css$AUC[3]), digits=2))

rownames(subperf_race) <- NULL

cox40predict_married <- predict(object=cox_40, newdata = plco_clean[plco_clean$marital2=="Married",], type="lp")
cox40predict_single <- predict(object=cox_40, newdata = plco_clean[plco_clean$marital2=="Single",], type="lp")
cox40predict_sep <- predict(object=cox_40, newdata = plco_clean[plco_clean$marital2=="Separated",], type="lp")

married_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$marital2=="Married"], delta = plco_clean$mortstat[plco_clean$marital2=="Married"], marker = cox40predict_married, cause = 1, weighting="marginal", times = times)

single_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$marital2=="Single"], delta = plco_clean$mortstat[plco_clean$marital2=="Single"], marker = cox40predict_single, cause = 1, weighting="marginal", times = times)

sep_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$marital2=="Separated"], delta = plco_clean$mortstat[plco_clean$marital2=="Separated"], marker = cox40predict_sep, cause = 1, weighting="marginal", times = times)

subperf_marital <- data.frame("MaritalStat" = c("In Relationship", "Single", "Separated"), "Year5" = round(c(married_roc_css$AUC[1], single_roc_css$AUC[1], sep_roc_css$AUC[1]), digits=2), "Year10" = round(c(married_roc_css$AUC[2], single_roc_css$AUC[2],sep_roc_css$AUC[2]), digits=2), "Year15" = round(c(married_roc_css$AUC[3], single_roc_css$AUC[2], sep_roc_css$AUC[3]), digits=2))

rownames(subperf_marital) <- NULL

cox40predict_9 <- predict(object=cox_40, newdata = plco_clean[plco_clean$educ=="Less than 9th grade",], type="lp")
cox40predict_9_11 <- predict(object=cox_40, newdata = plco_clean[plco_clean$educ=="9th-11th grade",], type="lp")
cox40predict_hs <- predict(object=cox_40, newdata = plco_clean[plco_clean$educ=="HS graduate",], type="lp")
cox40predict_some <- predict(object=cox_40, newdata = plco_clean[plco_clean$educ=="Some college",], type="lp")
cox40predict_college <- predict(object=cox_40, newdata = plco_clean[plco_clean$educ=="College graduate",], type="lp")

nine_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$educ=="Less than 9th grade"], delta = plco_clean$mortstat[plco_clean$educ=="Less than 9th grade"], marker = cox40predict_9, cause = 1, weighting="marginal", times = times)

nine_eleven_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$educ=="9th-11th grade"], delta = plco_clean$mortstat[plco_clean$educ=="9th-11th grade"], marker = cox40predict_9_11, cause = 1, weighting="marginal", times = times)

hs_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$educ=="HS graduate"], delta = plco_clean$mortstat[plco_clean$educ=="HS graduate"], marker = cox40predict_hs, cause = 1, weighting="marginal", times = times)

some_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$educ=="Some college"], delta = plco_clean$mortstat[plco_clean$educ=="Some college"], marker = cox40predict_some, cause = 1, weighting="marginal", times = times)

college_roc_css <- timeROC(T = plco_clean$permth_exm[plco_clean$educ=="College graduate"], delta = plco_clean$mortstat[plco_clean$educ=="College graduate"], marker = cox40predict_college, cause = 1, weighting="marginal", times = times)

subperf_educ <- data.frame("Education" = c("Less than 9th grade", "9th-11th grade", "HS graduate", "Some college", "College graduate"), "Year5" = round(c(nine_roc_css$AUC[1], nine_eleven_roc_css$AUC[1], hs_roc_css$AUC[1], some_roc_css$AUC[1], college_roc_css$AUC[1]), digits=2), "Year10" = round(c(nine_roc_css$AUC[2], nine_eleven_roc_css$AUC[2], hs_roc_css$AUC[2], some_roc_css$AUC[2], college_roc_css$AUC[2]), digits=2), "Year15" = round(c(nine_roc_css$AUC[3], nine_eleven_roc_css$AUC[3], hs_roc_css$AUC[3], some_roc_css$AUC[3], college_roc_css$AUC[3]), digits=2))

rownames(subperf_educ) <- NULL

kable(subperf_race, col.names = c("Race", "5 Years", "10 Years", "15 Years")) %>%
 column_spec(column = 1, width = "5cm") %>% column_spec(column = 2:4, width = "1.75cm")

kable(subperf_marital, col.names = c("Relationship Status", "5 Years", "10 Years", "15 Years")) %>%
 column_spec(column = 1, width = "5cm") %>% column_spec(column = 2:4, width = "1.75cm")

kable(subperf_educ, col.names = c("Educational Attainment", "5 Years", "10 Years", "15 Years")) %>%
 column_spec(column = 1, width = "5cm") %>% column_spec(column = 2:4, width = "1.75cm")
```

\newpage

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=FALSE}
plco_clean <- filter(plco_clean, race2=="Other")
km_predictions <- survfit(cox_40, plco_clean)
myfunc <- function(x, time){
  inds <- which(x-0.5 <= 0)
  if (identical(inds, integer(0))){
    mytime <- 202
  } else{
    mytime <- time[min(inds)]
  }
  return(mytime)
}
medsurv <- apply(X = km_predictions$surv, MARGIN = 2, FUN = myfunc, time = km_predictions$time)
medsurv2 <- data.frame(medsurv)

plco_clean$medsurv <- medsurv2$medsurv

cox_group <- case_when(
  plco_clean$medsurv < 60 ~ 2.5,
  plco_clean$medsurv >= 60 & plco_clean$medsurv < 84 ~ 6,
  plco_clean$medsurv >= 84 & plco_clean$medsurv < 120 ~ 8.5,
  plco_clean$medsurv >= 120 & plco_clean$medsurv < 144 ~ 11,
  plco_clean$medsurv >= 144 & plco_clean$medsurv < 180 ~ 13.5,
  plco_clean$medsurv >= 180 ~ 15
)

ssa_group <- case_when(
  plco_clean$ssa < 5 ~ 2.5,
  plco_clean$ssa >= 5 & plco_clean$ssa < 7 ~ 6,
  plco_clean$ssa >= 7 & plco_clean$ssa < 10 ~ 8.5,
  plco_clean$ssa >= 10 & plco_clean$ssa < 12 ~ 11,
  plco_clean$ssa >= 12 & plco_clean$ssa < 15 ~ 13.5,
  plco_clean$ssa >= 15 ~ 15
)

cox_5 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$time))
#ssa_5 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$time))
cox_7 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$time))
ssa_7 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$time))
cox_10 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$time))
ssa_10 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$time))
cox_12 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$time))
ssa_12 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$time))
cox_15 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$time))
ssa_15 <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$time))
cox_15p <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$time))
ssa_15p <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$surv, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$time))

cox_5l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$time))
#ssa_5l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$time))
cox_7l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$time))
ssa_7l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$time))
cox_10l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$time))
ssa_10l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$time))
cox_12l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$time))
ssa_12l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$time))
cox_15l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$time))
ssa_15l <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$time))
cox_15pl <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$time))
ssa_15pl <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$lower, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$time))

cox_5u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==2.5,])$time))
#ssa_5u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==2.5,])$time))
cox_7u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==6,])$time))
ssa_7u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==6,])$time))
cox_10u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==8.5,])$time))
ssa_10u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==8.5,])$time))
cox_12u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==11,])$time))
ssa_12u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==11,])$time))
cox_15u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==13.5,])$time))
ssa_15u <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==13.5,])$time))
cox_15pu <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[cox_group==15,])$time))
ssa_15pu <- data.frame(myfunc(x = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$upper, time = survfit(Surv(permth_exm, mortstat) ~ 1, data = plco_clean[ssa_group==15,])$time))

calibration_data <- data.frame("Time" = rep(c(2.5, 6, 8.5, 11, 13.5, 15), 2), "Model" = c(rep("OCCAM", 6), rep("SSA", 6)), "Observed" = c(cox_5$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_7$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_10$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_12$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15p$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., NA, ssa_7$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_10$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_12$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15p$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group....)/12, "Lower" = c(cox_5l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_7l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_10l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_12l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15pl$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., NA, ssa_7l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_10l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_12l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15l$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15pl$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group....)/12, "Upper" = c(cox_5u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_7u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_10u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_12u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., cox_15pu$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.cox_group...., NA, ssa_7u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_10u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_12u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15u$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group...., ssa_15pu$myfunc.x...survfit.Surv.permth_exm..mortstat....1..data...plco_clean.ssa_group....)/12)

calibration_data[calibration_data==202/12] <- 25

#myplot <- ggplot() + geom_line(data = calibration_data, aes(x=Time, y=Observed, 
                  #                                              group = Model, 
                #                                                color = Model)) +
 # geom_errorbar(data = calibration_data, aes(x = Time, ymin = Lower, ymax = Upper, group = Model, color = Model, width = 0.5)) + 
#  scale_x_continuous(name = "Predicted Life Expectancy", 
#                     breaks = seq(2, 16, by=3)) + 
#  scale_y_continuous(name = "Observed Life Expectancy", 
#                     breaks = seq(2, 23, by=3)) + theme_bw() + 
 # geom_abline(slope = 1, intercept = 0) + scale_color_manual(values = c("darkred", "mediumpurple4", "grey74"), name = "Model") + theme(legend.position = "bottom") + coord_cartesian(ylim = c(2, 23), xlim = c(2,16))

calibration_data$Time[calibration_data$Model=="OCCAM"] <- calibration_data$Time[calibration_data$Model=="OCCAM"] + 0.2

myplot <- ggplot() + geom_line(data = calibration_data, aes(x=Time, y=Observed, 
                                                                group = Model, 
                                                                color = Model)) +
  geom_errorbar(data = calibration_data, aes(x = Time, ymin = Lower, ymax = Upper, group = Model, color = Model, width = 0.5)) + 
  scale_x_continuous(name = "Predicted Life Expectancy", 
                     breaks = seq(2, 16, by=3)) + 
  scale_y_continuous(name = "Observed Life Expectancy", 
                     breaks = seq(2, 26, by=3)) + theme_bw() + 
  geom_abline(slope = 1, intercept = 0) + theme(legend.position = "bottom") + scale_color_manual(values = c("mediumpurple4", "darkred")) + coord_cartesian(ylim = c(2, 26), xlim = c(2,16)) 

myplot

rm(list=c("myplot", "ssa_5", "ssa_5l", "ssa_5u", "ssa_7", "ssa_7l", "ssa_7u", "ssa_10", "ssa_10l", "ssa_10u", "ssa_12", "ssa_12u", "ssa_12l", "ssa_15", "ssa_15u", "ssa_15l", "ssa_15p", "ssa_15pl", "ssa_15pu", "ssa_5", "ssa_5l", "ssa_5u", "ssa_7", "ssa_7l", "ssa_7u", "ssa_10", "ssa_10l", "ssa_10u", "ssa_12", "ssa_12u", "ssa_12l", "ssa_15", "ssa_15u", "ssa_15l", "ssa_15p", "ssa_15pl", "ssa_15pu"))
```