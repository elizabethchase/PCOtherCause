---
title: "OCM_modelvalidation"
author: "Elizabeth Chase"
date: "7/27/2020"
output: pdf_document
---

This script demonstrates how the model was validated in PLCO. Unfortunately, the PLCO data cannot be shared, and therefore this script cannot be run. However, we provide the code for transparency. 

```{r setup, include=FALSE, echo=TRUE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  fig.align = 'center',
  tidy = TRUE,
  tidy.opts = list(blank = TRUE, width.cutoff = 40),
  warning = FALSE,
  message = FALSE
)

rm(list = ls())

library(tidyverse)
library(gridExtra)
library(RColorBrewer)
library(tableone)
library(survey)
library(survival)
library(survminer)
library(randomForestSRC)
library(sampling)
library(latex2exp)
library(labelled)
library(kableExtra)
library(pec)
library(riskRegression)
library(flexsurv)
library(foreign)
library(timeROC)
library(cmprsk)
library(rms)
library(polspline)
library(Hmisc)

#This is the PLCO dataset that we cannot share:
prostatedata <-
  read_csv("~/Box/PLCO Data/Prostate/pros_data_nov18_d070819.csv.zip")

#We filter to men who were actually diagnosed with prostate cancer:
cancer <- filter(prostatedata, pros_cancer == 1)
rm(list = c("prostatedata"))

#We filter to the list of variables we need for validation:
plco <-
  select(
    cancer,
    race7,
    pros_exitage,
    diabetes_f,
    hyperten_f,
    stroke_f,
    arthrit_f,
    bronchit_f,
    emphys_f,
    hearta_f,
    liver_comorbidity,
    educat,
    marital,
    cig_stat,
    bmi_curr,
    is_dead_with_cod,
    mortality_exitdays,
    pros_exitdays,
    f_dthp,
    primary_trtp
  )

#We define derived variables:
plco$race2 <- case_when(
  plco$race7 == 1 ~ "NHW",
  plco$race7 == 2 ~ "NHB",
  plco$race7 >= 3 & plco$race7 <= 6 ~ "Other",
  plco$race7 == 7 ~ NA_character_
)

plco$educ <- case_when(
  plco$educat == 1 ~ "Less than 9th grade",
  plco$educat == 2 ~ "9th-11th grade",
  plco$educat == 3 ~ "HS graduate",
  plco$educat == 4 | plco$educat == 5 ~ "Some college",
  plco$educat == 6 | plco$educat == 7 ~ "College graduate",
  is.na(plco$educat) ~ NA_character_
)

plco$marital2 <- case_when(
  plco$marital == 1 ~ "Married",
  plco$marital == 2 |
    plco$marital == 3 | plco$marital == 4 ~ "Separated",
  plco$marital == 5 ~ "Single",
  is.na(plco$marital) ~ NA_character_
)

plco$smoker <- case_when(plco$cig_stat == 0 ~ "Never",
                         plco$cig_stat == 1 ~ "Current",
                         plco$cig_stat == 2 ~ "Former")

plco$primary_tx <- case_when(
  plco$primary_trtp == 0 ~ "No cancer",
  plco$primary_trtp == 1 ~ "Prostatectomy",
  plco$primary_trtp == 2 ~ "Radiation alone",
  plco$primary_trtp == 3 ~ "Radiation + hormone",
  plco$primary_trtp == 4 ~ "Hormone alone",
  plco$primary_trtp == 5 ~ "Other ablative treatment",
  plco$primary_trtp == 6 ~ "No known treatment",
  plco$primary_trtp == 10 ~ NA_character_
)

plco$underweight <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr < 18.5,
                                          1, 0))
plco$overweight2 <-
  ifelse(is.na(plco$bmi_curr),
         NA,
         ifelse(plco$bmi_curr >= 25
                &
                  plco$bmi_curr < 40,
                1, 0))
plco$obese2 <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 40, 1, 0))
plco$overweight_ex <-
  ifelse(is.na(plco$bmi_curr),
         NA,
         ifelse(plco$bmi_curr >= 25
                &
                  plco$bmi_curr < 30,
                1, 0))
plco$obese <-
  ifelse(is.na(plco$bmi_curr), NA, ifelse(plco$bmi_curr >= 30, 1, 0))

plco$mortstat <- case_when(
  plco$is_dead_with_cod == 1 & plco$f_dthp == 0 ~ 1,
  plco$is_dead_with_cod == 1 & plco$f_dthp == 1 ~ 0,
  plco$is_dead_with_cod == 0 ~ 0
)

plco$mortstat2 <- case_when(
  plco$is_dead_with_cod == 1 & plco$f_dthp == 0 ~ 1,
  plco$is_dead_with_cod == 1 & plco$f_dthp == 1 ~ 2,
  plco$is_dead_with_cod == 0 ~ 0
)

plco$permth_exm <-
  round((plco$mortality_exitdays - plco$pros_exitdays) / 30)

#We select variables and do necessary renaming
plco_clean <- mutate(
  plco,
  age = pros_exitage,
  diabetic = diabetes_f,
  hypertension = hyperten_f,
  stroke = stroke_f,
  arthritis = arthrit_f,
  bronch = bronchit_f,
  emphysema = emphys_f,
  mi_chd = hearta_f,
  liver = liver_comorbidity,
  pc = 1
) %>%
  select(
    race2,
    age,
    diabetic,
    hypertension,
    stroke,
    arthritis,
    bronch,
    emphysema,
    mi_chd,
    liver,
    educ,
    marital2,
    smoker,
    underweight,
    overweight2,
    obese2,
    overweight_ex,
    obese,
    pc,
    mortstat,
    mortstat2,
    permth_exm,
    primary_tx
  )

#We keep an unformatted version of the dataset for random forest:
plco_nf <- plco_clean

#We define factors:
plco_clean$race2 <- factor(plco_clean$race2)
plco_clean$educ <- factor(plco_clean$educ)
plco_clean$marital2 <- factor(plco_clean$marital2)
plco_clean$smoker <- factor(plco_clean$smoker)
plco_clean$pc <-
  factor(plco_clean$pc,
         levels = c(0, 1),
         labels = c("No PC", "PC"))
plco_clean$hypertension <-
  factor(plco_clean$hypertension,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean$diabetic <- factor(plco_clean$diabetic,
                              levels = c(0, 1),
                              labels = c("No", "Yes"))
plco_clean$stroke <- factor(plco_clean$stroke,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean$arthritis <-
  factor(plco_clean$arthritis,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean$bronch <- factor(plco_clean$bronch,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean$emphysema <-
  factor(plco_clean$emphysema,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean$mi_chd <- factor(plco_clean$mi_chd,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))
plco_clean$liver <- factor(plco_clean$liver,
                           levels = c(0, 1),
                           labels = c("No", "Yes"))
plco_clean$underweight <-
  factor(plco_clean$underweight,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean$overweight2 <-
  factor(plco_clean$overweight2,
         levels = c(0, 1),
         labels = c("No", "Yes"))
plco_clean$obese2 <- factor(plco_clean$obese2,
                            levels = c(0, 1),
                            labels = c("No", "Yes"))

#We define numeric versions of the variables for random forest:
plco_nf$single <- ifelse(plco_nf$marital2 == "Single", 1,
                         ifelse(is.na(plco_nf$marital2), NA_real_, 0))
plco_nf$sep <- ifelse(plco_nf$marital2 == "Separated", 1,
                      ifelse(is.na(plco_nf$marital2), NA_real_, 0))
plco_nf$black <- ifelse(plco_nf$race2 == "NHB", 1,
                        ifelse(is.na(plco_nf$race2), NA_real_, 0))
plco_nf$other <- ifelse(plco_nf$race2 == "Other", 1,
                        ifelse(is.na(plco_nf$race2), NA_real_, 0))

plco_nf$educ2 <- case_when(
  plco_nf$educ == "Less than 9th grade" ~ 1,
  plco_nf$educ == "9th-11th grade" ~ 2,
  plco_nf$educ == "HS graduate" ~ 3,
  plco_nf$educ == "Some college" ~ 4,
  plco_nf$educ == "College graduate" ~ 5
)
plco_nf$educ <- plco_nf$educ2

plco_nf$smoker2 <- case_when(
  plco_nf$smoker == "Never" ~ 0,
  plco_nf$smoker == "Current" ~ 1,
  plco_nf$smoker == "Former" ~ 2
)
plco_nf$smoker <- plco_nf$smoker2

plco_clean <- na.omit(plco_clean)
plco_nf <- na.omit(plco_nf)
```

## Validation

Now we validate each model. First, we look at C-index for the cause-specific formulation:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
load("cox_55.RData")
load("cox_40.RData")
load("rforest_40.RData")

times <- seq(6, 192, by=6)
plco_clean$age_ctr_40 <- plco_clean$age - 60.34387 #scaling the age 40+ cohort
plco_clean$age_ctr_55 <- plco_clean$age - 68.35788 #scaling the age 55+ cohort

cox55_plco <- pec::cindex(object=cox_55, Surv(permth_exm, mortstat) ~ age_ctr_55 + 
                            race2 + educ + marital2 + emphysema + diabetic + 
                            stroke + smoker + underweight + overweight2 + obese2 + 
                            pc + age_ctr_55*diabetic + age_ctr_55*educ + 
                            age_ctr_55*marital2 + race2*educ, data = plco_clean, 
                          eval.times = times)

cox40_plco <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                            age_ctr_40 + diabetic + educ + hypertension + marital2 + 
                            underweight + overweight2 + obese2 + smoker + stroke + 
                            age_ctr_40*diabetic + age_ctr_40*educ + 
                            age_ctr_40*hypertension + age_ctr_40*stroke + pc, 
                          data=plco_clean, eval.times = times)

forest_plco <- pec::cindex(object=rforest_40, formula = Surv(permth_exm, mortstat) ~ 
                             age + arthritis + bronch + diabetic + educ + 
                             emphysema + hypertension + single + sep + mi_chd + 
                             underweight + overweight_ex + obese + liver + black + 
                             other + smoker + stroke + pc, data=plco_nf, eval.times = times)

valid_perf <- data.frame("Time" = rep(seq(6, 168, by=6), 3), 
                         "Model" = c(rep("Cox 55", 28), rep("Cox 40", 28), 
                                     rep("Random Forest", 28)), 
                         "C" = c(cox55_plco$AppCindex$coxph, cox40_plco$AppCindex$coxph,
                                 forest_plco$AppCindex$rfsrc))

performance_plot <- ggplot(data=valid_perf, aes(x=Time, y=C)) + geom_point(size=0.1) + 
  geom_line(data=valid_perf, aes(group=Model, color=Model)) + xlab("Time (months)") + 
  ylab("Time-dependent C-index in PLCO")

performance_plot
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
subperf <- data.frame("Model" = c("Cox 55", "Cox 40", "Random Forest"), 
                      "Year5" = round(c(cox55_plco$AppCindex$coxph[10], 
                                        cox40_plco$AppCindex$coxph[10], 
                                        forest_plco$AppCindex$rfsrc[10]), digits=3), 
                      "Year10" = round(c(cox55_plco$AppCindex$coxph[20], 
                                         cox40_plco$AppCindex$coxph[20], 
                                         forest_plco$AppCindex$rfsrc[20]), digits=3), 
                      "Year14" = round(c(cox55_plco$AppCindex$coxph[28], 
                                         cox40_plco$AppCindex$coxph[28], 
                                         forest_plco$AppCindex$rfsrc[28]), digits=3))

kable(subperf, caption = "Time-dependent C-index in PLCO")
```

Based on C-index, our strongest performing model is the Cox model fit to men ages 40+. Now we look at time-dependent AUC:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
cox40predict <-
  predict(object = cox_40,
          newdata = plco_clean,
          type = "lp")
cox55predict <-
  predict(object = cox_55,
          newdata = plco_clean,
          type = "lp")
rforestpredict <-
  predict(object=rforest_40,
          newdata = plco_nf)

cox40roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = cox40predict,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )
cox55roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = cox55predict,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )
rforestroc <-
  timeROC(
    T = plco_nf$permth_exm,
    delta = plco_nf$mortstat,
    marker = rforestpredict$predicted,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

aucdat <-
  data.frame("Time" = rep(seq(6, 168, by = 6), 3), 
             "Model" = c(rep("Cox 55", 28), rep("Cox 40", 28), 
                                     rep("Random Forest", 28)),
             "AUC" = c(cox55roc$AUC[-1], cox40roc$AUC[-1],
                       rforestroc$AUC[-1]))

aucplot <-
  ggplot(data = aucdat, aes(x = Time, y = AUC, group = Model, color=Model)) + 
  geom_line() + xlab("Time (months)") + ylab("Time-dependent AUC in PLCO")

aucplot
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
auc_table <- data.frame("Model" = c("Cox 55", "Cox 40", "Random Forest"), 
                      "Year5" = round(c(cox55roc$AUC[11], 
                                        cox40roc$AUC[11], 
                                        rforestroc$AUC[11]), digits=3), 
                      "Year10" = round(c(cox55roc$AUC[21], 
                                         cox40roc$AUC[21], 
                                         rforestroc$AUC[21]), digits=3), 
                      "Year14" = round(c(cox55roc$AUC[29], 
                                         cox40roc$AUC[29], 
                                         rforestroc$AUC[29]), digits=3))

kable(auc_table, caption="Time-Dependent AUC in PLCO")
```

Based on time-dependent AUC, the Cox model fit to men ages 40+ is still the strongest performing model. We will now focus our attention on the Cox ages 40+ model for the rest of our model validation/performance assessment.

We look at C-index and time-dependent AUC stratified by treatment group:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
cox40_prostatectomy <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                                     age_ctr_40 + diabetic + educ + hypertension + 
                                     marital2 + underweight + overweight2 + obese2 + 
                                     smoker + stroke + age_ctr_40*diabetic + 
                                     age_ctr_40*educ + age_ctr_40*hypertension + 
                                     age_ctr_40*stroke + pc,
                                   data=plco_clean[plco_clean$primary_tx=="Prostatectomy",], 
                                   eval.times = times)

cox40_radiation <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                                 age_ctr_40 + diabetic + educ + hypertension + 
                                 marital2 + underweight + overweight2 + obese2 + 
                                 smoker + stroke + age_ctr_40*diabetic + 
                                 age_ctr_40*educ + age_ctr_40*hypertension + 
                                 age_ctr_40*stroke + pc, 
                               data=plco_clean[plco_clean$primary_tx=="Radiation alone",], 
                               eval.times = times)

cox40_rtadt <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                             age_ctr_40 + diabetic + educ + hypertension + 
                             marital2 + underweight + overweight2 + obese2 + 
                             smoker + stroke + age_ctr_40*diabetic + 
                             age_ctr_40*educ + age_ctr_40*hypertension + 
                             age_ctr_40*stroke + pc, 
                           data=plco_clean[plco_clean$primary_tx=="Radiation + hormone",], 
                           eval.times = times)

valid_perf_trt <- data.frame("Time" = rep(seq(6, 168, by=6), 3), 
                             "Treatment" = c(rep("Prostatectomy", 28), 
                                             rep("Radiation alone", 28), 
                                             rep("Radiation + hormone", 28)), 
                             "C" = c(cox40_prostatectomy$AppCindex$coxph, 
                                     cox40_radiation$AppCindex$coxph, 
                                     cox40_rtadt$AppCindex$coxph))

performance_plot_trt <- ggplot(data=valid_perf_trt, aes(x=Time, y=C)) + 
  geom_point(size=0.1) + geom_line(data=valid_perf_trt, aes(group=Treatment, 
                                                            color=Treatment)) + 
  xlab("Time (months)") + ylab("C-index in PLCO")

performance_plot_trt

subperf_trt <- data.frame("Treatment" = c("Prostatectomy", "Radiation alone", 
                                          "Radiation + hormone"), 
                          "Year5" = round(c(cox40_prostatectomy$AppCindex$coxph[10],
                                            cox40_radiation$AppCindex$coxph[10], 
                                            cox40_rtadt$AppCindex$coxph[10]), digits=3), 
                          "Year10" = round(c(cox40_prostatectomy$AppCindex$coxph[20],
                                             cox40_radiation$AppCindex$coxph[20],
                                             cox40_rtadt$AppCindex$coxph[20]), digits=3), 
                          "Year14" = round(c(cox40_prostatectomy$AppCindex$coxph[28],
                                             cox40_radiation$AppCindex$coxph[28],
                                             cox40_rtadt$AppCindex$coxph[28]), digits=3))

kable(subperf_trt, caption = "PLCO Time-Dependent C-index, by Treatment")

cox40predict_prostatectomy <- predict(object=cox_40, newdata =
                                        plco_clean[plco_clean$primary_tx=="Prostatectomy",],
                                      type="lp")

cox40predict_radiation <- predict(object=cox_40, newdata = 
                                    plco_clean[plco_clean$primary_tx=="Radiation alone",], 
                                  type="lp")

cox40predict_rtadt <- predict(object=cox_40, newdata = 
                                plco_clean[plco_clean$primary_tx=="Radiation + hormone",], 
                              type="lp")

prostatectomy_roc <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Prostatectomy"], 
                             delta = plco_clean$mortstat[plco_clean$primary_tx=="Prostatectomy"], 
                             marker = cox40predict_prostatectomy, cause = 1, 
                             weighting="marginal", times = seq(0, 168, by=6))

radiation_roc <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Radiation alone"], 
                         delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation alone"], 
                         marker = cox40predict_radiation, cause = 1, 
                         weighting="marginal", times = seq(0, 168, by=6))

rtadt_roc <- timeROC(T = plco_clean$permth_exm[plco_clean$primary_tx=="Radiation + hormone"], 
                     delta = plco_clean$mortstat[plco_clean$primary_tx=="Radiation + hormone"], 
                     marker = cox40predict_rtadt, cause = 1, weighting="marginal", 
                     times = seq(0, 168, by=6))

aucdat_trt <- data.frame("Time" = rep(seq(6, 168, by=6), 3), 
                         "AUC" = c(prostatectomy_roc$AUC[-1], radiation_roc$AUC[-1], 
                                   rtadt_roc$AUC[-1]), 
                         "Treatment" = c(rep("Prostatectomy", 28), 
                                         rep("Radiation alone", 28), 
                                         rep("Radiation + hormone", 28)))

aucplot_trt <- ggplot(data=aucdat_trt, aes(x=Time, y=AUC, group=Treatment, 
                                           color=Treatment)) + geom_line() + 
  xlab("Time (months)") + ylab("Time-dependent AUC in PLCO")

aucplot_trt

auc_table_trt <- data.frame("Years" = c(5, 10, 14), 
                            "Prostatectomy" = round(c(prostatectomy_roc$AUC[11], 
                                                      prostatectomy_roc$AUC[21], 
                                                      prostatectomy_roc$AUC[29]), 
                                                    digits = 3), 
                            "Radiation" = round(c(radiation_roc$AUC[11], 
                                                  radiation_roc$AUC[21], 
                                                  radiation_roc$AUC[29]), 
                                                digits = 3), 
                            "Radiation_hormone" = round(c(rtadt_roc$AUC[11], 
                                                          rtadt_roc$AUC[21], 
                                                          rtadt_roc$AUC[29]), 
                                                        digits = 3))

rownames(auc_table_trt) <- NULL
kable(auc_table_trt, caption="Time-Dependent AUC in PLCO, by Treatment")
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
cutTime <- 14*12   #14 yr cutoff point

plco_clean$pc_time_14yr <- ifelse(plco_clean$permth_exm > cutTime, cutTime, 
                                  plco_clean$permth_exm)
plco_clean$pc_status <- ifelse(plco_clean$permth_exm >= cutTime, 0, 
                               plco_clean$mortstat2)
plco_clean$linpred <- cox40predict

dat <- plco_clean[, c("pc_status", "pc_time_14yr", "linpred")]
dat <- dat[complete.cases(dat), ]
  
eve.ocm <- dat$pc_status == 1
eve.pcsm <- dat$pc_status == 2
eve.cens <- dat$pc_status == 0 
  
fstatus <- rep(0,times = nrow(dat))
fstatus[which(eve.ocm)] <- 1
fstatus[which(eve.pcsm)] <- 2
ftime <- dat$pc_time_14yr

fg_covariates <- dat$linpred

finegray_pc <- crr(ftime = ftime, fstatus = fstatus, cov1 = fg_covariates)
summary(finegray_pc)

finegray_predictions <- predict(finegray_pc, cov1 = fg_covariates)

predict_5 <- finegray_predictions[finegray_predictions[,1]==60,-1]
predict_10 <- finegray_predictions[finegray_predictions[,1]==120,-1]
predict_14 <- finegray_predictions[finegray_predictions[,1]==167,-1]

group_5 <- case_when(
  predict_5 < 0.2 ~ 0.1,
  predict_5 >= 0.2 & predict_5 < 0.4 ~ 0.3,
  predict_5 >= 0.4 & predict_5 < 0.6 ~ 0.5,
  predict_5 >= 0.6 & predict_5 < 0.8 ~ 0.7,
  predict_5 >= 0.8 ~ 0.9
)

group_10 <- case_when(
  predict_10 < 0.2 ~ 0.1,
  predict_10 >= 0.2 & predict_10 < 0.4 ~ 0.3,
  predict_10 >= 0.4 & predict_10 < 0.6 ~ 0.5,
  predict_10 >= 0.6 & predict_10 < 0.8 ~ 0.7,
  predict_10 >= 0.8 ~ 0.9
)

group_14 <- case_when(
  predict_14 < 0.2 ~ 0.1,
  predict_14 >= 0.2 & predict_14 < 0.4 ~ 0.3,
  predict_14 >= 0.4 & predict_14 < 0.6 ~ 0.5,
  predict_14 >= 0.6 & predict_14 < 0.8 ~ 0.7,
  predict_14 >= 0.8 ~ 0.9
)

cuminc_5 <- cuminc(ftime, fstatus, group = group_5)
cuminc_10 <- cuminc(ftime, fstatus, group = group_10)
cuminc_14 <- cuminc(ftime, fstatus, group = group_14)

calibration5_data <- data.frame("Year" = rep("5 Years", 3), 
                                "Group" = c(0.1, 0.3, 0.5), 
                                "Est" = c(cuminc_5$`0.1 1`$est[cuminc_5$`0.1 1`$time==60][1], 
                                          cuminc_5$`0.3 1`$est[cuminc_5$`0.3 1`$time==59][1], 
                                          cuminc_5$`0.5 1`$est[cuminc_5$`0.5 1`$time==57][1]), 
                                "Var" = c(cuminc_5$`0.1 1`$var[cuminc_5$`0.1 1`$time==60][1], 
                                          cuminc_5$`0.3 1`$var[cuminc_5$`0.3 1`$time==59][1], 
                                          cuminc_5$`0.5 1`$var[cuminc_5$`0.5 1`$time==57][1]))

calibration10_data <- data.frame("Year" = rep("10 Years", 4), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7), 
                                 "Est" = c(cuminc_10$`0.1 1`$est[cuminc_10$`0.1 1`$time==120][1], 
                                           cuminc_10$`0.3 1`$est[cuminc_10$`0.3 1`$time==120][1], 
                                           cuminc_10$`0.5 1`$est[cuminc_10$`0.5 1`$time==119][1], 
                                           cuminc_10$`0.7 1`$est[cuminc_10$`0.7 1`$time==118][1]), 
                                 "Var" = c(cuminc_10$`0.1 1`$var[cuminc_10$`0.1 1`$time==120][1], 
                                           cuminc_10$`0.3 1`$var[cuminc_10$`0.3 1`$time==120][1], 
                                           cuminc_10$`0.5 1`$var[cuminc_10$`0.5 1`$time==119][1], 
                                           cuminc_10$`0.7 1`$var[cuminc_10$`0.7 1`$time==118][1]))

calibration14_data <- data.frame("Year" = rep("10 Years", 5), 
                                 "Group" = c(0.1, 0.3, 0.5, 0.7, 0.9), 
                                 "Est" = c(cuminc_14$`0.1 1`$est[cuminc_14$`0.1 1`$time==168][1], 
                                           cuminc_14$`0.3 1`$est[cuminc_14$`0.3 1`$time==168][1], 
                                           cuminc_14$`0.5 1`$est[cuminc_14$`0.5 1`$time==168][1], 
                                           cuminc_14$`0.7 1`$est[cuminc_14$`0.7 1`$time==168][1], 
                                           cuminc_14$`0.9 1`$est[cuminc_14$`0.9 1`$time==157][1]), 
                                 "Var" = c(cuminc_14$`0.1 1`$var[cuminc_14$`0.1 1`$time==168][1], 
                                           cuminc_14$`0.3 1`$var[cuminc_14$`0.3 1`$time==168][1], 
                                           cuminc_14$`0.5 1`$var[cuminc_14$`0.5 1`$time==168][1], 
                                           cuminc_14$`0.7 1`$var[cuminc_14$`0.7 1`$time==168][1], 
                                           cuminc_14$`0.9 1`$var[cuminc_14$`0.9 1`$time==157][1]))

calibration5_data$Upper <- calibration5_data$Est + 1.96*sqrt(calibration5_data$Var)
calibration10_data$Upper <- calibration10_data$Est + 1.96*sqrt(calibration10_data$Var)
calibration14_data$Upper <- calibration14_data$Est + 1.96*sqrt(calibration14_data$Var)
calibration5_data$Lower <- calibration5_data$Est - 1.96*sqrt(calibration5_data$Var)
calibration10_data$Lower <- calibration10_data$Est - 1.96*sqrt(calibration10_data$Var)
calibration14_data$Lower <- calibration14_data$Est - 1.96*sqrt(calibration14_data$Var)

calibration5_data$Upper[calibration5_data$Upper>1] <- 1
calibration5_data$Lower[calibration5_data$Lower<0] <- 0
calibration10_data$Upper[calibration10_data$Upper>1] <- 1
calibration10_data$Lower[calibration10_data$Lower<0] <- 0
calibration14_data$Upper[calibration14_data$Upper>1] <- 1
calibration14_data$Lower[calibration14_data$Lower<0] <- 0

myplot <- ggplot() + geom_line(data = calibration5_data, aes(x=Group, y=Est), 
                               color = "darkblue") + 
  geom_errorbar(data = calibration5_data, aes(x = Group, ymin = Lower, 
                                              ymax = Upper, width = 0.05), 
                color = "darkblue") + geom_line(data = calibration10_data, 
                                                aes(x=Group, y=Est), 
                                                color = "mediumpurple4") + 
  geom_errorbar(data = calibration10_data, aes(x = Group, ymin = Lower, 
                                               ymax = Upper, width = 0.05), 
                color = "mediumpurple4") + geom_line(data = calibration14_data, 
                                                     aes(x=Group, y=Est), 
                                                     color = "gray74") + 
  geom_errorbar(data = calibration14_data, aes(x = Group, ymin = Lower, 
                                               ymax = Upper), color = "gray74", 
                width = 0.05) + scale_x_continuous(name = "Predicted Risk of OCM", 
                                                   limits = c(0, 1), 
                                                   breaks = seq(0, 1, by=0.2)) + 
  scale_y_continuous(name = "Observed Risk of OCM", limits = c(0, 1), 
                     breaks = seq(0, 1.2, by=0.2)) + theme_bw() + 
  geom_abline(slope = 1, intercept = 0)  + 
  labs(caption = "Black line: perfect calibration. Blue line: calibration at 
       5 years. Purple line: calibration at 10 years. Gray line: calibration 
       at 14 years.")

#myplot

#save(list=c("plco_clean", "plco_nf"), file = "~/Box/PLCO Data/Prostate/plco_data_clean.RData")
```

## Variable Importance

We assess the variable importance of our Cox model:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
load("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nhanes_data_clean.RData")
f <-
  cph(
    Surv(permth_exm, mortstat) ~ age_ctr_40 + diabetic + educ + hypertension + 
      marital2 + underweight + overweight2 + obese2 + smoker + stroke + 
      age_ctr_40 * diabetic + age_ctr_40 * educ + age_ctr_40 * hypertension + 
      age_ctr_40 * stroke + pc,
    data = mydata[mydata$inmodel4 == 1, ],
    x = TRUE,
    y = TRUE
  )

plot(anova(f), what='proportion chisq')
```


## Comparison to SSA and NVSS Life Tables

We compare to the SSA and NVSS life tables:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
ssa <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/ssa_2000.csv")
ssa$age <- seq(0, 119, by = 1)

nvss_black <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_blackmales_2001.csv")
nvss_white <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_whitemales_2001.csv")
nvss_other <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_allmales_2001.csv")
nvss_other <- nvss_other[-102,]

nvss <- data.frame("Age" = seq(0, 100, by = 1), "White" = nvss_white$Expectancy, "Black" = nvss_black$Expectancy, "Other" = nvss_other$Expectancy)

plco_clean$ssa <- NA
plco_clean$nvss <- NA
for (i in 1:nrow(plco_clean)){
  plco_clean$ssa[i] <- ssa$Expectancy[which(ssa$age==plco_clean$age[i])]
  if (plco_clean$race2[i]=="NHW"){
    plco_clean$nvss[i] <- nvss$White[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="NHB"){
    plco_clean$nvss[i] <- nvss$Black[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="Other"){
    plco_clean$nvss[i] <- nvss$Other[which(nvss$Age==plco_clean$age[i])]
  }
}

ssa_roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$ssa,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

nvss_roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = 1/plco_clean$nvss,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

aucdat <-
  data.frame("Time" = rep(seq(6, 168, by = 6), 2), 
             "Model" = c(rep("SSA", 28), rep("NVSS", 28)),
             "AUC" = c(ssa_roc$AUC[-1], nvss_roc$AUC[-1]))

aucplot <-
  ggplot(data = aucdat, aes(x = Time, y = AUC, group = Model, color=Model)) + 
  geom_line() + xlab("Time (months)") + ylab("Time-dependent AUC in PLCO")

aucplot

auc_table <- data.frame("Model" = c("SSA", "NVSS"), 
                      "Year5" = round(c(ssa_roc$AUC[11], 
                                        nvss_roc$AUC[11]), digits=3), 
                      "Year10" = round(c(ssa_roc$AUC[21], 
                                         nvss_roc$AUC[21]), digits=3), 
                      "Year14" = round(c(ssa_roc$AUC[29], 
                                         nvss_roc$AUC[29]), digits=3))

kable(auc_table, caption="Time-Dependent AUC in PLCO")

km_predictions <- survfit(cox_40, plco_clean)
incs2 <- km_predictions$time[2:length(km_predictions$time)] - km_predictions$time[1:(length(km_predictions$time)-1)]
rmst2 <- (incs2 %*% (km_predictions$surv[-nrow(km_predictions$surv),]))/12

expectancy_dat <- data.frame("Cox_40" = rmst2[1,], "SSA" = plco_clean$ssa, "NVSS" = plco_clean$nvss, "Actual" = plco_clean$permth_exm/12, "Outcome" = plco_clean$mortstat)

expectancy_dat$SSA[expectancy_dat$SSA > 17] <- 17
expectancy_dat$NVSS[expectancy_dat$NVSS > 17] <- 17

comparison_plot <- ggplot(data=expectancy_dat, aes(x = SSA, y = Cox_40, color = factor(Outcome))) + geom_point() + scale_color_manual("Outcome", values = c("mediumpurple4", "gray74"), labels=c("Censored", "Died of OCM")) + coord_cartesian(xlim = c(3, 17), ylim = c(3, 17)) + xlab("Social Security Predicted Life Expectancy (up to 17 years)") + ylab("Cox Model Predicted Life Expectancy (up to 17 years)") + geom_abline(slope = 1, intercept = 0) + theme_bw()

comparison_plot

comparison_plot2 <- ggplot(data=expectancy_dat, aes(x = NVSS, y = Cox_40, color = factor(Outcome))) + geom_point() + scale_color_manual("Outcome", values = c("mediumpurple4", "gray74"), labels=c("Censored", "Died of OCM")) + coord_cartesian(xlim = c(3, 17), ylim = c(3, 17)) + xlab("NVSS Predicted Life Expectancy (up to 17 years)") + ylab("Cox Model Predicted Life Expectancy (up to 17 years)") + geom_abline(slope = 1, intercept = 0) + theme_bw()

comparison_plot2
```

## Performance Assessment in Presence of Competing Risks

Now we redo all of the above analyses, but accounting for the competing risks using the lengthened survival time:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
plco_clean2 <- plco_clean
plco_nf2 <- plco_nf

plco_clean2$permth_exm <- case_when(
  plco_clean$mortstat2==0 | plco_clean$mortstat2==1 ~ plco_clean$permth_exm,
  plco_clean$mortstat2==2 ~ 1000
)

plco_nf2$permth_exm <- case_when(
  plco_nf$mortstat2==0 | plco_nf$mortstat2==1 ~ plco_nf$permth_exm,
  plco_nf$mortstat2==2 ~ 1000
)

obs_surv <- Surv(plco_clean2$permth_exm, plco_clean2$mortstat)
rf_predictor <- predict(rforest_40, plco_nf2)
cox_40_predictor <- survfit(cox_40, plco_clean2)
cox_55_predictor <- survfit(cox_55, plco_clean2)

cox_40_5 <- rcorr.cens(cox_40_predictor$surv[cox_40_predictor$time==60,], obs_surv)
cox_40_10 <- rcorr.cens(cox_40_predictor$surv[cox_40_predictor$time==120,], obs_surv)
cox_40_14 <- rcorr.cens(cox_40_predictor$surv[cox_40_predictor$time==168,], obs_surv)

cox_55_5 <- rcorr.cens(cox_55_predictor$surv[cox_55_predictor$time==60,], obs_surv)
cox_55_10 <- rcorr.cens(cox_55_predictor$surv[cox_55_predictor$time==120,], obs_surv)
cox_55_14 <- rcorr.cens(cox_55_predictor$surv[cox_55_predictor$time==168,], obs_surv)

rforest_40_5 <- rcorr.cens(rf_predictor$survival[, rf_predictor$time.interest==60], obs_surv)
rforest_40_10 <- rcorr.cens(rf_predictor$survival[, rf_predictor$time.interest==120], obs_surv)
rforest_40_14 <- rcorr.cens(rf_predictor$survival[, rf_predictor$time.interest==168], obs_surv)

cox55_plco <- pec::cindex(object=cox_55, Surv(permth_exm, mortstat) ~ age_ctr_55 + 
                            race2 + educ + marital2 + emphysema + diabetic + 
                            stroke + smoker + underweight + overweight2 + obese2 + 
                            pc + age_ctr_55*diabetic + age_ctr_55*educ + 
                            age_ctr_55*marital2 + race2*educ, data = plco_clean2, 
                          eval.times = times)

cox40_plco <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                            age_ctr_40 + diabetic + educ + hypertension + marital2 + 
                            underweight + overweight2 + obese2 + smoker + stroke + 
                            age_ctr_40*diabetic + age_ctr_40*educ + 
                            age_ctr_40*hypertension + age_ctr_40*stroke + pc, 
                          data=plco_clean2, eval.times = times)

forest_plco <- pec::cindex(object=rforest_40, formula = Surv(permth_exm, mortstat) ~ 
                             age + arthritis + bronch + diabetic + educ + 
                             emphysema + hypertension + single + sep + mi_chd + 
                             underweight + overweight_ex + obese + liver + black + 
                             other + smoker + stroke + pc, data=plco_nf2, eval.times = times)

valid_perf <- data.frame("Time" = rep(seq(6, 168, by=6), 3), 
                         "Model" = c(rep("Cox 55", 28), rep("Cox 40", 28), 
                                     rep("Random Forest", 28)), 
                         "C" = c(cox55_plco$AppCindex$coxph, cox40_plco$AppCindex$coxph,
                                 forest_plco$AppCindex$rfsrc))

performance_plot <- ggplot(data=valid_perf, aes(x=Time, y=C)) + geom_point(size=0.1) + 
  geom_line(data=valid_perf, aes(group=Model, color=Model)) + xlab("Time (months)") + 
  ylab("IPCW C-index in PLCO, Competing Risks")

performance_plot
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
subperf <- data.frame("Model" = c("Cox 55", "Cox 40", "Random Forest"), 
                      "Year5" = round(c(cox55_plco$AppCindex$coxph[10], 
                                        cox40_plco$AppCindex$coxph[10], 
                                        forest_plco$AppCindex$rfsrc[10]), digits=3), 
                      "Year10" = round(c(cox55_plco$AppCindex$coxph[20], 
                                         cox40_plco$AppCindex$coxph[20], 
                                         forest_plco$AppCindex$rfsrc[20]), digits=3), 
                      "Year14" = round(c(cox55_plco$AppCindex$coxph[28], 
                                         cox40_plco$AppCindex$coxph[28], 
                                         forest_plco$AppCindex$rfsrc[28]), digits=3))

kable(subperf, caption = "IPCW C-index in PLCO, Competing Risks")

subperf2 <- data.frame("Model" = c("Cox 55", "Cox 40", "Random Forest"), 
                      "Year5" = round(c(cox_55_5[1], 
                                        cox_40_5[1],
                                        rforest_40_5[1]), digits=3), 
                      "Year10" = round(c(cox_55_10[1], 
                                         cox_40_10[1],
                                         rforest_40_10[1]), digits=3), 
                      "Year14" = round(c(cox_55_14[1], 
                                         cox_40_14[1],
                                         rforest_40_14[1]), digits=3))

kable(subperf2, caption = "No IPCW C-index in PLCO, Competing Risks")
```

Based on C-index, our strongest performing model is the Cox model fit to men ages 40+. Now we look at time-dependent AUC:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
cox40predict <-
  predict(object = cox_40,
          newdata = plco_clean2,
          type = "lp")
cox55predict <-
  predict(object = cox_55,
          newdata = plco_clean2,
          type = "lp")
rforestpredict <-
  predict(object=rforest_40,
          newdata = plco_nf2)

cox40roc <-
  timeROC(
    T = plco_clean2$permth_exm,
    delta = plco_clean2$mortstat,
    marker = cox40predict,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )
cox55roc <-
  timeROC(
    T = plco_clean2$permth_exm,
    delta = plco_clean2$mortstat,
    marker = cox55predict,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )
rforestroc <-
  timeROC(
    T = plco_nf2$permth_exm,
    delta = plco_nf2$mortstat,
    marker = rforestpredict$predicted,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

aucdat <-
  data.frame("Time" = rep(seq(6, 168, by = 6), 3), 
             "Model" = c(rep("Cox 55", 28), rep("Cox 40", 28), 
                                     rep("Random Forest", 28)),
             "AUC" = c(cox55roc$AUC[-1], cox40roc$AUC[-1],
                       rforestroc$AUC[-1]))

aucplot <-
  ggplot(data = aucdat, aes(x = Time, y = AUC, group = Model, color=Model)) + 
  geom_line() + xlab("Time (months)") + ylab("Time-dependent AUC in PLCO, Competing Risks")

aucplot
```

```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
auc_table <- data.frame("Model" = c("Cox 55", "Cox 40", "Random Forest"), 
                      "Year5" = round(c(cox55roc$AUC[11], 
                                        cox40roc$AUC[11], 
                                        rforestroc$AUC[11]), digits=3), 
                      "Year10" = round(c(cox55roc$AUC[21], 
                                         cox40roc$AUC[21], 
                                         rforestroc$AUC[21]), digits=3), 
                      "Year14" = round(c(cox55roc$AUC[29], 
                                         cox40roc$AUC[29], 
                                         rforestroc$AUC[29]), digits=3))

kable(auc_table, caption="Time-Dependent AUC in PLCO, Competing Risks")
```

Based on time-dependent AUC, the Cox model fit to men ages 40+ is still the strongest performing model. We will now focus our attention on the Cox ages 40+ model for the rest of our model validation/performance assessment.

We look at C-index and time-dependent AUC stratified by treatment group:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
cox40_prostatectomy <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                                     age_ctr_40 + diabetic + educ + hypertension + 
                                     marital2 + underweight + overweight2 + obese2 + 
                                     smoker + stroke + age_ctr_40*diabetic + 
                                     age_ctr_40*educ + age_ctr_40*hypertension + 
                                     age_ctr_40*stroke + pc,
                                   data=plco_clean2[plco_clean2$primary_tx=="Prostatectomy",], 
                                   eval.times = times)

cox40_radiation <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                                 age_ctr_40 + diabetic + educ + hypertension + 
                                 marital2 + underweight + overweight2 + obese2 + 
                                 smoker + stroke + age_ctr_40*diabetic + 
                                 age_ctr_40*educ + age_ctr_40*hypertension + 
                                 age_ctr_40*stroke + pc, 
                               data=plco_clean2[plco_clean2$primary_tx=="Radiation alone",], 
                               eval.times = times)

cox40_rtadt <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                             age_ctr_40 + diabetic + educ + hypertension + 
                             marital2 + underweight + overweight2 + obese2 + 
                             smoker + stroke + age_ctr_40*diabetic + 
                             age_ctr_40*educ + age_ctr_40*hypertension + 
                             age_ctr_40*stroke + pc, 
                           data=plco_clean2[plco_clean2$primary_tx=="Radiation + hormone",], 
                           eval.times = times)

valid_perf_trt <- data.frame("Time" = rep(seq(6, 168, by=6), 3), 
                             "Treatment" = c(rep("Prostatectomy", 28), 
                                             rep("Radiation alone", 28), 
                                             rep("Radiation + hormone", 28)), 
                             "C" = c(cox40_prostatectomy$AppCindex$coxph, 
                                     cox40_radiation$AppCindex$coxph, 
                                     cox40_rtadt$AppCindex$coxph))

performance_plot_trt <- ggplot(data=valid_perf_trt, aes(x=Time, y=C)) + 
  geom_point(size=0.1) + geom_line(data=valid_perf_trt, aes(group=Treatment, 
                                                            color=Treatment)) + 
  xlab("Time (months)") + ylab("IPCW C-index in PLCO, Competing Risks")

performance_plot_trt

subperf_trt <- data.frame("Treatment" = c("Prostatectomy", "Radiation alone", 
                                          "Radiation + hormone"), 
                          "Year5" = round(c(cox40_prostatectomy$AppCindex$coxph[10],
                                            cox40_radiation$AppCindex$coxph[10], 
                                            cox40_rtadt$AppCindex$coxph[10]), digits=3), 
                          "Year10" = round(c(cox40_prostatectomy$AppCindex$coxph[20],
                                             cox40_radiation$AppCindex$coxph[20],
                                             cox40_rtadt$AppCindex$coxph[20]), digits=3), 
                          "Year14" = round(c(cox40_prostatectomy$AppCindex$coxph[28],
                                             cox40_radiation$AppCindex$coxph[28],
                                             cox40_rtadt$AppCindex$coxph[28]), digits=3))

kable(subperf_trt, caption = "PLCO Time-Dependent C-index, by Treatment, Competing Risks")

cox40predict_prostatectomy <- predict(object=cox_40, newdata =
                                        plco_clean2[plco_clean2$primary_tx=="Prostatectomy",],
                                      type="lp")

cox40predict_radiation <- predict(object=cox_40, newdata = 
                                    plco_clean2[plco_clean2$primary_tx=="Radiation alone",], 
                                  type="lp")

cox40predict_rtadt <- predict(object=cox_40, newdata = 
                                plco_clean2[plco_clean2$primary_tx=="Radiation + hormone",], 
                              type="lp")

prostatectomy_roc <- timeROC(T = plco_clean2$permth_exm[plco_clean2$primary_tx=="Prostatectomy"], 
                             delta = plco_clean2$mortstat[plco_clean2$primary_tx=="Prostatectomy"], 
                             marker = cox40predict_prostatectomy, cause = 1, 
                             weighting="marginal", times = seq(0, 168, by=6))

radiation_roc <- timeROC(T = plco_clean2$permth_exm[plco_clean2$primary_tx=="Radiation alone"], 
                         delta = plco_clean2$mortstat[plco_clean2$primary_tx=="Radiation alone"], 
                         marker = cox40predict_radiation, cause = 1, 
                         weighting="marginal", times = seq(0, 168, by=6))

rtadt_roc <- timeROC(T = plco_clean2$permth_exm[plco_clean2$primary_tx=="Radiation + hormone"], 
                     delta = plco_clean2$mortstat[plco_clean2$primary_tx=="Radiation + hormone"], 
                     marker = cox40predict_rtadt, cause = 1, weighting="marginal", 
                     times = seq(0, 168, by=6))

aucdat_trt <- data.frame("Time" = rep(seq(6, 168, by=6), 3), 
                         "AUC" = c(prostatectomy_roc$AUC[-1], radiation_roc$AUC[-1], 
                                   rtadt_roc$AUC[-1]), 
                         "Treatment" = c(rep("Prostatectomy", 28), 
                                         rep("Radiation alone", 28), 
                                         rep("Radiation + hormone", 28)))

aucplot_trt <- ggplot(data=aucdat_trt, aes(x=Time, y=AUC, group=Treatment, 
                                           color=Treatment)) + geom_line() + 
  xlab("Time (months)") + ylab("Time-dependent AUC in PLCO, Competing Risks")

aucplot_trt

auc_table_trt <- data.frame("Years" = c(5, 10, 14), 
                            "Prostatectomy" = round(c(prostatectomy_roc$AUC[11], 
                                                      prostatectomy_roc$AUC[21], 
                                                      prostatectomy_roc$AUC[29]), 
                                                    digits = 3), 
                            "Radiation" = round(c(radiation_roc$AUC[11], 
                                                  radiation_roc$AUC[21], 
                                                  radiation_roc$AUC[29]), 
                                                digits = 3), 
                            "Radiation_hormone" = round(c(rtadt_roc$AUC[11], 
                                                          rtadt_roc$AUC[21], 
                                                          rtadt_roc$AUC[29]), 
                                                        digits = 3))

rownames(auc_table_trt) <- NULL
kable(auc_table_trt, caption="Time-Dependent AUC in PLCO, by Treatment, Competing Risks")
```

We compare to the SSA and NVSS life tables:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
ssa <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/ssa_2000.csv")
ssa$age <- seq(0, 119, by = 1)

nvss_black <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_blackmales_2001.csv")
nvss_white <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_whitemales_2001.csv")
nvss_other <- read_csv("/Users/ecchase/Desktop/Research/Matt Prostate OCM/PCOtherCause/Data/nvss_allmales_2001.csv")
nvss_other <- nvss_other[-102,]

nvss <- data.frame("Age" = seq(0, 100, by = 1), "White" = nvss_white$Expectancy, "Black" = nvss_black$Expectancy, "Other" = nvss_other$Expectancy)

plco_clean$ssa <- NA
plco_clean$nvss <- NA
for (i in 1:nrow(plco_clean)){
  plco_clean$ssa[i] <- ssa$Expectancy[which(ssa$age==plco_clean$age[i])]
  if (plco_clean$race2[i]=="NHW"){
    plco_clean$nvss[i] <- nvss$White[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="NHB"){
    plco_clean$nvss[i] <- nvss$Black[which(nvss$Age==plco_clean$age[i])]
  } else if (plco_clean$race2[i]=="Other"){
    plco_clean$nvss[i] <- nvss$Other[which(nvss$Age==plco_clean$age[i])]
  }
}

ssa_roc <-
  timeROC(
    T = plco_clean2$permth_exm,
    delta = plco_clean2$mortstat,
    marker = 1/plco_clean$ssa,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

nvss_roc <-
  timeROC(
    T = plco_clean2$permth_exm,
    delta = plco_clean2$mortstat,
    marker = 1/plco_clean$nvss,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

aucdat <-
  data.frame("Time" = rep(seq(6, 168, by = 6), 2), 
             "Model" = c(rep("SSA", 28), rep("NVSS", 28)),
             "AUC" = c(ssa_roc$AUC[-1], nvss_roc$AUC[-1]))

aucplot <-
  ggplot(data = aucdat, aes(x = Time, y = AUC, group = Model, color=Model)) + 
  geom_line() + xlab("Time (months)") + ylab("Time-dependent AUC in PLCO, Competing Risks")

aucplot

auc_table <- data.frame("Model" = c("SSA", "NVSS"), 
                      "Year5" = round(c(ssa_roc$AUC[11], 
                                        nvss_roc$AUC[11]), digits=3), 
                      "Year10" = round(c(ssa_roc$AUC[21], 
                                         nvss_roc$AUC[21]), digits=3), 
                      "Year14" = round(c(ssa_roc$AUC[29], 
                                         nvss_roc$AUC[29]), digits=3))

kable(auc_table, caption="Time-Dependent AUC in PLCO, Competing Risks")
```

## PCSM Prediction

We get the C-index for the linear predictor for PCSM:
```{r, fig.align="center", fig.height=4, fig.width=6, message=FALSE, warning=FALSE, echo=TRUE}
#Indicator for death from prostate cancer (other cause mortality censored)
plco_clean$mortstat <- case_when(
  plco_clean$mortstat2==2 ~ 1,
  plco_clean$mortstat2==1 | plco_clean$mortstat2==0 ~ 0
)
  
times <- seq(6, 168, by=6)

cox40_plco_pcsm <- pec::cindex(object=cox_40, formula = Surv(permth_exm, mortstat) ~ 
                            age_ctr_40 + diabetic + educ + hypertension + marital2 + 
                            underweight + overweight2 + obese2 + smoker + stroke + 
                            age_ctr_40*diabetic + age_ctr_40*educ + 
                            age_ctr_40*hypertension + age_ctr_40*stroke + pc, 
                          data=plco_clean, eval.times = times)

valid_perf <- data.frame("Time" = seq(6, 168, by=6),
                         "C" = cox40_plco_pcsm$AppCindex$coxph)

performance_plot <- ggplot(data=valid_perf, aes(x=Time, y=C)) + geom_point(size=0.1) + 
  geom_line(data=valid_perf) + xlab("Time (months)") + ylab("Time-dependent C-index in PLCO")

performance_plot

subperf <- data.frame("Model" = "Cox 40", 
                      "Year5" = round(cox40_plco_pcsm$AppCindex$coxph[10], digits=3), 
                      "Year10" = round(cox40_plco_pcsm$AppCindex$coxph[20], digits=3), 
                      "Year14" = round(cox40_plco_pcsm$AppCindex$coxph[28], digits=3))

kable(subperf, caption = "Time-dependent C-index for PCSM")

cox40predict <-
  predict(object = cox_40,
          newdata = plco_clean,
          type = "lp")

cox40roc <-
  timeROC(
    T = plco_clean$permth_exm,
    delta = plco_clean$mortstat,
    marker = cox40predict,
    cause = 1,
    weighting = "marginal",
    times = seq(0, 168, by = 6)
  )

aucdat <-
  data.frame("Time" = seq(6, 168, by = 6),
             "AUC" = cox40roc$AUC[-1])

aucplot <-
  ggplot(data = aucdat, aes(x = Time, y = AUC)) + geom_line() + 
  xlab("Time (months)") + ylab("Time-dependent AUC in PLCO")

aucplot

auc_table <- data.frame("Model" = "Cox 40", 
                      "Year5" = round(cox40roc$AUC[11], digits=3), 
                      "Year10" = round(cox40roc$AUC[21], digits=3), 
                      "Year14" = round(cox40roc$AUC[29], digits=3))

kable(auc_table, caption="Time-Dependent AUC for PCSM")
```
